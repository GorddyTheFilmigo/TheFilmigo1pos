<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G&H Solutions - My Supply Requests</title>
    <meta name="theme-color" content="#f59e0b">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="G&H Solutions">
    <meta name="description" content="Supplier Portal - View and process supply requests">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="assets/offline-styles.css">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/assets/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/assets/icons/icon-512x512.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/icons/icon-192x192.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;500;600;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/nav-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #1a2030;
            --border: #21262d;
            --text: #e6edf3;
            --text-muted: #8b949e;
            --accent-orange: #f59e0b;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --danger: #f85149;
        }
        body {
            font-family: 'Archivo', sans-serif;
            background: var(--bg-primary);
            color: var(--text);
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 24px;
        }
        .supplier-welcome {
            margin-bottom: 32px;
        }
        .supplier-welcome h1 {
            margin: 0 0 8px 0;
            font-size: 2.2rem;
        }
        .supplier-welcome p {
            color: var(--text-muted);
            font-size: 1.1rem;
        }
        .table-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            overflow-x: auto;
            margin-bottom: 40px;
        }
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th {
            background: var(--bg-tertiary);
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        tr:hover {
            background: rgba(88, 166, 255, 0.08);
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.82rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        .status-pending  { background: rgba(245,158,11,.2); color: var(--accent-orange); }
        .status-approved { background: rgba(63,185,80,.2);  color: var(--accent-green); }
        .status-rejected { background: rgba(248,81,73,.2);  color: var(--danger); }
        .status-high     { background: rgba(248,81,73,.2);  color: var(--danger); }
        .status-medium   { background: rgba(245,158,11,.2); color: var(--accent-orange); }
        .status-low      { background: rgba(63,185,80,.2);  color: var(--accent-green); }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
            margin-right: 4px;
        }
        .btn:hover { transform: translateY(-1px); }
        .btn-primary { background: var(--accent-green); color: white; }
        .btn-danger  { background: var(--danger); color: white; }
        .loading, .empty-row { text-align: center; padding: 48px 0; color: var(--text-muted); font-size: 1.1rem; }
        .error-message { text-align: center; padding: 48px 0; color: var(--danger); font-size: 1.1rem; }
        .flash-msg {
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .flash-success { background: rgba(63,185,80,.2);  color: var(--accent-green); }
        .flash-error   { background: rgba(248,81,73,.2);  color: var(--danger); }
        .form-select, .form-input {
            padding: 8px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
        }

        /* ‚îÄ‚îÄ Notification Bell ‚îÄ‚îÄ */
        .notif-bell {
            position: relative;
            cursor: pointer;
            font-size: 1.5rem;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
        }
        .notif-bell:hover { background: rgba(88,166,255,0.1); }
        .notif-badge {
            position: absolute;
            top: 4px; right: 4px;
            background: #f85149;
            color: white;
            border-radius: 50%;
            width: 20px; height: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.72rem; font-weight: 700;
            box-shadow: 0 0 0 2px #0d1117;
            min-width: 20px;
            animation: bellpulse 2s infinite;
        }
        @keyframes bellpulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }

        /* ‚îÄ‚îÄ Notification Popup ‚îÄ‚îÄ */
        .notif-popup {
            position: fixed;
            top: 70px; right: 20px;
            width: 420px;
            max-height: 78vh;
            background: #161b22;
            border: 1px solid #21262d;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.55);
            z-index: 9999;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .notif-popup.open { display: flex; }
        .notif-popup-header {
            padding: 14px 18px;
            border-bottom: 1px solid #21262d;
            background: #1a2030;
            display: flex; justify-content: space-between; align-items: center;
        }
        .notif-popup-header h3 { margin: 0; font-size: 1.1rem; }
        .notif-close { background: none; border: none; color: #8b949e; font-size: 1.8rem; cursor: pointer; line-height:1; padding: 0 4px; border-radius: 6px; }
        .notif-close:hover { color: #f85149; background: rgba(248,81,73,0.1); }
        .notif-list { flex: 1; overflow-y: auto; padding: 14px; }
        .notif-empty { text-align: center; padding: 48px 16px; color: #8b949e; }
        .notif-empty-icon { font-size: 3rem; margin-bottom: 10px; }

        /* individual message card */
        .notif-item {
            background: rgba(88,166,255,0.08);
            border: 1px solid rgba(88,166,255,0.2);
            border-radius: 8px;
            padding: 12px 14px;
            margin-bottom: 10px;
        }
        .notif-item.unread {
            background: rgba(245,158,11,0.1);
            border-color: rgba(245,158,11,0.35);
            border-left: 4px solid #f59e0b;
        }
        .notif-item.read { opacity: 0.72; }
        .notif-item-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem; color: #8b949e; }
        .notif-sender { font-weight: 700; color: #f59e0b; }
        .notif-time { font-size: 0.78rem; }
        .notif-text { color: #e6edf3; line-height: 1.45; word-break: break-word; font-size: 0.95rem; }
        .notif-mark-read {
            margin-top: 8px;
            background: #3fb950; color: white;
            border: none; border-radius: 6px;
            padding: 5px 12px; font-size: 0.8rem; font-weight: 600; cursor: pointer;
        }
        .notif-mark-read:hover { background: #2ea043; }
        .notif-expire { font-size: 0.78rem; color: #8b949e; margin-top: 4px; }
        .notif-reply-btn {
            margin-top: 8px; margin-left: 8px;
            background: #58a6ff; color: white;
            border: none; border-radius: 6px;
            padding: 5px 12px; font-size: 0.8rem; font-weight: 600; cursor: pointer;
        }
        .notif-reply-btn:hover { background: #3b8de0; }
        /* Reply box */
        .notif-reply-box {
            margin-top: 10px;
            display: flex; gap: 8px; align-items: flex-end;
        }
        .notif-reply-box textarea {
            flex: 1; padding: 8px 10px;
            background: #0d1117; border: 1px solid #21262d;
            border-radius: 8px; color: #e6edf3;
            font-family: 'Archivo', sans-serif; font-size: 0.88rem;
            resize: vertical; min-height: 60px;
        }
        .notif-reply-send {
            padding: 8px 14px; background: #3fb950; color: white;
            border: none; border-radius: 8px; font-weight: 700;
            cursor: pointer; font-size: 0.85rem; white-space: nowrap;
        }
        .notif-reply-send:hover { background: #2ea043; }

        /* Hide all nav tabs instantly except the active one ‚Äî prevents flash */
        .nav-tabs .nav-tab:not(.active) { display: none !important; }

        @media (max-width: 768px) {
            .table-header { flex-direction: column; align-items: stretch; }
        }

        /* ‚îÄ‚îÄ PWA Install Button ‚îÄ‚îÄ */
        .pwa-install-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(245,158,11,0.35);
            transition: all 0.2s;
            margin-left: 8px;
            white-space: nowrap;
        }
        .pwa-install-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(245,158,11,0.5);
        }
    </style>
</head>
<body>

<nav class="nav">
    <div class="nav-container">
        <div class="logo"><img src="assets/icons/icon-512x512.png" alt="Logo" class="logo">

<style>
.logo {
    width: 120px;
    height: auto;
}
</style></div>
        <div class="nav-tabs">
            <a href="dashboard.html"       class="nav-tab admin-only"    style="display:none;">Dashboard</a>
            <a href="pos.html"             class="nav-tab"               style="display:none;">Point of Sale</a>
            <a href="products.html"        class="nav-tab"               style="display:none;">Products</a>
            <a href="inventory.html"       class="nav-tab admin-only"    style="display:none;">Inventory</a>
            <a href="customers.html"       class="nav-tab"               style="display:none;">Customers</a>
            <a href="suppliers.html"       class="nav-tab active">My Requests</a>
            <a href="supply-requests.html" class="nav-tab"               style="display:none;">Supply Requests</a>
            <a href="admin.html"           class="nav-tab admin-only"    style="display:none;">üë• Users</a>
        </div>
        <div class="user-badge">
            <div class="user-avatar">üë§</div>
            <div>
                <div id="currentUserName">Supplier</div>
                <div id="currentDate" style="font-size:.8rem;color:var(--text-muted);"></div>
            </div>
        </div>
        <div class="notif-bell" id="supplierBell" onclick="toggleNotifPopup()">
                üîî
                <span class="notif-badge" id="supplierBadge" style="display:none;">0</span>
            </div>
                    <button class="pwa-install-btn" onclick="triggerPWAInstall()" title="Install app to your device">
                ‚¨áÔ∏è Install App
            </button>
                    <button
            onclick="authModule.logout()"
            style="padding:10px 18px;background-color:#ef4444;color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 4px 10px rgba(239,68,68,.3);transition:all .2s ease;margin-left:12px;"
            onmouseover="this.style.backgroundColor='#dc2626';this.style.transform='translateY(-1px)'"
            onmouseout="this.style.backgroundColor='#ef4444';this.style.transform='translateY(0)'"
        >Logout</button>
    </div>
</nav>

<!-- ‚îÄ‚îÄ Supplier Notification Popup ‚îÄ‚îÄ -->
<div class="notif-popup" id="notifPopup">
    <div class="notif-popup-header">
        <h3>üîî Messages from Admin</h3>
        <button class="notif-close" onclick="toggleNotifPopup()">√ó</button>
    </div>
    <div class="notif-list" id="notifList">
        <div class="notif-empty"><div class="notif-empty-icon">üì≠</div><p>Loading‚Ä¶</p></div>
    </div>
</div>

<div class="container">

    <div class="supplier-welcome">
        <h1 id="supplierGreeting">Welcome</h1>
        <p>View and respond to supply requests sent to you by shops.</p>
    </div>

    <div id="flashMessage"></div>

    <!-- Incoming Supply Requests -->
    <div class="table-container">
        <div class="table-header">
            <h2 style="margin:0;">Incoming Supply Requests</h2>
            <div style="display:flex; gap:12px; align-items:center;">
                <select id="statusFilter" class="form-select" style="width:150px;">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                </select>
                <input type="text" id="requestSearch" class="form-input" placeholder="Search item or notes..." style="width:240px;">
            </div>
        </div>
        <table class="table">
            <thead>
                <tr>
                    <th>Request #</th>
                    <th>Item Name</th>
                    <th>Priority</th>
                    <th>Qty / Unit</th>
                    <th>Requested By</th>
                    <th>Est. Cost</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="requestsTableBody">
                <tr><td colspan="8" class="loading">Loading your supply requests‚Ä¶</td></tr>
            </tbody>
        </table>
    </div>

    <!-- Processed Orders History -->
    <div class="table-container">
        <h2 style="margin:0 0 20px 0;">Processed Orders (History)</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Order #</th>
                    <th>Date</th>
                    <th>Delivery Date</th>
                    <th>Amount (KES)</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="ordersTableBody">
                <tr><td colspan="5" class="loading">Loading order history‚Ä¶</td></tr>
            </tbody>
        </table>
    </div>

</div>

<script src="assets/script.js"></script>
<script src="assets/auth.js"></script>
<script src="assets/data-module.js"></script>
<script>
(function () {
    let supplyRequests = [];
    let orders = [];
    let currentUser = null;
    let db = null;
    // The Supabase auth UUID (different from the integer profile row id)
    let supplierUUID = null;

    window.addEventListener('DOMContentLoaded', async () => {
        try {
            console.log('Supplier portal starting...');

            if (!window.DukaPOS?.supabaseClient) {
                window.DukaPOS = window.DukaPOS || {};
                window.DukaPOS.supabaseClient = window.supabase.createClient(
                    'https://zylhlftiqvrcogxaqgof.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5bGhsZnRpcXZyY29neGFxZ29mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NjQyMzAsImV4cCI6MjA4NTM0MDIzMH0.AVcH8iGuK8--BRR133KvXgMecoNl-_bv2rFYgBuuk9s'
                );
            }

            db = window.DukaPOS.supabaseClient;
            if (!db) throw new Error('Failed to get Supabase client');

            const isAuthenticated = await authModule.requireAuth();
            if (!isAuthenticated) return;

            currentUser = authModule.getCurrentUser();
            if (!currentUser?.id) throw new Error('No authenticated user found');

            // currentUser.id is the integer profile id stored in supplier_id column
            supplierUUID = currentUser.id;
            console.log('Supplier ID:', supplierUUID);

            const supplierName = currentUser.full_name || currentUser.email?.split('@')[0] || 'Supplier';
            document.getElementById('currentUserName').textContent = supplierName;
            document.getElementById('supplierGreeting').textContent = `Welcome, ${supplierName}`;
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-KE', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            await Promise.all([loadSupplyRequests(), loadProcessedOrders()]);

            document.getElementById('statusFilter')?.addEventListener('change', e => {
                renderSupplyRequests(document.getElementById('requestSearch').value, e.target.value);
            });
            document.getElementById('requestSearch')?.addEventListener('input', e => {
                renderSupplyRequests(e.target.value, document.getElementById('statusFilter').value);
            });

            console.log('Supplier portal loaded');
        } catch (err) {
            console.error('Init failed:', err);
            const msg = `Failed to start: ${err.message}`;
            document.getElementById('requestsTableBody').innerHTML = `<tr><td colspan="8" class="error-message">${msg}</td></tr>`;
            document.getElementById('ordersTableBody').innerHTML   = `<tr><td colspan="5" class="error-message">${msg}</td></tr>`;
        }
    });

    async function loadSupplyRequests() {
        try {
            console.log('Fetching requests for supplier UUID:', supplierUUID);
            const { data, error } = await db
                .from('supply_requests')
                .select(`
                    id,
                    item_name,
                    quantity,
                    unit,
                    priority,
                    status,
                    estimated_cost,
                    requested_by,
                    requested_by_user:requested_by ( full_name ),
                    created_at,
                    approved_at,
                    notes
                `)
                .eq('supplier_id', supplierUUID)
                .order('created_at', { ascending: false });

            if (error) throw error;

            supplyRequests = data || [];
            console.log(`Loaded ${supplyRequests.length} requests`);
            renderSupplyRequests();
        } catch (err) {
            console.error('Load requests failed:', err);
            document.getElementById('requestsTableBody').innerHTML =
                `<tr><td colspan="8" class="error-message">${err.message}</td></tr>`;
        }
    }

    function renderSupplyRequests(filter = '', statusFilter = '') {
        const tbody = document.getElementById('requestsTableBody');
        let filtered = [...supplyRequests];

        if (statusFilter) filtered = filtered.filter(r => r.status === statusFilter);
        if (filter.trim()) {
            const term = filter.toLowerCase().trim();
            filtered = filtered.filter(r =>
                (r.item_name || '').toLowerCase().includes(term) ||
                (r.notes || '').toLowerCase().includes(term)
            );
        }

        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="empty-row">No matching supply requests found</td></tr>';
            return;
        }

        // IMPORTANT: wrap r.id in quotes so UUIDs are passed as strings, not bare JS tokens
        tbody.innerHTML = filtered.map(r => `
            <tr>
                <td>${r.id}</td>
                <td>${r.item_name || '‚Äî'}</td>
                <td><span class="status-badge status-${r.priority || 'medium'}">${r.priority || 'medium'}</span></td>
                <td>${r.quantity || '‚Äî'} ${r.unit || ''}</td>
                <td>${r.requested_by_user?.full_name || '‚Äî'}</td>
                <td>${r.estimated_cost ? 'KES ' + Number(r.estimated_cost).toLocaleString() : '‚Äî'}</td>
                <td><span class="status-badge status-${r.status}">${r.status || 'pending'}</span></td>
                <td>
                    ${r.status === 'pending' ? `
                        <button class="btn btn-primary" onclick="supplierPortal.acceptRequest('${r.id}')">‚úÖ Accept</button>
                        <button class="btn btn-danger"  onclick="supplierPortal.rejectRequest('${r.id}')">‚ùå Reject</button>
                    ` : `<span style="color:var(--text-muted);font-size:13px;">${r.status === 'approved' ? '‚úÖ Accepted' : '‚ùå Rejected'}</span>`}
                </td>
            </tr>
        `).join('');
    }

    async function loadProcessedOrders() {
        try {
            const { data, error } = await db
                .from('supplier_purchase_orders')
                .select('id, order_number, order_date, expected_delivery_date, total_amount, status')
                .eq('supplier_id', supplierUUID)
                .order('order_date', { ascending: false })
                .limit(20);

            if (error) throw error;

            orders = data || [];
            renderOrders();
        } catch (err) {
            console.warn('Order history failed:', err.message);
            document.getElementById('ordersTableBody').innerHTML =
                '<tr><td colspan="5" class="empty-row">Order history not available</td></tr>';
        }
    }

    function renderOrders() {
        const tbody = document.getElementById('ordersTableBody');
        if (orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="empty-row">No processed orders yet</td></tr>';
            return;
        }
        tbody.innerHTML = orders.map(o => `
            <tr>
                <td>${o.order_number || o.id}</td>
                <td>${fmtDate(o.order_date)}</td>
                <td>${fmtDate(o.expected_delivery_date)}</td>
                <td><strong>KES ${Number(o.total_amount || 0).toLocaleString()}</strong></td>
                <td><span class="status-badge status-${o.status}">${o.status}</span></td>
            </tr>
        `).join('');
    }

    async function acceptRequest(id) {
        if (!confirm('Accept this supply request?')) return;
        try {
            const { error } = await db
                .from('supply_requests')
                .update({
                    status: 'approved',
                    approved_at: new Date().toISOString(),
                    approved_by: supplierUUID
                })
                .eq('id', id);

            if (error) throw error;
            await loadSupplyRequests();
            showFlash('Request accepted successfully!', 'success');
        } catch (err) {
            console.error('Accept failed:', err);
            showFlash('Accept failed: ' + err.message, 'error');
        }
    }

    async function rejectRequest(id) {
        const reason = prompt('Reason for rejection (optional):');
        try {
            const { error } = await db
                .from('supply_requests')
                .update({
                    status: 'rejected',
                    approved_at: null,
                    supplier_response: reason?.trim() || null
                })
                .eq('id', id);

            if (error) throw error;
            await loadSupplyRequests();
            showFlash('Request rejected.', 'success');
        } catch (err) {
            console.error('Reject failed:', err);
            showFlash('Reject failed: ' + err.message, 'error');
        }
    }

    function fmtDate(d) {
        if (!d) return '‚Äî';
        return new Date(d).toLocaleDateString('en-KE', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    function showFlash(text, type = 'success') {
        const el = document.getElementById('flashMessage');
        el.innerHTML = `<div class="flash-msg flash-${type}">${text}</div>`;
        setTimeout(() => el.innerHTML = '', 6000);
    }

    window.supplierPortal = { acceptRequest, rejectRequest };

})();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SUPPLIER NOTIFICATION BELL
    // Queries messages where recipient_id = currentUser.id
    // Uses the same messaging_module / messages table as staff
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    (function() {
        let _notifOpen = false;

        window.toggleNotifPopup = function() {
            const popup = document.getElementById('notifPopup');
            _notifOpen = !_notifOpen;
            popup.classList.toggle('open', _notifOpen);
            if (_notifOpen) loadNotifMessages();
        };

        // Close on outside click
        document.addEventListener('click', function(e) {
            const popup = document.getElementById('notifPopup');
            const bell  = document.getElementById('supplierBell');
            if (_notifOpen && !popup.contains(e.target) && !bell.contains(e.target)) {
                _notifOpen = false;
                popup.classList.remove('open');
            }
        });

        async function fetchMessages() {
            const db = window.DukaPOS?.supabaseClient;
            if (!db) { console.error('No DB client'); return []; }

            // Always read from authModule ‚Äî never rely on outer scope currentUser
            const user = authModule.getCurrentUser();
            if (!user?.id) { console.error('No currentUser from authModule'); return []; }

            console.log('Fetching messages for user id:', user.id, typeof user.id);

            const { data, error } = await db
                .from('messages')
                .select('id, message_text, is_read, created_at, expires_at, sender_id')
                .eq('recipient_id', user.id)
                .order('created_at', { ascending: false })
                .limit(30);

            if (error) {
                console.error('messages table error:', JSON.stringify(error));
                // Fallback table name
                const { data: data2, error: error2 } = await db
                    .from('staff_messages')
                    .select('id, message_text, is_read, created_at, expires_at, sender_id')
                    .eq('recipient_id', user.id)
                    .order('created_at', { ascending: false })
                    .limit(30);
                if (error2) {
                    console.error('staff_messages also failed:', JSON.stringify(error2));
                    return [];
                }
                console.log('staff_messages data:', data2);
                return data2 || [];
            }

            console.log('messages data:', data);
            return data || [];
        }

        async function updateBadge() {
            const msgs = await fetchMessages();
            const unread = msgs.filter(m => !m.is_read).length;
            const badge = document.getElementById('supplierBadge');
            badge.textContent = unread > 99 ? '99+' : unread;
            badge.style.display = unread > 0 ? 'flex' : 'none';
            return msgs;
        }

        async function loadNotifMessages() {
            const list = document.getElementById('notifList');
            list.innerHTML = '<div class="notif-empty"><div class="notif-empty-icon">üì≠</div><p>Loading‚Ä¶</p></div>';
            let msgs = [];
            try {
                msgs = await fetchMessages();
                // Update badge separately
                const unread = msgs.filter(m => !m.is_read).length;
                const badge = document.getElementById('supplierBadge');
                badge.textContent = unread > 99 ? '99+' : unread;
                badge.style.display = unread > 0 ? 'flex' : 'none';
            } catch(err) {
                console.error('loadNotifMessages error:', err);
                list.innerHTML = '<div class="notif-empty"><div class="notif-empty-icon">‚ö†Ô∏è</div><p>Error: ' + err.message + '</p></div>';
                return;
            }
            if (!msgs.length) {
                list.innerHTML = '<div class="notif-empty"><div class="notif-empty-icon">üì≠</div><p>No messages from admin yet</p></div>';
                return;
            }
            list.innerHTML = msgs.map(m => {
                const hoursLeft = m.expires_at
                    ? Math.max(0, Math.round((new Date(m.expires_at) - new Date()) / 3600000))
                    : null;
                const senderName = m.sender?.full_name || m.sender_name || 'Admin';
                return `
                <div class="notif-item ${m.is_read ? 'read' : 'unread'}" id="notif-${m.id}">
                    <div class="notif-item-header">
                        <span class="notif-sender">üë§ ${senderName}</span>
                        <span class="notif-time">${new Date(m.created_at).toLocaleString()}</span>
                    </div>
                    <div class="notif-text">${m.message_text || '(empty)'}</div>
                    ${hoursLeft !== null ? `<div class="notif-expire">‚è± Expires in ${hoursLeft}h</div>` : ''}
                    <div style="display:flex;align-items:center;flex-wrap:wrap;gap:4px;">
                        ${!m.is_read ? `<button class="notif-mark-read" onclick="markNotifRead(${m.id}, this)">‚úÖ Mark as Read</button>` : '<span style="margin-top:6px;font-size:0.78rem;color:#8b949e;">‚úî Read</span>'}
                        <button class="notif-reply-btn" onclick="toggleReplyBox(${m.id}, ${m.sender_id})">üí¨ Reply</button>
                    </div>
                    <div class="notif-reply-box" id="replyBox-${m.id}" style="display:none;">
                        <textarea id="replyText-${m.id}" placeholder="Type your reply to admin‚Ä¶"></textarea>
                        <button class="notif-reply-send" onclick="sendReply(${m.id}, ${m.sender_id})">Send</button>
                    </div>
                </div>`;
            }).join('');
        }

        window.markNotifRead = async function(id, btn) {
            const db = window.DukaPOS?.supabaseClient;
            if (!db) return;
            try {
                const { error } = await db
                    .from('messages')
                    .update({ is_read: true })
                    .eq('id', id);
                if (!error) {
                    const card = document.getElementById('notif-' + id);
                    if (card) { card.classList.remove('unread'); card.classList.add('read'); }
                    btn.replaceWith(Object.assign(document.createElement('div'), {
                        style: 'margin-top:6px;font-size:0.78rem;color:#8b949e;',
                        textContent: '‚úî Read'
                    }));
                    updateBadge();
                }
            } catch(err) { console.error('Mark read error:', err); }
        };

        window.toggleReplyBox = function(msgId, senderId) {
            const box = document.getElementById('replyBox-' + msgId);
            if (!box) return;
            const isOpen = box.style.display !== 'none';
            box.style.display = isOpen ? 'none' : 'flex';
            if (!isOpen) document.getElementById('replyText-' + msgId)?.focus();
        };

        window.sendReply = async function(originalMsgId, recipientId) {
            const db = window.DukaPOS?.supabaseClient;
            const user = authModule.getCurrentUser();
            if (!db || !user) return;

            const textarea = document.getElementById('replyText-' + originalMsgId);
            const text = textarea?.value?.trim();
            if (!text) { alert('Please type a reply first.'); return; }

            const btn = textarea.nextElementSibling;
            btn.disabled = true; btn.textContent = 'Sending‚Ä¶';

            try {
                // Insert a new message back to the admin (sender of original)
                const expiresAt = new Date();
                expiresAt.setHours(expiresAt.getHours() + 72);

                const { error } = await db
                    .from('messages')
                    .insert([{
                        sender_id: user.id,
                        recipient_id: recipientId,
                        message_text: text,
                        is_read: false,
                        expires_at: expiresAt.toISOString(),
                        shop_id: user.shop_id
                    }]);

                if (error) throw error;

                // Close reply box and show confirmation
                const box = document.getElementById('replyBox-' + originalMsgId);
                if (box) box.style.display = 'none';
                textarea.value = '';

                // Flash a success note on the card
                const card = document.getElementById('notif-' + originalMsgId);
                if (card) {
                    const note = document.createElement('div');
                    note.textContent = '‚úÖ Reply sent to admin';
                    note.style.cssText = 'margin-top:6px;font-size:0.8rem;color:#3fb950;font-weight:600;';
                    card.appendChild(note);
                    setTimeout(() => note.remove(), 4000);
                }
            } catch (err) {
                console.error('Reply send error:', err);
                alert('Failed to send reply: ' + err.message);
            } finally {
                btn.disabled = false; btn.textContent = 'Send';
            }
        };

        // Poll for new messages every 30 seconds
        // Start polling after currentUser is set (DOMContentLoaded fires first)
        function startPolling() {
            // Use authModule instead of outer-scope currentUser
            if (!authModule.getCurrentUser()?.id) { setTimeout(startPolling, 500); return; }
            updateBadge();
            setInterval(updateBadge, 30000);
        }
        // Hook into DOMContentLoaded ‚Äî currentUser is set inside the IIFE above
        // so we wait for it to be non-null
        window.addEventListener('DOMContentLoaded', () => setTimeout(startPolling, 1500));
    })();

</script>
<script src="assets/pwa-registration.js"></script>
<footer style="text-align: center; padding: 15px; background-color: black;">
  <p>&copy; <span id="year"></span><b style="color:gold;"> G&amp;H </b>Solutions by <b style="color: gold; font-family: 'Great Vibes', cursive;"> Gordon Onyango.</b> All rights reserved.</p>
</footer>

<script>
  document.getElementById("year").textContent = new Date().getFullYear();
</script>
</body>
</html>