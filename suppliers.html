<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G&H Solutions - My Supply Requests</title>
    <meta name="theme-color" content="#f59e0b">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="G&H Solutions">
    <meta name="description" content="Supplier Portal - View and process supply requests">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="assets/offline-styles.css">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/assets/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/assets/icons/icon-512x512.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/icons/icon-192x192.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;500;600;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/nav-styles.css">
    <script src="assets/page-access-guard.js"></script>
    <script src="assets/nav-visibility-controller.js"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #1a2030;
            --border: #21262d;
            --text: #e6edf3;
            --text-muted: #8b949e;
            --accent-orange: #f59e0b;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --danger: #f85149;
        }
        body {
            font-family: 'Archivo', sans-serif;
            background: var(--bg-primary);
            color: var(--text);
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 24px;
        }
        .supplier-welcome {
            margin-bottom: 32px;
        }
        .supplier-welcome h1 {
            margin: 0 0 8px 0;
            font-size: 2.2rem;
        }
        .supplier-welcome p {
            color: var(--text-muted);
            font-size: 1.1rem;
        }
        .table-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            overflow-x: auto;
            margin-bottom: 40px;
        }
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th {
            background: var(--bg-tertiary);
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        tr:hover {
            background: rgba(88, 166, 255, 0.08);
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.82rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        .status-pending   { background: rgba(245,158,11,.2); color: var(--accent-orange); }
        .status-approved  { background: rgba(63,185,80,.2);  color: var(--accent-green); }
        .status-rejected  { background: rgba(248,81,73,.2);  color: var(--danger); }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }
        .btn:hover { transform: translateY(-1px); }
        .btn-primary   { background: var(--accent-orange); color: white; }
        .btn-danger    { background: var(--danger); color: white; }
        .loading, .empty-row { text-align: center; padding: 48px 0; color: var(--text-muted); font-size: 1.1rem; }
        .error-message { text-align: center; padding: 48px 0; color: var(--danger); font-size: 1.1rem; }
        .success-msg { color: var(--accent-green); font-weight: 600; margin: 12px 0; }
        .error-msg   { color: var(--danger); font-weight: 600; margin: 12px 0; }
        @media (max-width: 768px) {
            .table-header { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

<nav class="nav">
    <div class="nav-container">
        <div class="logo">G&H Solutions</div>
        <div class="nav-tabs">
            <a href="dashboard.html" class="nav-tab admin-only" style="display:none;">Dashboard</a>
            <a href="pos.html" class="nav-tab" style="display:none;">Point of Sale</a>
            <a href="products.html" class="nav-tab" style="display:none;">Products</a>
            <a href="inventory.html" class="nav-tab admin-only" style="display:none;">Inventory</a>
            <a href="customers.html" class="nav-tab" style="display:none;">Customers</a>
            <a href="suppliers.html" class="nav-tab active">My Requests</a>
            <a href="supply-requests.html" class="nav-tab" style="display:none;">Supply Requests</a>
            <a href="admin.html" class="nav-tab admin-only" style="display:none;">ðŸ‘¥ Users</a>
        </div>
        <div class="user-badge">
            <div class="user-avatar">ðŸ‘¤</div>
            <div>
                <div id="currentUserName">Supplier</div>
                <div id="currentDate" style="font-size:.8rem;color:var(--text-muted);"></div>
            </div>
        </div>
        <button
            onclick="authModule.logout()"
            style="padding:10px 18px;background-color:#ef4444;color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 4px 10px rgba(239,68,68,.3);transition:all .2s ease;margin-left:12px;"
            onmouseover="this.style.backgroundColor='#dc2626';this.style.transform='translateY(-1px)'"
            onmouseout="this.style.backgroundColor='#ef4444';this.style.transform='translateY(0)'"
        >Logout</button>
    </div>
</nav>

<div class="container">

    <div class="supplier-welcome">
        <h1 id="supplierGreeting">Welcome</h1>
        <p>View and respond to supply requests sent to you by shops.</p>
    </div>

    <!-- Incoming Supply Requests -->
    <div class="table-container">
        <div class="table-header">
            <h2 style="margin:0;">Incoming Supply Requests</h2>
            <div style="display:flex; gap:12px; align-items:center;">
                <select id="statusFilter" class="form-select" style="width:150px;padding:8px;">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                </select>
                <input type="text" id="requestSearch" class="form-input" placeholder="Search item or notes..." style="width:240px;">
            </div>
        </div>
        <table class="table">
            <thead>
                <tr>
                    <th>Request #</th>
                    <th>Item Name</th>
                    <th>Priority</th>
                    <th>Qty / Unit</th>
                    <th>Requested By</th>
                    <th>Est. Cost</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="requestsTableBody">
                <tr><td colspan="8" class="loading">Loading your supply requestsâ€¦</td></tr>
            </tbody>
        </table>
    </div>

    <!-- Processed Orders History -->
    <div class="table-container" style="margin-top: 40px;">
        <h2 style="margin:0 0 20px 0;">Processed Orders (History)</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Order #</th>
                    <th>Date</th>
                    <th>Delivery Date</th>
                    <th>Amount (KES)</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="ordersTableBody">
                <tr><td colspan="5" class="loading">Loading order historyâ€¦</td></tr>
            </tbody>
        </table>
    </div>

</div>

<script src="assets/script.js"></script>
<script src="assets/auth.js"></script>
<script src="assets/data-module.js"></script>
<script>
(function () {
    let supplyRequests = [];
    let orders = [];
    let currentUser = null;
    let supabaseClient = null;

    window.addEventListener('DOMContentLoaded', async () => {
        try {
            console.log('Supplier portal starting...');

            // Safe Supabase client creation
            if (!window.DukaPOS?.supabaseClient) {
                console.log('Creating standalone Supabase client...');
                window.DukaPOS.supabaseClient = window.supabase.createClient(
                    'https://zylhlftiqvrcogxaqgof.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5bGhsZnRpcXZyY29neGFxZ29mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NjQyMzAsImV4cCI6MjA4NTM0MDIzMH0.AVcH8iGuK8--BRR133KvXgMecoNl-_bv2rFYgBuuk9s'
                );
            }

            supabaseClient = window.DukaPOS.supabaseClient;

            if (!supabaseClient) {
                throw new Error('Failed to get Supabase client');
            }

            console.log('Supabase client ready');

            const isAuthenticated = await authModule.requireAuth();
            if (!isAuthenticated) return;

            currentUser = authModule.getCurrentUser();
            if (!currentUser?.id) {
                throw new Error('No authenticated user found');
            }

            console.log('Logged in as:', currentUser.full_name || currentUser.email);

            // Set UI
            const supplierName = currentUser.full_name || currentUser.email?.split('@')[0] || 'Supplier';
            document.getElementById('currentUserName').textContent = supplierName;
            document.getElementById('supplierGreeting').textContent = `Welcome, ${supplierName}`;

            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-KE', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            // Restrict nav
            document.querySelectorAll('.nav-tab').forEach(tab => tab.style.display = 'none');
            const myTab = document.querySelector('a[href="suppliers.html"]');
            if (myTab) myTab.style.display = 'flex';

            await Promise.all([
                loadSupplyRequests(),
                loadProcessedOrders()
            ]);

            document.getElementById('statusFilter')?.addEventListener('change', e => {
                renderSupplyRequests(document.getElementById('requestSearch').value, e.target.value);
            });
            document.getElementById('requestSearch')?.addEventListener('input', e => {
                renderSupplyRequests(e.target.value, document.getElementById('statusFilter').value);
            });

            console.log('Supplier portal loaded');
        } catch (err) {
            console.error('Init failed:', err);
            const msg = `Failed to start: ${err.message}`;
            document.getElementById('requestsTableBody').innerHTML = `<tr><td colspan="8" class="error-message">${msg}</td></tr>`;
            document.getElementById('ordersTableBody').innerHTML = `<tr><td colspan="5" class="error-message">${msg}</td></tr>`;
        }
    });

    async function loadSupplyRequests() {
        if (!supabaseClient) {
            document.getElementById('requestsTableBody').innerHTML = 
                '<tr><td colspan="8" class="error-message">No database connection</td></tr>';
            return;
        }

        try {
            console.log('Fetching requests for supplier ID:', currentUser.id);
            const { data, error } = await supabaseClient
                .from('supply_requests')
                .select(`
                    id,
                    item_name,
                    quantity,
                    unit,
                    priority,
                    status,
                    estimated_cost,
                    requested_by,
                    requested_by_user:requested_by ( full_name ),
                    created_at,
                    approved_at,
                    notes
                `)
                .eq('supplier_id', currentUser.id)
                .order('created_at', { ascending: false });

            if (error) throw error;

            supplyRequests = data || [];
            console.log(`Loaded ${supplyRequests.length} requests`);
            renderSupplyRequests();
        } catch (err) {
            console.error('Load requests failed:', err);
            document.getElementById('requestsTableBody').innerHTML = 
                `<tr><td colspan="8" class="error-message">${err.message}</td></tr>`;
        }
    }

    function renderSupplyRequests(filter = '', statusFilter = '') {
        const tbody = document.getElementById('requestsTableBody');
        let filtered = [...supplyRequests];

        if (statusFilter) filtered = filtered.filter(r => r.status === statusFilter);
        if (filter.trim()) {
            const term = filter.toLowerCase().trim();
            filtered = filtered.filter(r =>
                (r.item_name || '').toLowerCase().includes(term) ||
                (r.notes || '').toLowerCase().includes(term)
            );
        }

        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="empty-row">No matching supply requests found</td></tr>';
            return;
        }

        tbody.innerHTML = filtered.map(r => `
            <tr>
                <td>${r.id}</td>
                <td>${r.item_name || 'â€”'}</td>
                <td><span class="status-badge status-${r.priority || 'medium'}">${r.priority || 'medium'}</span></td>
                <td>${r.quantity || 'â€”'} ${r.unit || ''}</td>
                <td>${r.requested_by_user?.full_name || 'â€”'}</td>
                <td>${r.estimated_cost ? 'KES ' + Number(r.estimated_cost).toLocaleString() : 'â€”'}</td>
                <td><span class="status-badge status-${r.status}">${r.status || 'pending'}</span></td>
                <td>
                    ${r.status === 'pending' ? `
                        <button class="btn btn-primary" onclick="supplierPortal.acceptRequest(${r.id})">Accept</button>
                        <button class="btn btn-danger"   onclick="supplierPortal.rejectRequest(${r.id})">Reject</button>
                    ` : (r.approved_at ? 'Approved' : 'Processed')}
                </td>
            </tr>
        `).join('');
    }

    async function loadProcessedOrders() {
        if (!supabaseClient) return;

        try {
            const { data, error } = await supabaseClient
                .from('supplier_purchase_orders')
                .select('id, order_number, order_date, expected_delivery_date, total_amount, status')
                .eq('supplier_id', currentUser.id)
                .order('order_date', { ascending: false })
                .limit(20);

            if (error) throw error;

            orders = data || [];
            renderOrders();
        } catch (err) {
            console.warn('Order history failed:', err.message);
            document.getElementById('ordersTableBody').innerHTML =
                '<tr><td colspan="5" class="empty-row">Order history not available</td></tr>';
        }
    }

    function renderOrders() {
        const tbody = document.getElementById('ordersTableBody');
        if (orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="empty-row">No processed orders yet</td></tr>';
            return;
        }
        tbody.innerHTML = orders.map(o => `
            <tr>
                <td>${o.order_number || o.id}</td>
                <td>${fmtDate(o.order_date)}</td>
                <td>${fmtDate(o.expected_delivery_date)}</td>
                <td><strong>KES ${Number(o.total_amount || 0).toLocaleString()}</strong></td>
                <td><span class="status-badge status-${o.status}">${o.status}</span></td>
            </tr>
        `).join('');
    }

    async function acceptRequest(id) {
        if (!confirm('Accept this supply request?')) return;
        try {
            const { error } = await supabaseClient
                .from('supply_requests')
                .update({
                    status: 'approved',
                    approved_at: new Date().toISOString()
                })
                .eq('id', id)
                .eq('supplier_id', currentUser.id);

            if (error) throw error;
            await loadSupplyRequests();
            showMessage('Request accepted', 'success');
        } catch (err) {
            showMessage('Accept failed: ' + err.message, 'error');
        }
    }

    async function rejectRequest(id) {
        const reason = prompt('Reason for rejection (optional):')?.trim();
        try {
            const { error } = await supabaseClient
                .from('supply_requests')
                .update({
                    status: 'rejected',
                    approved_at: null
                })
                .eq('id', id)
                .eq('supplier_id', currentUser.id);

            if (error) throw error;
            await loadSupplyRequests();
            showMessage('Request rejected', 'success');
        } catch (err) {
            showMessage('Reject failed: ' + err.message, 'error');
        }
    }

    function fmtDate(d) {
        if (!d) return 'â€”';
        return new Date(d).toLocaleDateString('en-KE', { day:'numeric', month:'short', year:'numeric' });
    }

    function showMessage(text, type = 'success') {
        const msg = document.createElement('div');
        msg.className = type === 'success' ? 'success-msg' : 'error-msg';
        msg.textContent = text;
        document.querySelector('.container').prepend(msg);
        setTimeout(() => msg.remove(), 6000);
    }

    window.supplierPortal = {
        acceptRequest,
        rejectRequest
    };

})();
</script>
<script src="assets/pwa-registration.js"></script>
</body>
</html>