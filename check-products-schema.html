<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Module Diagnostic Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: monospace;
            background: #0d1117;
            color: #e6edf3;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-result {
            background: #161b22;
            border: 1px solid #21262d;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .success { color: #3fb950; }
        .error { color: #f85149; }
        .warning { color: #f59e0b; }
        button {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px 5px;
        }
        button:hover {
            background: #d97706;
        }
    </style>
</head>
<body>
    <h1>üîç Data Module Diagnostic Test</h1>
    <p>This page will test if your data-module.js is working correctly.</p>

    <button onclick="runTests()">Run Diagnostic Tests</button>
    <button onclick="location.reload()">Refresh Page</button>

    <div id="results"></div>

    <script src="assets/script.js"></script>
    <script src="assets/auth.js"></script>
    <script src="assets/data-module.js"></script>

    <script>
        async function runTests() {
            const results = document.getElementById('results');
            results.innerHTML = '<h2>Running tests...</h2>';

            let html = '';

            // Test 1: Check if data-module is loaded
            html += '<div class="test-result">';
            html += '<h3>Test 1: Data Module Loaded</h3>';
            if (window.dataModule) {
                html += '<p class="success">‚úÖ window.dataModule exists</p>';
                html += '<p>Available functions: ' + Object.keys(window.dataModule).join(', ') + '</p>';
            } else {
                html += '<p class="error">‚ùå window.dataModule is NOT loaded!</p>';
                html += '<p class="warning">‚ö†Ô∏è Make sure data-module.js is in your assets/ folder</p>';
            }
            html += '</div>';

            // Test 2: Check if user is authenticated
            html += '<div class="test-result">';
            html += '<h3>Test 2: Authentication</h3>';
            try {
                await window.DukaPOS.initializeSupabase();
                const currentUser = authModule.getCurrentUser();
                if (currentUser) {
                    html += '<p class="success">‚úÖ User is logged in</p>';
                    html += '<p>User: ' + currentUser.full_name + '</p>';
                    html += '<p>Shop ID: ' + currentUser.shop_id + '</p>';
                    html += '<p>Role: ' + currentUser.role + '</p>';
                } else {
                    html += '<p class="error">‚ùå No user logged in</p>';
                }
            } catch (err) {
                html += '<p class="error">‚ùå Auth error: ' + err.message + '</p>';
            }
            html += '</div>';

            // Test 3: Try to load customers
            html += '<div class="test-result">';
            html += '<h3>Test 3: Load Customers (Filtered by Shop)</h3>';
            try {
                if (!window.dataModule) {
                    throw new Error('dataModule not loaded');
                }
                
                const result = await window.dataModule.getAllCustomers();
                
                if (result.success) {
                    html += '<p class="success">‚úÖ Customers loaded successfully!</p>';
                    html += '<p>Found ' + result.data.length + ' customers for your shop</p>';
                    
                    if (result.data.length > 0) {
                        html += '<table style="width:100%; border-collapse: collapse; margin-top: 10px;">';
                        html += '<tr><th style="text-align:left; border-bottom:1px solid #21262d; padding:8px;">ID</th>';
                        html += '<th style="text-align:left; border-bottom:1px solid #21262d; padding:8px;">Name</th>';
                        html += '<th style="text-align:left; border-bottom:1px solid #21262d; padding:8px;">Shop ID</th></tr>';
                        
                        result.data.forEach(customer => {
                            html += '<tr>';
                            html += '<td style="padding:8px; border-bottom:1px solid #21262d;">' + customer.id + '</td>';
                            html += '<td style="padding:8px; border-bottom:1px solid #21262d;">' + customer.name + '</td>';
                            html += '<td style="padding:8px; border-bottom:1px solid #21262d;">' + customer.shop_id + '</td>';
                            html += '</tr>';
                        });
                        html += '</table>';
                    }
                } else {
                    html += '<p class="error">‚ùå Failed to load customers: ' + result.error + '</p>';
                }
            } catch (err) {
                html += '<p class="error">‚ùå Error: ' + err.message + '</p>';
            }
            html += '</div>';

            // Test 4: Check database directly (without filter)
            html += '<div class="test-result">';
            html += '<h3>Test 4: Raw Database Query (All Customers)</h3>';
            try {
                const { data, error } = await window.DukaPOS.supabaseClient
                    .from('customers')
                    .select('id, name, shop_id')
                    .order('id', { ascending: true });

                if (error) throw error;

                html += '<p class="warning">‚ö†Ô∏è This shows ALL customers from ALL shops (no filter)</p>';
                html += '<p>Total customers in database: ' + data.length + '</p>';
                
                html += '<table style="width:100%; border-collapse: collapse; margin-top: 10px;">';
                html += '<tr><th style="text-align:left; border-bottom:1px solid #21262d; padding:8px;">ID</th>';
                html += '<th style="text-align:left; border-bottom:1px solid #21262d; padding:8px;">Name</th>';
                html += '<th style="text-align:left; border-bottom:1px solid #21262d; padding:8px;">Shop ID</th></tr>';
                
                data.forEach(customer => {
                    html += '<tr>';
                    html += '<td style="padding:8px; border-bottom:1px solid #21262d;">' + customer.id + '</td>';
                    html += '<td style="padding:8px; border-bottom:1px solid #21262d;">' + customer.name + '</td>';
                    html += '<td style="padding:8px; border-bottom:1px solid #21262d;">' + customer.shop_id + '</td>';
                    html += '</tr>';
                });
                html += '</table>';
            } catch (err) {
                html += '<p class="error">‚ùå Error: ' + err.message + '</p>';
            }
            html += '</div>';

            results.innerHTML = html;
        }

        // Auto-run on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await new Promise(resolve => setTimeout(resolve, 500)); // Wait for modules to load
            runTests();
        });
    </script>
</body>
</html>