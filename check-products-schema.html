<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - User Info</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0d1117;
            color: #e6edf3;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }
        .section {
            background: #161b22;
            border: 1px solid #21262d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        h2 {
            color: #58a6ff;
            margin-top: 0;
        }
        pre {
            background: #0d1117;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
        }
        .success {
            color: #3fb950;
        }
        .error {
            color: #f85149;
        }
        button {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #2ea043;
        }
    </style>
</head>
<body>
    <h1>üîç Debug User Authentication</h1>
    
    <div class="section">
        <h2>1. Supabase Connection</h2>
        <div id="connectionStatus">Checking...</div>
    </div>

    <div class="section">
        <h2>2. Auth User (from Supabase Auth)</h2>
        <pre id="authUser">Loading...</pre>
    </div>

    <div class="section">
        <h2>3. Application User (from users table)</h2>
        <pre id="appUser">Loading...</pre>
    </div>

    <div class="section">
        <h2>4. Suppliers (users with role=supplier)</h2>
        <pre id="suppliers">Loading...</pre>
    </div>

    <div class="section">
        <h2>5. Test Queries</h2>
        <button onclick="testSupplyRequest()">Test Create Supply Request</button>
        <button onclick="testPurchaseOrder()">Test Create Purchase Order</button>
        <pre id="testResults">Results will appear here...</pre>
    </div>

    <div class="section">
        <h2>Actions</h2>
        <button onclick="location.reload()">üîÑ Refresh</button>
        <button onclick="location.href='dashboard.html'">‚Üê Back to Dashboard</button>
    </div>

    <script>
        const SUPABASE_URL = 'https://tzcejcxqennwtnzxmsxg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6Y2VqY3hxZW5ud3Ruenhtc3hnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY1MTM4MzEsImV4cCI6MjA1MjA4OTgzMX0.ZjhXnOWwVDo1CjzhQWLBQcJnRr3Z3pTt8RWz2xJdAuY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let authUser = null;
        let appUser = null;

        async function init() {
            // Test connection
            try {
                document.getElementById('connectionStatus').innerHTML = '<span class="success">‚úì Connected to Supabase</span>';
            } catch (e) {
                document.getElementById('connectionStatus').innerHTML = '<span class="error">‚úó Connection failed</span>';
            }

            // Get auth user
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error) throw error;
                
                if (user) {
                    authUser = user;
                    document.getElementById('authUser').innerHTML = 
                        '<span class="success">‚úì Authenticated</span>\n' +
                        JSON.stringify({
                            id: user.id,
                            email: user.email,
                            created_at: user.created_at
                        }, null, 2);
                    
                    // Get app user
                    await loadAppUser(user.id);
                } else {
                    document.getElementById('authUser').innerHTML = '<span class="error">‚úó Not logged in</span>';
                }
            } catch (error) {
                document.getElementById('authUser').innerHTML = '<span class="error">‚úó Error: ' + error.message + '</span>';
            }

            // Load suppliers
            await loadSuppliers();
        }

        async function loadAppUser(authUserId) {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('auth_user_id', authUserId)
                    .single();

                if (error) throw error;

                if (data) {
                    appUser = data;
                    document.getElementById('appUser').innerHTML = 
                        '<span class="success">‚úì Found in users table</span>\n' +
                        JSON.stringify({
                            id: data.id,
                            username: data.username,
                            email: data.email,
                            role: data.role,
                            auth_user_id: data.auth_user_id
                        }, null, 2);
                } else {
                    document.getElementById('appUser').innerHTML = '<span class="error">‚úó Not found in users table</span>';
                }
            } catch (error) {
                document.getElementById('appUser').innerHTML = '<span class="error">‚úó Error: ' + error.message + '</span>';
            }
        }

        async function loadSuppliers() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('id, username, email, role, is_active')
                    .eq('role', 'supplier')
                    .eq('is_active', true);

                if (error) throw error;

                if (data && data.length > 0) {
                    document.getElementById('suppliers').innerHTML = 
                        '<span class="success">‚úì Found ' + data.length + ' supplier(s)</span>\n' +
                        JSON.stringify(data, null, 2);
                } else {
                    document.getElementById('suppliers').innerHTML = 
                        '<span class="error">‚ö† No suppliers found</span>\n' +
                        'Create users with role="supplier" in the admin panel';
                }
            } catch (error) {
                document.getElementById('suppliers').innerHTML = '<span class="error">‚úó Error: ' + error.message + '</span>';
            }
        }

        async function testSupplyRequest() {
            const results = document.getElementById('testResults');
            results.innerHTML = 'Testing supply request creation...\n';

            try {
                if (!appUser) {
                    results.innerHTML += '<span class="error">‚úó No app user found. Cannot create request.</span>';
                    return;
                }

                const testData = {
                    item_name: 'Test Item - ' + Date.now(),
                    quantity: 5,
                    unit: 'pieces',
                    priority: 'medium',
                    status: 'pending',
                    notes: 'Debug test request',
                    requested_by: appUser.id
                };

                results.innerHTML += 'Data to insert:\n' + JSON.stringify(testData, null, 2) + '\n\n';

                const { data, error } = await supabase
                    .from('supply_requests')
                    .insert([testData])
                    .select();

                if (error) throw error;

                results.innerHTML += '<span class="success">‚úì SUCCESS!</span>\n' + JSON.stringify(data, null, 2);
            } catch (error) {
                results.innerHTML += '<span class="error">‚úó ERROR: ' + error.message + '</span>\n' + JSON.stringify(error, null, 2);
            }
        }

        async function testPurchaseOrder() {
            const results = document.getElementById('testResults');
            results.innerHTML = 'Testing purchase order creation...\n';

            try {
                if (!appUser) {
                    results.innerHTML += '<span class="error">‚úó No app user found. Cannot create order.</span>';
                    return;
                }

                // First, get a supplier
                const { data: suppliers, error: suppError } = await supabase
                    .from('users')
                    .select('id, username')
                    .eq('role', 'supplier')
                    .eq('is_active', true)
                    .limit(1);

                if (suppError) throw suppError;

                if (!suppliers || suppliers.length === 0) {
                    results.innerHTML += '<span class="error">‚úó No suppliers found. Create a user with role="supplier" first.</span>';
                    return;
                }

                const supplier = suppliers[0];
                results.innerHTML += 'Using supplier: ' + supplier.username + ' (ID: ' + supplier.id + ')\n\n';

                const testData = {
                    supplier_id: supplier.id,
                    order_number: 'TEST-' + Date.now(),
                    order_date: new Date().toISOString().split('T')[0],
                    expected_delivery_date: new Date(Date.now() + 7*24*60*60*1000).toISOString().split('T')[0],
                    status: 'pending',
                    total_amount: 1000,
                    notes: 'Debug test order',
                    created_by: appUser.id
                };

                results.innerHTML += 'Data to insert:\n' + JSON.stringify(testData, null, 2) + '\n\n';

                const { data, error } = await supabase
                    .from('supplier_purchase_orders')
                    .insert([testData])
                    .select();

                if (error) throw error;

                results.innerHTML += '<span class="success">‚úì SUCCESS!</span>\n' + JSON.stringify(data, null, 2);
            } catch (error) {
                results.innerHTML += '<span class="error">‚úó ERROR: ' + error.message + '</span>\n' + JSON.stringify(error, null, 2);
            }
        }

        init();
    </script>
</body>
</html>