<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Duka POS - Sales Analytics & Commission</title>
    
    <!-- ‚úÖ PWA META TAGS - ADD THESE -->
    <meta name="theme-color" content="#f59e0b">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TheFilmigo">
    <meta name="description" content="Multi-tenant Point of Sale system">
    
    <!-- ‚úÖ PWA MANIFEST LINK -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- ‚úÖ APPLE TOUCH ICONS -->
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/assets/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/assets/icons/icon-512x512.png">
    
    <!-- ‚úÖ FAVICON -->
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/icons/icon-192x192.png">
    
    <!-- Your existing styles and scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;500;600;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/nav-styles.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Archivo', sans-serif;
      background: var(--bg-primary);
      color: var(--text);
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    .page-header {
      margin-bottom: 32px;
    }

    .page-header h1 {
      font-size: 2rem;
      font-weight: 900;
      margin-bottom: 8px;
    }

    .controls {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 32px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      min-width: 180px;
    }

    .control-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .control-input, .control-select {
      padding: 10px 14px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 1rem;
      font-family: inherit;
    }

    .control-input:focus, .control-select:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    .btn {
      padding: 10px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s;
      align-self: flex-end;
    }

    .btn-primary {
      background: var(--accent-blue);
      color: white;
    }

    .btn-primary:hover {
      background: #4a96e5;
    }

    .btn-success {
      background: var(--accent-green);
      color: white;
    }

    .btn-success:hover {
      background: #2ea043;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 900;
      font-family: 'Space Mono', monospace;
    }

    .stat-value.currency {
      color: var(--accent-green);
    }

    .stat-value.profit {
      color: var(--accent-orange);
    }

    .stat-value.count {
      color: var(--accent-blue);
    }

    .section {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: 700;
    }

    .table-container {
      overflow-x: auto;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table thead {
      background: var(--bg-tertiary);
    }

    .table th {
      padding: 14px;
      text-align: left;
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      border-bottom: 1px solid var(--border);
    }

    .table th.text-right {
      text-align: right;
    }

    .table td {
      padding: 14px;
      border-bottom: 1px solid var(--border);
    }

    .table td.text-right {
      text-align: right;
    }

    .table tbody tr:hover {
      background: rgba(88, 166, 255, 0.05);
    }

    .currency {
      font-family: 'Space Mono', monospace;
      font-weight: 600;
    }

    .rank-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-weight: 900;
      font-size: 0.9rem;
    }

    @media (max-width: 768px) {

  .nav-container {
    flex-wrap: wrap;
    gap: 12px;
  }

  .nav-tabs {
    width: 100%;
    overflow-x: auto;
    white-space: nowrap;
  }

  .nav-tab {
    font-size: 0.9rem;
    padding: 8px 12px;
  }

  .nav-right {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

}


    .rank-1 {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #000;
    }

    .rank-2 {
      background: linear-gradient(135deg, #C0C0C0, #808080);
      color: #000;
    }

    .rank-3 {
      background: linear-gradient(135deg, #CD7F32, #8B4513);
      color: #fff;
    }

    .rank-other {
      background: var(--bg-tertiary);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 6px;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent-green);
      transition: width 0.3s ease;
    }

    .btn-small {
      padding: 6px 14px;
      font-size: 0.85rem;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 24px;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .detail-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }

    .detail-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .detail-value {
      font-size: 1.3rem;
      font-weight: 700;
      font-family: 'Space Mono', monospace;
    }

    .chart-container {
      margin-top: 20px;
      padding: 20px;
      background: var(--bg-tertiary);
      border-radius: 8px;
    }

    .period-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .period-tab {
      padding: 8px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.15s;
    }

    .period-tab:hover {
      background: var(--bg-secondary);
    }

    .period-tab.active {
      background: var(--accent-blue);
      color: white;
      border-color: var(--accent-blue);
    }
  </style>
</head>
<body>

  <nav class="nav">
    <div class="nav-container">
      <div class="logo">DUKA POS</div>
      <div class="nav-tabs">
        <a href="admin.html" class="nav-tab">üë• Users</a>
        <a href="sales-analytics.html" class="nav-tab active">üí∞ Sales Analytics</a>
        <a href="pos.html" class="nav-tab">üõí POS</a>
        <a href="products.html" class="nav-tab">üì¶ Products</a>
        <a href="inventory.html" class="nav-tab">üìä Inventory</a>
      </div>
      <div class="nav-right">
        <div class="user-badge">
          <div class="user-avatar">üë§</div>
          <div class="user-details">
            <div class="user-name" id="currentUserName">Administrator</div>
            <div class="user-date" id="currentDate"></div>
          </div>
        </div>
        <button class="logout-btn" onclick="authModule.logout()">
          <span>üö™</span>
          <span>Logout</span>
        </button>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <h1>üí∞ Sales Analytics & Commission</h1>
      <p style="color: var(--text-muted);">Track cashier performance and calculate commissions</p>
    </div>

    <!-- Period Selection -->
    <div class="period-tabs">
      <button class="period-tab" onclick="setPeriod('today', this)">Today</button>
      <button class="period-tab" onclick="setPeriod('yesterday', this)">Yesterday</button>
      <button class="period-tab active" onclick="setPeriod('week', this)">This Week</button>
      <button class="period-tab" onclick="setPeriod('month', this)">This Month</button>
      <button class="period-tab" onclick="setPeriod('custom', this)">Custom Range</button>
    </div>

    <!-- Custom Date Range Controls -->
    <div class="controls" id="customControls" style="display: none;">
      <div class="control-group">
        <label class="control-label">Start Date</label>
        <input type="date" class="control-input" id="startDate" />
      </div>
      <div class="control-group">
        <label class="control-label">End Date</label>
        <input type="date" class="control-input" id="endDate" />
      </div>
      <div class="control-group">
        <label class="control-label">Commission Rate (%)</label>
        <input type="number" class="control-input" id="commissionRate" value="10" min="0" max="100" step="0.5" />
      </div>
      <button class="btn btn-primary" onclick="loadAnalytics()">
        üîç Generate Report
      </button>
      <button class="btn btn-success" onclick="exportReport()">
        üìä Export Excel
      </button>
    </div>

    <!-- Overall Stats -->
    <div class="stats-grid" id="overallStats">
      <div class="stat-card">
        <div class="stat-label">Total Revenue</div>
        <div class="stat-value currency" id="totalRevenue">KES 0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Profit</div>
        <div class="stat-value profit" id="totalProfit">KES 0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Commission</div>
        <div class="stat-value currency" id="totalCommission">KES 0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Transactions</div>
        <div class="stat-value count" id="totalTransactions">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Items Sold</div>
        <div class="stat-value count" id="totalItems">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Profit Margin</div>
        <div class="stat-value profit" id="profitMargin">0%</div>
      </div>
    </div>

    <!-- Cashier Performance Table -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">Cashier Performance & Commission</h2>
        <div style="color: var(--text-muted); font-size: 0.9rem;" id="periodDisplay">This Week</div>
      </div>

      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Cashier</th>
              <th class="text-right">Transactions</th>
              <th class="text-right">Items Sold</th>
              <th class="text-right">Revenue</th>
              <th class="text-right">Cost</th>
              <th class="text-right">Profit</th>
              <th class="text-right">Margin %</th>
              <th class="text-right">Commission</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="cashierTableBody">
            <tr>
              <td colspan="10" style="text-align: center; padding: 40px;">Loading data...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Cashier Detail Modal -->
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <h2 class="modal-header" id="detailModalTitle">Cashier Details</h2>
      <div id="detailContent"></div>
      <div style="margin-top: 24px; display: flex; gap: 12px;">
        <button class="btn btn-success" onclick="exportCashierReport()">üìä Export Report</button>
        <button class="btn btn-primary" onclick="closeDetailModal()">Close</button>
      </div>
    </div>
  </div>

  <script src="assets/script.js"></script>
  <script src="assets/auth.js"></script>
  <script src="assets/sales-analytics.js"></script>
  <script src="assets/excel-export.js"></script>
  <script>
    let currentPeriod = 'week';
    let currentStartDate = null;
    let currentEndDate = null;
    let currentCommissionRate = 10;
    let cashierData = [];
    let selectedCashier = null;

    window.addEventListener('DOMContentLoaded', async () => {
      await initializeSupabase();
      await authModule.requireAuth('administrator');

      const currentUser = authModule.getCurrentUser();
      document.getElementById('currentUserName').textContent = currentUser.full_name;

      // Set default dates
      setPeriod('week');
    });

    function setPeriod(period, clickedElement = null) {
      currentPeriod = period;
      
      // Remove active class from all tabs
      document.querySelectorAll('.period-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Add active class to clicked tab or find the appropriate tab
      if (clickedElement) {
        clickedElement.classList.add('active');
      } else {
        // Find and activate the tab that matches this period
        const tabs = document.querySelectorAll('.period-tab');
        tabs.forEach(tab => {
          const tabText = tab.textContent.toLowerCase();
          if (
            (period === 'today' && tabText.includes('today')) ||
            (period === 'yesterday' && tabText.includes('yesterday')) ||
            (period === 'week' && tabText.includes('week')) ||
            (period === 'month' && tabText.includes('month')) ||
            (period === 'custom' && tabText.includes('custom'))
          ) {
            tab.classList.add('active');
          }
        });
      }

      const today = new Date();
      today.setHours(23, 59, 59, 999);

      switch(period) {
        case 'today':
          currentStartDate = new Date(today);
          currentStartDate.setHours(0, 0, 0, 0);
          currentEndDate = new Date(today);
          document.getElementById('customControls').style.display = 'none';
          document.getElementById('periodDisplay').textContent = 'Today';
          loadAnalytics();
          break;
        
        case 'yesterday':
          currentStartDate = new Date(today);
          currentStartDate.setDate(currentStartDate.getDate() - 1);
          currentStartDate.setHours(0, 0, 0, 0);
          currentEndDate = new Date(currentStartDate);
          currentEndDate.setHours(23, 59, 59, 999);
          document.getElementById('customControls').style.display = 'none';
          document.getElementById('periodDisplay').textContent = 'Yesterday';
          loadAnalytics();
          break;
        
        case 'week':
          currentStartDate = new Date(today);
          currentStartDate.setDate(currentStartDate.getDate() - 7);
          currentStartDate.setHours(0, 0, 0, 0);
          currentEndDate = new Date(today);
          document.getElementById('customControls').style.display = 'none';
          document.getElementById('periodDisplay').textContent = 'This Week (Last 7 Days)';
          loadAnalytics();
          break;
        
        case 'month':
          currentStartDate = new Date(today);
          currentStartDate.setDate(currentStartDate.getDate() - 30);
          currentStartDate.setHours(0, 0, 0, 0);
          currentEndDate = new Date(today);
          document.getElementById('customControls').style.display = 'none';
          document.getElementById('periodDisplay').textContent = 'This Month (Last 30 Days)';
          loadAnalytics();
          break;
        
        case 'custom':
          document.getElementById('customControls').style.display = 'flex';
          document.getElementById('periodDisplay').textContent = 'Custom Range';
          // Set date inputs to current values
          if (currentStartDate) {
            document.getElementById('startDate').value = currentStartDate.toISOString().split('T')[0];
          }
          if (currentEndDate) {
            document.getElementById('endDate').value = currentEndDate.toISOString().split('T')[0];
          }
          break;
      }
    }

    async function loadAnalytics() {
      try {
        // Get values from custom controls if in custom mode
        if (currentPeriod === 'custom') {
          const startDateInput = document.getElementById('startDate').value;
          const endDateInput = document.getElementById('endDate').value;
          
          if (!startDateInput || !endDateInput) {
            alert('Please select both start and end dates');
            return;
          }
          
          currentStartDate = new Date(startDateInput);
          currentStartDate.setHours(0, 0, 0, 0);
          currentEndDate = new Date(endDateInput);
          currentEndDate.setHours(23, 59, 59, 999);
          
          currentCommissionRate = parseFloat(document.getElementById('commissionRate').value) || 10;
          
          const displayStart = currentStartDate.toLocaleDateString();
          const displayEnd = currentEndDate.toLocaleDateString();
          document.getElementById('periodDisplay').textContent = `${displayStart} - ${displayEnd}`;
        }

        console.log('üìä Loading analytics...', {
          startDate: currentStartDate.toISOString(),
          endDate: currentEndDate.toISOString(),
          commissionRate: currentCommissionRate
        });

        // Get commission report
        const result = await salesAnalytics.getCommissionReport(
          currentStartDate.toISOString(),
          currentEndDate.toISOString(),
          currentCommissionRate
        );

        console.log('üìä Analytics result:', result);

        if (result.success) {
          cashierData = result.report;
          console.log('‚úÖ Loaded cashier data:', cashierData.length, 'cashiers');
          renderCashierTable();
          updateOverallStats();
        } else {
          console.error('‚ùå Failed to load analytics:', result.error);
          alert('Failed to load analytics: ' + result.error);
        }
      } catch (error) {
        console.error('‚ùå Error in loadAnalytics:', error);
        alert('Error loading analytics: ' + error.message);
      }
    }

    function renderCashierTable() {
      const tbody = document.getElementById('cashierTableBody');
      
      if (cashierData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px;">No sales data for this period</td></tr>';
        return;
      }

      // Find max profit for progress bars
      const maxProfit = Math.max(...cashierData.map(c => c.total_profit));

      tbody.innerHTML = cashierData.map((cashier, index) => {
        const rank = index + 1;
        let rankBadgeClass = 'rank-other';
        if (rank === 1) rankBadgeClass = 'rank-1';
        else if (rank === 2) rankBadgeClass = 'rank-2';
        else if (rank === 3) rankBadgeClass = 'rank-3';

        const progressPercent = maxProfit > 0 ? (cashier.total_profit / maxProfit * 100) : 0;

        return `
          <tr>
            <td>
              <span class="rank-badge ${rankBadgeClass}">${rank}</span>
            </td>
            <td style="font-weight: 600;">
              ${cashier.full_name}
              <div style="font-size: 0.8rem; color: var(--text-muted); font-family: 'Space Mono', monospace;">
                @${cashier.username}
              </div>
            </td>
            <td class="text-right">${cashier.total_transactions}</td>
            <td class="text-right">${cashier.items_sold}</td>
            <td class="text-right currency" style="color: var(--accent-green);">
              KES ${cashier.total_revenue.toLocaleString('en-KE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
            </td>
            <td class="text-right currency" style="color: var(--text-muted);">
              KES ${cashier.total_cost.toLocaleString('en-KE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
            </td>
            <td class="text-right currency" style="color: var(--accent-orange);">
              KES ${cashier.total_profit.toLocaleString('en-KE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${progressPercent}%;"></div>
              </div>
            </td>
            <td class="text-right" style="font-weight: 600;">
              ${cashier.profit_margin.toFixed(2)}%
            </td>
            <td class="text-right currency" style="color: var(--accent-blue); font-weight: 700;">
              KES ${cashier.commission_amount.toLocaleString('en-KE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
            </td>
            <td>
              <button class="btn btn-primary btn-small" onclick="viewCashierDetails(${cashier.user_id})">
                üìä View Details
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function updateOverallStats() {
      const totalRevenue = cashierData.reduce((sum, c) => sum + c.total_revenue, 0);
      const totalProfit = cashierData.reduce((sum, c) => sum + c.total_profit, 0);
      const totalCommission = cashierData.reduce((sum, c) => sum + c.commission_amount, 0);
      const totalTransactions = cashierData.reduce((sum, c) => sum + c.total_transactions, 0);
      const totalItems = cashierData.reduce((sum, c) => sum + c.items_sold, 0);
      const profitMargin = totalRevenue > 0 ? (totalProfit / totalRevenue * 100) : 0;

      document.getElementById('totalRevenue').textContent = `KES ${totalRevenue.toLocaleString('en-KE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      document.getElementById('totalProfit').textContent = `KES ${totalProfit.toLocaleString('en-KE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      document.getElementById('totalCommission').textContent = `KES ${totalCommission.toLocaleString('en-KE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      document.getElementById('totalTransactions').textContent = totalTransactions.toLocaleString();
      document.getElementById('totalItems').textContent = totalItems.toLocaleString();
      document.getElementById('profitMargin').textContent = `${profitMargin.toFixed(2)}%`;
    }

    async function viewCashierDetails(userId) {
      selectedCashier = cashierData.find(c => c.user_id === userId);
      
      const result = await salesAnalytics.getDetailedCashierReport(
        userId,
        currentStartDate.toISOString(),
        currentEndDate.toISOString()
      );

      if (result.success) {
        const report = result.report;
        const commission = salesAnalytics.calculateCommission(report.summary.total_profit, currentCommissionRate);

        const html = `
          <div class="detail-grid">
            <div class="detail-card">
              <div class="detail-label">Transactions</div>
              <div class="detail-value">${report.summary.total_transactions}</div>
            </div>
            <div class="detail-card">
              <div class="detail-label">Items Sold</div>
              <div class="detail-value">${report.summary.items_sold}</div>
            </div>
            <div class="detail-card">
              <div class="detail-label">Revenue</div>
              <div class="detail-value" style="color: var(--accent-green);">
                KES ${report.summary.total_revenue.toLocaleString('en-KE', {minimumFractionDigits: 2})}
              </div>
            </div>
            <div class="detail-card">
              <div class="detail-label">Profit</div>
              <div class="detail-value" style="color: var(--accent-orange);">
                KES ${report.summary.total_profit.toLocaleString('en-KE', {minimumFractionDigits: 2})}
              </div>
            </div>
            <div class="detail-card">
              <div class="detail-label">Commission (${currentCommissionRate}%)</div>
              <div class="detail-value" style="color: var(--accent-blue);">
                KES ${commission.toLocaleString('en-KE', {minimumFractionDigits: 2})}
              </div>
            </div>
            <div class="detail-card">
              <div class="detail-label">Profit Margin</div>
              <div class="detail-value">${report.summary.profit_margin.toFixed(2)}%</div>
            </div>
          </div>

          <h3 style="margin: 24px 0 16px;">Daily Breakdown</h3>
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th class="text-right">Transactions</th>
                  <th class="text-right">Items</th>
                  <th class="text-right">Revenue</th>
                  <th class="text-right">Profit</th>
                </tr>
              </thead>
              <tbody>
                ${report.dailyBreakdown.map(day => `
                  <tr>
                    <td>${new Date(day.date).toLocaleDateString('en-KE', {weekday: 'short', year: 'numeric', month: 'short', day: 'numeric'})}</td>
                    <td class="text-right">${day.transactions}</td>
                    <td class="text-right">${day.items}</td>
                    <td class="text-right currency">KES ${day.revenue.toLocaleString('en-KE', {minimumFractionDigits: 2})}</td>
                    <td class="text-right currency" style="color: var(--accent-orange);">
                      KES ${day.profit.toLocaleString('en-KE', {minimumFractionDigits: 2})}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;

        document.getElementById('detailModalTitle').textContent = `${report.user.full_name} - Detailed Report`;
        document.getElementById('detailContent').innerHTML = html;
        document.getElementById('detailModal').classList.add('active');
      }
    }

    function closeDetailModal() {
      document.getElementById('detailModal').classList.remove('active');
    }

    async function exportReport() {
      if (cashierData.length === 0) {
        alert('No data to export. Please generate a report first.');
        return;
      }

      const result = await excelExport.exportCommissionToExcel(
        cashierData,
        currentStartDate.toISOString(),
        currentEndDate.toISOString(),
        currentCommissionRate
      );

      if (result.success) {
        // Use present_files to share the file with user
        await window.bash_tool({
          command: `echo "Excel file ready: ${result.fileName}"`,
          description: 'Confirm export'
        });
        
        alert(`‚úÖ Report exported successfully!\nFile: ${result.fileName}\n\nThe file will be available in your downloads.`);
        
        // Present the file to the user
        window.location.href = result.filePath;
      } else {
        alert('Failed to export report: ' + result.error);
      }
    }

    async function exportCashierReport() {
      if (!selectedCashier) {
        alert('No cashier selected');
        return;
      }

      const result = await salesAnalytics.getDetailedCashierReport(
        selectedCashier.user_id,
        currentStartDate.toISOString(),
        currentEndDate.toISOString()
      );

      if (result.success) {
        const exportResult = await excelExport.exportCashierDetailToExcel(
          result.report,
          currentCommissionRate
        );

        if (exportResult.success) {
          alert(`‚úÖ Cashier report exported successfully!\nFile: ${exportResult.fileName}`);
          window.location.href = exportResult.filePath;
        } else {
          alert('Failed to export cashier report: ' + exportResult.error);
        }
      }
    }

    function updateDate() {
      const now = new Date();
      const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
      document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', options);
    }
    setInterval(updateDate, 60000);
    updateDate();
  </script>
  <script src="assets/pwa-registration.js"></script>

</body>
</html>