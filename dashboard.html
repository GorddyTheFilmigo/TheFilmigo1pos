<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        (function() {
            const keys = ['currentUser', 'user', 'duka_user', 'gh_user', 'pos_user', 'auth_user'];
            let role = null;
            for (const key of keys) {
                try {
                    const raw = localStorage.getItem(key);
                    if (raw) {
                        const obj = JSON.parse(raw);
                        if (obj && obj.role) { role = obj.role.trim().toLowerCase(); break; }
                    }
                } catch(e) {}
            }
            if (role !== null) {
                const adminRoles = ['admin', 'administrator', 'superadmin', 'manager'];
                if (!adminRoles.includes(role)) {
                    window.location.replace(role === 'supplier' ? 'suppliers.html' : 'pos.html');
                }
            }
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#f59e0b">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TheFilmigo">
    <meta name="description" content="Multi-tenant Point of Sale system">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="assets/offline-styles.css">
    <script src="assets/page-access-guard.js"></script>
    <script src="assets/nav-visibility-controller.js"></script>
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/assets/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/assets/icons/icon-512x512.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/icons/icon-192x192.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <title>G&H Solutions - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;500;600;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/nav-styles.css">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #1a2030;
            --border: #21262d;
            --text: #e6edf3;
            --text-muted: #8b949e;
            --accent-orange: #f59e0b;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --danger: #f85149;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Archivo', sans-serif; background: var(--bg-primary); color: var(--text); margin: 0; padding: 0; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px 16px; }
        .page-header { margin-bottom: 24px; }
        .page-header h1 { font-size: clamp(1.5rem, 5vw, 2.5rem); font-weight: 900; margin-bottom: 8px; }
        .page-header p { font-size: 0.9rem; color: var(--text-muted); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(min(100%, 220px), 1fr)); gap: 16px; margin-bottom: 32px; }
        .stat-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-4px); }
        .stat-title { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 10px; }
        .stat-value { font-size: clamp(1.6rem, 4vw, 2.5rem); font-weight: 900; color: var(--accent-orange); word-break: break-all; }
        .stat-subtitle { font-size: 0.8rem; color: var(--text-muted); margin-top: 6px; }
        .chart-container { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 24px; overflow: hidden; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 8px; }
        .chart-title { font-size: clamp(1rem, 3vw, 1.3rem); font-weight: 700; }
        .date-range { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .date-input { padding: 8px 10px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.85rem; min-width: 0; flex: 1 1 120px; max-width: 180px; }
        .btn { padding: 9px 16px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.85rem; white-space: nowrap; }
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: var(--accent-green); color: white; }
        .btn-secondary { background: var(--accent-blue); color: white; }
        .btn-small { padding: 6px 12px; font-size: 0.8rem; }
        .btn-danger-sm { padding: 6px 12px; font-size: 0.8rem; background: transparent; color: var(--text-muted); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: all 0.15s; font-weight: 600; }
        .btn-danger-sm:hover { background: rgba(248,81,73,0.12); color: var(--danger); border-color: var(--danger); }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th, td { padding: 12px 10px; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.88rem; }
        th { background: var(--bg-tertiary); font-weight: 700; color: var(--text-muted); text-transform: uppercase; font-size: 0.78rem; }
        tr:hover { background: rgba(88,166,255,0.08); }
        .top-cashier { background: rgba(63,185,80,0.15); padding: 14px; border-radius: 10px; margin-top: 16px; font-size: 0.9rem; }
        .loading { text-align: center; padding: 40px; color: var(--text-muted); }
        .error-message { color: var(--danger); text-align: center; padding: 40px; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-state-icon { font-size: 3.5rem; margin-bottom: 16px; }
        .info-box { background: rgba(88,166,255,0.1); border: 1px solid rgba(88,166,255,0.3); border-radius: 8px; padding: 14px; margin-bottom: 20px; font-size: 0.9rem; }
        .message-notification-bell { position: relative; cursor: pointer; font-size: 1.4rem; padding: 8px 10px; border-radius: 8px; transition: background 0.2s; }
        .message-notification-bell:hover { background: rgba(88,166,255,0.1); }
        .message-badge { position: absolute; top: 4px; right: 4px; background: #f85149; color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700; box-shadow: 0 0 0 2px var(--bg-primary); min-width: 18px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100%{ transform:scale(1); } 50%{ transform:scale(1.08); } }
        .messages-popup { position: fixed; top: 70px; right: 10px; width: min(480px, calc(100vw - 20px)); max-height: 80vh; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); z-index: 9999; display: none; flex-direction: column; overflow: hidden; }
        .messages-popup.active { display: flex; }
        .messages-header { padding: 14px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg-tertiary); }
        .messages-header h3 { margin: 0; font-size: 1.1rem; }
        .close-popup { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; padding: 2px 8px; border-radius: 6px; }
        .close-popup:hover { color: var(--danger); background: rgba(248,81,73,0.1); }
        .messages-list { flex: 1; overflow-y: auto; padding: 12px; }
        .message-item { background: rgba(88,166,255,0.08); border: 1px solid rgba(88,166,255,0.2); border-radius: 8px; padding: 12px 14px; margin-bottom: 10px; }
        .message-item.sent { background: rgba(63,185,80,0.1); border-color: rgba(63,185,80,0.3); }
        .message-item.read { opacity: 0.6; background: rgba(139,148,158,0.08); border-color: rgba(139,148,158,0.2); }
        .message-item.rejection { background: rgba(248,81,73,0.08); border: 1px solid rgba(248,81,73,0.35); border-left: 4px solid var(--danger); transition: opacity 0.3s; }
        .message-item.rejection.read { opacity: 0.45; border-left-color: var(--text-muted); background: rgba(139,148,158,0.06); }
        .rejection-label { display: inline-flex; align-items: center; gap: 4px; background: var(--danger); color: white; font-size: 0.7rem; font-weight: 700; padding: 2px 9px; border-radius: 20px; margin-bottom: 8px; letter-spacing: 0.04em; text-transform: uppercase; }
        .rejection-reason { background: rgba(248,81,73,0.1); border-left: 3px solid var(--danger); padding: 7px 12px; border-radius: 0 6px 6px 0; font-size: 0.85rem; color: #fca5a5; margin: 8px 0; font-style: italic; line-height: 1.5; }
        .rejection-actions { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        .rej-btn { padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 700; cursor: pointer; border: none; transition: all 0.15s; font-family: 'Archivo', sans-serif; }
        .rej-btn-reorder { background: rgba(245,158,11,0.18); color: var(--accent-orange); border: 1px solid rgba(245,158,11,0.45); }
        .rej-btn-reorder:hover { background: rgba(245,158,11,0.32); }
        .rej-btn-contact { background: rgba(88,166,255,0.15); color: var(--accent-blue); border: 1px solid rgba(88,166,255,0.4); }
        .rej-btn-contact:hover { background: rgba(88,166,255,0.28); }
        .rej-btn-dismiss { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
        .rej-btn-dismiss:hover { background: rgba(248,81,73,0.12); color: var(--danger); border-color: rgba(248,81,73,0.45); }
        .rej-dismissed-label { font-size: 0.78rem; color: var(--text-muted); margin-top: 8px; display: flex; align-items: center; gap: 5px; }
        .message-header { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-muted); flex-wrap: wrap; gap: 4px; }
        .message-sender { font-weight: 600; color: var(--accent-orange); }
        .message-time { font-size: 0.78rem; }
        .message-text { color: var(--text); line-height: 1.4; word-break: break-word; font-size: 0.9rem; }
        .mark-read-btn { background: var(--accent-green); color: white; border: none; border-radius: 6px; padding: 5px 10px; font-size: 0.78rem; cursor: pointer; font-weight: 600; margin-top: 8px; }
        .mark-read-btn:hover { background: #2ea043; }
        .reply-btn { background: var(--accent-blue); color: white; border: none; border-radius: 6px; padding: 5px 10px; font-size: 0.78rem; cursor: pointer; font-weight: 600; margin-top: 8px; margin-left: 6px; }
        .empty-messages { text-align: center; padding: 40px 16px; color: var(--text-muted); }
        .empty-messages-icon { font-size: 3rem; margin-bottom: 10px; }
        .popup-tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--bg-tertiary); }
        .popup-tab { flex: 1; padding: 10px 8px; background: none; border: none; border-bottom: 3px solid transparent; color: var(--text-muted); font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.15s; }
        .popup-tab:hover { color: var(--text); }
        .popup-tab.active { color: var(--danger); border-bottom-color: var(--danger); }
        .popup-tab.tab-staff.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }
        .popup-section { display: none; }
        .popup-section.active { display: block; }
        .status-badge { display: inline-block; padding: 3px 10px; border-radius: 6px; font-size: 0.78rem; font-weight: 600; }
        .status-pending { background: rgba(245,158,11,0.15); color: var(--accent-orange); }
        .status-processing { background: rgba(88,166,255,0.15); color: var(--accent-blue); }
        .status-shipped { background: rgba(139,92,246,0.15); color: #a78bfa; }
        .status-delivered { background: rgba(16,185,129,0.15); color: #10b981; }
        .status-cancelled { background: rgba(248,81,73,0.15); color: var(--danger); }
        .dashboard-tabs { display: flex; gap: 4px; margin-bottom: 20px; border-bottom: 2px solid var(--border); overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .dashboard-tabs::-webkit-scrollbar { display: none; }
        .dashboard-tab { padding: 10px 18px; background: none; border: none; border-bottom: 3px solid transparent; color: var(--text-muted); font-size: 0.92rem; font-weight: 600; cursor: pointer; transition: all 0.15s; white-space: nowrap; flex-shrink: 0; }
        .dashboard-tab:hover { color: var(--text); background: rgba(88,166,255,0.05); }
        .dashboard-tab.active { color: var(--accent-orange); border-bottom-color: var(--accent-orange); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .supplier-order-card { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 12px; padding: 18px; margin-bottom: 14px; }
        .order-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; flex-wrap: wrap; gap: 8px; }
        .order-id { font-size: 1.1rem; font-weight: 700; color: var(--accent-orange); }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 10000; align-items: center; justify-content: center; padding: 16px; }
        .modal-overlay.show { display: flex; }
        .modal-box { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 14px; padding: 24px; width: 100%; max-width: 480px; }
        .modal-box h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 14px; }
        .modal-box textarea { width: 100%; padding: 10px 12px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: 'Archivo', sans-serif; font-size: 0.92rem; resize: vertical; min-height: 100px; margin-bottom: 14px; }
        .modal-box textarea:focus { outline: none; border-color: var(--accent-blue); }
        .modal-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .modal-btn-send { background: var(--accent-blue); color: white; }
        .modal-btn-send:hover { background: #3b8de8; }
        .modal-btn-cancel { background: var(--bg-tertiary); color: var(--text-muted); border: 1px solid var(--border); }
        .modal-btn-cancel:hover { color: var(--text); }
        #messageText { box-sizing: border-box; }
        .insight-card { background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.3); border-radius: 10px; padding: 16px; margin: 16px 0; font-size: 0.95rem; line-height: 1.5; }
        .insight-card strong { color: var(--accent-orange); }
        .insight-card.danger { background: rgba(248,81,73,0.08); border-color: rgba(248,81,73,0.4); }
        .insight-card.danger strong { color: var(--danger); }
        .heatmap-container { position: relative; height: 340px; margin: 16px 0; }
        .heatmap-legend { display: flex; justify-content: center; gap: 12px; margin-top: 8px; font-size: 0.82rem; color: var(--text-muted); }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-color { width: 16px; height: 16px; border-radius: 3px; }
        .segment-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin: 24px 0; }
        .segment-card { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; padding: 18px; }
        .segment-title { font-size: 1.05rem; font-weight: 700; margin-bottom: 10px; color: var(--accent-blue); }
        .export-btn { background: var(--accent-blue); color: white; margin-left: auto; }
        .export-btn:hover { background: #3b8de8; }

        /* â”€â”€ AI INSIGHTS â”€â”€ */
        .ai-section { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
        .ai-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; flex-wrap: wrap; gap: 8px; }
        .ai-header h2 { font-size: clamp(1rem,3vw,1.3rem); font-weight: 700; margin: 0; }
        .ai-timestamp { font-size: 0.75rem; color: var(--text-muted); }
        .ai-spinner-wrap { display: flex; align-items: center; gap: 10px; color: var(--text-muted); font-size: 0.88rem; padding: 20px 0; }
        .ai-spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--accent-orange); border-radius: 50%; animation: spin 0.8s linear infinite; flex-shrink: 0; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* KPI row */
        .ai-kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(min(100%,170px),1fr)); gap: 12px; margin: 16px 0; }
        .ai-kpi { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; }
        .ai-kpi-label { font-size: 0.72rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--text-muted); margin-bottom: 6px; }
        .ai-kpi-value { font-size: 1.4rem; font-weight: 900; line-height: 1.1; }
        .ai-kpi-value.green  { color: var(--accent-green); }
        .ai-kpi-value.orange { color: var(--accent-orange); }
        .ai-kpi-value.red    { color: var(--danger); }
        .ai-kpi-value.blue   { color: var(--accent-blue); }
        .ai-kpi-sub { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; line-height: 1.4; }

        /* Section divider */
        .ai-divider { font-size: 0.78rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--text-muted); margin: 20px 0 10px; display: flex; align-items: center; gap: 8px; }
        .ai-divider::after { content:''; flex:1; height:1px; background: var(--border); }

        /* List cards */
        .ai-list-card { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; margin-bottom: 12px; }
        .ai-list-item { display: flex; align-items: flex-start; gap: 10px; padding: 11px 14px; border-bottom: 1px solid var(--border); font-size: 0.86rem; line-height: 1.45; }
        .ai-list-item:last-child { border-bottom: none; }
        .ai-icon { font-size: 1.05rem; flex-shrink: 0; margin-top: 1px; }
        .ai-item-main { flex: 1; }
        .ai-item-name { font-weight: 700; }
        .ai-item-sub { font-size: 0.78rem; color: var(--text-muted); margin-top: 2px; }
        .ai-badge { display: inline-block; padding: 2px 8px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; margin-left: 6px; vertical-align: middle; }
        .badge-red    { background: rgba(248,81,73,0.18);  color: var(--danger); }
        .badge-orange { background: rgba(245,158,11,0.18); color: var(--accent-orange); }
        .badge-green  { background: rgba(63,185,80,0.18);  color: var(--accent-green); }
        .badge-blue   { background: rgba(88,166,255,0.18); color: var(--accent-blue); }
        .badge-purple { background: rgba(167,139,250,0.18); color: #a78bfa; }

        /* Forecast bar */
        .ai-forecast-bar { height: 6px; background: var(--border); border-radius: 3px; margin: 6px 0 2px; overflow: hidden; }
        .ai-forecast-fill { height: 100%; border-radius: 3px; transition: width 1s ease; }

        /* Trend chip */
        .trend-chip { display: inline-flex; align-items: center; gap: 3px; padding: 2px 9px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
        .trend-up   { background: rgba(63,185,80,0.15);  color: var(--accent-green); }
        .trend-down { background: rgba(248,81,73,0.15);  color: var(--danger); }
        .trend-flat { background: rgba(245,158,11,0.15); color: var(--accent-orange); }

        /* Alert box */
        .ai-alert { border-radius: 8px; padding: 12px 14px; font-size: 0.88rem; line-height: 1.5; margin: 10px 0; }
        .ai-alert.warn  { background: rgba(245,158,11,0.1); border-left: 3px solid var(--accent-orange); }
        .ai-alert.good  { background: rgba(63,185,80,0.1);  border-left: 3px solid var(--accent-green); }
        .ai-alert.bad   { background: rgba(248,81,73,0.1);  border-left: 3px solid var(--danger); }
        .ai-alert.info  { background: rgba(88,166,255,0.1); border-left: 3px solid var(--accent-blue); }

        @media (max-width: 768px) {
            .container { padding: 12px; }
            .page-header { margin-bottom: 16px; }
            .page-header p { font-size: 0.82rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
            .stat-card { padding: 14px 12px; }
            .stat-value { font-size: 1.35rem; }
            .stat-title { font-size: 0.78rem; }
            .date-range { gap: 6px; }
            .date-input { max-width: 100%; flex: 1 1 100px; font-size: 0.8rem; padding: 7px 8px; }
            .btn { padding: 8px 12px; font-size: 0.8rem; }
            .chart-container { padding: 14px; }
            .chart-title { font-size: 1rem; }
            canvas { max-height: 260px !important; }
            .table-container::before { content: 'â† scroll â†’'; display: block; text-align: center; font-size: 0.7rem; color: var(--text-muted); margin-bottom: 6px; }
            th, td { padding: 10px 8px; font-size: 0.8rem; }
            .supplier-order-card > div[style*="grid"] { grid-template-columns: 1fr 1fr !important; }
            #messageText { min-height: 80px; font-size: 0.9rem; }
            .messages-popup { top: 60px; right: 8px; left: 8px; width: auto; max-height: 75vh; }
            .modal-box { padding: 18px; }
            .modal-actions { flex-direction: column; }
            .modal-actions .btn, .modal-actions button { width: 100%; }
            .top-cashier { font-size: 0.85rem; padding: 10px 12px; }
            #sentMessagesTable td:nth-child(5), #sentMessagesTable th:nth-child(5) { display: none; }
            .ai-kpi-row { grid-template-columns: repeat(2, 1fr); }
            .ai-section { padding: 14px; }
        }
        @media (max-width: 400px) {
            .stats-grid { grid-template-columns: 1fr; }
            .stat-value { font-size: 1.6rem; }
            .dashboard-tab { padding: 8px 12px; font-size: 0.82rem; }
            .ai-kpi-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body style="visibility:hidden;">

    <nav class="nav">
        <div class="nav-container">
            <div class="logo"><img src="assets/icons/icon-512x512.png" alt="Logo" class="logo">
            <style>.logo { width: 100px; height: auto; }</style></div>
            <div class="nav-tabs">
                <a href="dashboard.html" class="nav-tab active" id="dashboardLink" style="display:none;">Dashboard</a>
                <a href="pos.html" class="nav-tab" id="posLink" style="display:none;">Point of Sale</a>
                <a href="products.html" class="nav-tab" id="productsLink" style="display:none;">Products</a>
                <a href="inventory.html" class="nav-tab" id="inventoryLink" style="display:none;">Inventory</a>
                <a href="customers.html" class="nav-tab" id="customersLink" style="display:none;">Customers</a>
                <a href="supply-requests.html" class="nav-tab" id="suppliersLink" style="display:none;">Suppliers</a>
                <a href="admin.html" class="nav-tab" id="adminTab" style="display:none;">Users</a>
            </div>
            <div class="nav-right">
                <div class="user-badge">
                    <div class="user-avatar">ğŸ‘¤</div>
                    <div>
                        <div id="currentUserName">User</div>
                        <div id="currentDate"></div>
                    </div>
                </div>
                <div class="message-notification-bell" onclick="toggleMessagesPopup()" id="messageBell">
                    ğŸ””
                    <span class="message-badge" id="messageBadge" style="display:none;">0</span>
                </div>
                <button onclick="authModule.logout()"
                    style="padding:9px 15px;background-color:#ef4444;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;box-shadow:0 4px 10px rgba(239,68,68,.3);transition:all .2s ease;"
                    onmouseover="this.style.backgroundColor='#dc2626';this.style.transform='translateY(-1px)'"
                    onmouseout="this.style.backgroundColor='#ef4444';this.style.transform='translateY(0)'"
                >Logout</button>
            </div>
        </div>
    </nav>

    <div class="messages-popup" id="messagesPopup">
        <div class="messages-header">
            <h3>ğŸ”” Notifications</h3>
            <button class="close-popup" onclick="toggleMessagesPopup()">Ã—</button>
        </div>
        <div class="popup-tabs">
            <button class="popup-tab active" id="tabRejections" onclick="switchPopupTab('rejections')">
                âŒ Rejections
                <span id="rejectionTabBadge" style="display:none;background:var(--danger);color:white;border-radius:10px;padding:1px 7px;font-size:0.72rem;margin-left:4px;"></span>
            </button>
            <button class="popup-tab tab-staff" id="tabStaff" onclick="switchPopupTab('staff')">ğŸ’¬ Staff Msgs</button>
        </div>
        <div class="messages-list" id="messagesList">
            <div class="popup-section active" id="sectionRejections">
                <div class="empty-messages"><div class="empty-messages-icon">ğŸ“­</div><p>Loadingâ€¦</p></div>
            </div>
            <div class="popup-section" id="sectionStaff">
                <div class="empty-messages"><div class="empty-messages-icon">ğŸ“­</div><p>Loadingâ€¦</p></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="contactSupplierModal">
        <div class="modal-box">
            <h3>ğŸ’¬ Contact Supplier</h3>
            <p style="font-size:0.83rem;color:var(--text-muted);margin-bottom:12px;">
                Send a follow-up to <strong id="contactSupplierName" style="color:var(--text);"></strong>
                about <strong id="contactItemName" style="color:var(--accent-orange);"></strong>.
            </p>
            <textarea id="contactSupplierMessage" placeholder="e.g. Could you clarify why this was rejected?"></textarea>
            <div class="modal-actions">
                <button class="btn modal-btn-send" id="contactSendBtn" onclick="sendContactMessage()">ğŸ“¤ Send Message</button>
                <button class="btn modal-btn-cancel" onclick="closeContactModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="page-header">
            <h1>ğŸ“Š Dashboard Overview</h1>
            <p>Real-time sales, performance insights, and supplier communications</p>
        </div>

        <div class="dashboard-tabs">
            <button class="dashboard-tab active" onclick="switchDashboardTab('analytics', this)">ğŸ“ˆ Analytics</button>
            <button class="dashboard-tab" onclick="window.location.href='supply-requests.html'">ğŸ­ Supplier Orders</button>
            <button class="dashboard-tab" onclick="switchDashboardTab('messaging', this)">ğŸ’¬ Staff Messaging</button>
        </div>

        <div id="analyticsTab" class="tab-content active">
            <div class="info-box" id="infoBox" style="display:none;">
                <strong>â„¹ï¸ Quick Tip:</strong> <span id="infoText"></span>
            </div>

            <div class="date-range" style="justify-content: space-between; align-items: center; flex-wrap: wrap;">
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <input type="date" id="startDate" class="date-input">
                    <input type="date" id="endDate" class="date-input">
                    <button class="btn btn-primary" onclick="loadDashboard()">Refresh</button>
                    <button class="btn btn-secondary" onclick="setDateRange('today')">Today</button>
                    <button class="btn btn-secondary" onclick="setDateRange('week')">Week</button>
                    <button class="btn btn-secondary" onclick="setDateRange('month')">Month</button>
                </div>
                <button class="btn export-btn" onclick="exportAnalyticsToCSV()">Export to CSV</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card"><div class="stat-title">Total Revenue</div><div class="stat-value" id="totalRevenue">KES 0.00</div></div>
                <div class="stat-card"><div class="stat-title">Net Profit</div><div class="stat-value" id="totalProfit">KES 0.00</div><div class="stat-subtitle" id="profitBreakdown">Profit - Expenses</div></div>
                <div class="stat-card"><div class="stat-title">Total Expenses</div><div class="stat-value" style="color:var(--danger);" id="totalExpenses">KES 0.00</div></div>
                <div class="stat-card"><div class="stat-title">Transactions</div><div class="stat-value" id="transactionCount">0</div></div>
                <div class="stat-card"><div class="stat-title">Items Sold</div><div class="stat-value" id="itemsSold">0</div></div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Peak Sales Hours</h2>
                    <p style="color:var(--text-muted);font-size:0.9rem;">Hour vs Day of Week (darker = higher revenue)</p>
                </div>
                <div class="heatmap-container">
                    <canvas id="salesHeatmap" style="max-height:340px;"></canvas>
                </div>
                <div class="heatmap-legend">
                    <div class="legend-item"><div class="legend-color" style="background:#3fb950;"></div>High</div>
                    <div class="legend-item"><div class="legend-color" style="background:#f59e0b;"></div>Medium</div>
                    <div class="legend-item"><div class="legend-color" style="background:#f85149;"></div>Low</div>
                </div>
                <div id="bestTimeSlots" class="insight-card">
                    <strong>Best performing time slots:</strong><br>
                    <span id="topSlots">Loading...</span>
                </div>
                <div class="insight-card danger" id="revenueLeakInsight" style="display:none;">
                    <strong>âš ï¸ Low performing slot detected</strong><br>
                    <span id="leakMessage"></span>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header"><h2 class="chart-title">Customer Overview</h2></div>
                <div class="stats-grid" style="margin-top:0;">
                    <div class="stat-card">
                        <div class="stat-title">New vs Returning</div>
                        <div class="stat-value" id="newVsReturning">Loading...</div>
                        <div class="stat-subtitle">New: <span id="newCustomers">0</span> â€¢ Returning: <span id="returningCustomers">0</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Customer Lifetime Value (CLV)</div>
                        <div class="stat-value" id="clv">KES 0.00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Avg Spend per Customer</div>
                        <div class="stat-value" id="avgSpend">KES 0.00</div>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header"><h2 class="chart-title">Purchase Behavior</h2></div>
                <div class="insight-card">
                    <strong>Most common product combinations:</strong><br>
                    <ul id="productBundles" style="margin:8px 0 0 20px; padding:0; list-style:disc;">
                        <li>Loading...</li>
                    </ul>
                </div>
                <div class="insight-card">
                    <strong>Purchase frequency:</strong> Average <span id="purchaseFrequency">â€”</span> orders per customer<br>
                    <strong>Time between purchases:</strong> Average <span id="timeBetweenPurchases">â€”</span> days
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header"><h2 class="chart-title">Customer Segmentation</h2></div>
                <div class="segment-grid">
                    <div class="segment-card"><div class="segment-title">High Spenders</div><p id="highSpenders">Loading...</p></div>
                    <div class="segment-card"><div class="segment-title">Occasional Buyers</div><p id="occasionalBuyers">Loading...</p></div>
                    <div class="segment-card"><div class="segment-title">At-Risk Customers</div><p id="atRiskCustomers">Loading...</p></div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 PREDICTIVE INSIGHTS & AI SUGGESTIONS
                 All data sourced live from Supabase
                 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="ai-section" id="aiSection">
                <div class="ai-header">
                    <h2>ğŸ¤– Predictive Insights &amp; AI Suggestions</h2>
                    <span class="ai-timestamp" id="aiTimestamp"></span>
                </div>

                <!-- Loading state -->
                <div class="ai-spinner-wrap" id="aiLoading">
                    <div class="ai-spinner"></div>
                    <span>Analysing your dataâ€¦</span>
                </div>

                <!-- Content (hidden until loaded) -->
                <div id="aiContent" style="display:none;">

                    <!-- â‘  REVENUE FORECAST -->
                    <div class="ai-divider">ğŸ“… Revenue Forecast</div>
                    <div class="ai-kpi-row">
                        <div class="ai-kpi">
                            <div class="ai-kpi-label">Predicted â€” Next 7 Days</div>
                            <div class="ai-kpi-value green" id="ai_forecast7">KES â€”</div>
                            <div class="ai-forecast-bar"><div class="ai-forecast-fill" id="ai_forecastBar" style="width:0%;background:var(--accent-green);"></div></div>
                            <div class="ai-kpi-sub" id="ai_forecastSub">â€”</div>
                        </div>
                        <div class="ai-kpi">
                            <div class="ai-kpi-label">Best Day of Week</div>
                            <div class="ai-kpi-value blue" id="ai_bestDay">â€”</div>
                            <div class="ai-kpi-sub" id="ai_bestDaySub">Based on last 90 days</div>
                        </div>
                        <div class="ai-kpi">
                            <div class="ai-kpi-label">Best Hour of Day</div>
                            <div class="ai-kpi-value blue" id="ai_bestHour">â€”</div>
                            <div class="ai-kpi-sub" id="ai_bestHourSub">Peak revenue window</div>
                        </div>
                        <div class="ai-kpi">
                            <div class="ai-kpi-label">Avg Daily Revenue</div>
                            <div class="ai-kpi-value orange" id="ai_avgDaily">KES â€”</div>
                            <div class="ai-kpi-sub" id="ai_avgDailySub">In selected period</div>
                        </div>
                    </div>

                    <!-- â‘¡ RESTOCK SUGGESTIONS -->
                    <div class="ai-divider">ğŸ“¦ Restock Suggestions</div>
                    <div class="ai-list-card" id="ai_restockList">
                        <div class="ai-list-item"><div class="ai-spinner" style="margin:auto;"></div></div>
                    </div>

                    <!-- â‘¢ BUNDLE / CROSS-SELL -->
                    <div class="ai-divider">ğŸ›’ Cross-sell Opportunities</div>
                    <div class="ai-list-card" id="ai_bundleList">
                        <div class="ai-list-item"><div class="ai-spinner" style="margin:auto;"></div></div>
                    </div>

                    <!-- â‘£ MARGIN ALERTS -->
                    <div class="ai-divider">ğŸ“‰ Margin &amp; Profitability</div>
                    <div class="ai-kpi-row">
                        <div class="ai-kpi">
                            <div class="ai-kpi-label">Avg Profit Margin</div>
                            <div class="ai-kpi-value" id="ai_margin">â€”%</div>
                            <div class="ai-kpi-sub" id="ai_marginSub">Across period</div>
                        </div>
                        <div class="ai-kpi">
                            <div class="ai-kpi-label">Low-Margin Days (&lt;20%)</div>
                            <div class="ai-kpi-value" id="ai_lowMarginDays">â€”</div>
                            <div class="ai-kpi-sub" id="ai_lowMarginSub">days flagged</div>
                        </div>
                        <div class="ai-kpi">
                            <div class="ai-kpi-label">Best Margin Day</div>
                            <div class="ai-kpi-value green" id="ai_bestMarginDay">â€”</div>
                            <div class="ai-kpi-sub" id="ai_bestMarginDaySub">â€”</div>
                        </div>
                    </div>
                    <div id="ai_marginAlert"></div>

                    <!-- â‘¤ CHURN RISK -->
                    <div class="ai-divider">ğŸ”” Customer Churn Risk</div>
                    <div class="ai-list-card" id="ai_churnList">
                        <div class="ai-list-item"><div class="ai-spinner" style="margin:auto;"></div></div>
                    </div>

                    <!-- â‘¥ PAYMENT INSIGHTS -->
                    <div class="ai-divider">ğŸ’³ Payment Behaviour</div>
                    <div class="ai-kpi-row">
                        <div class="ai-kpi">
                            <div class="ai-kpi-label">Top Payment Method</div>
                            <div class="ai-kpi-value blue" id="ai_topPayment">â€”</div>
                            <div class="ai-kpi-sub" id="ai_topPaymentSub">â€”</div>
                        </div>
                        <div class="ai-kpi">
                            <div class="ai-kpi-label">Avg Transaction Value</div>
                            <div class="ai-kpi-value green" id="ai_avgTx">KES â€”</div>
                            <div class="ai-kpi-sub" id="ai_avgTxSub">â€”</div>
                        </div>
                        <div class="ai-kpi">
                            <div class="ai-kpi-label">Credit Sales</div>
                            <div class="ai-kpi-value orange" id="ai_credit">KES â€”</div>
                            <div class="ai-kpi-sub" id="ai_creditSub">Unpaid / deferred</div>
                        </div>
                    </div>

                </div><!-- /aiContent -->
            </div><!-- /ai-section -->

            <div class="chart-container">
                <div class="chart-header"><h2 class="chart-title">Sales by Cashier</h2></div>
                <canvas id="cashierChart" style="max-height:340px;"></canvas>
                <div id="cashierChartEmpty" class="empty-state" style="display:none;">
                    <div class="empty-state-icon">ğŸ“Š</div><h3>No Sales Data Available</h3>
                </div>
                <div id="topCashier" class="top-cashier" style="display:none;">
                    <strong>Top Performer:</strong> <span id="topPerformerName"></span> â€” KES <span id="topPerformerProfit"></span>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header"><h2 class="chart-title">Top Selling Products</h2></div>
                <canvas id="topProductsChart" style="max-height:340px;"></canvas>
                <div id="productsChartEmpty" class="empty-state" style="display:none;">
                    <div class="empty-state-icon">ğŸ“¦</div><h3>No Product Sales Data</h3>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header"><h2 class="chart-title">Expenses by Cashier</h2></div>
                <canvas id="expensesByCashierChart" style="max-height:340px;"></canvas>
                <div id="expensesChartEmpty" class="empty-state" style="display:none;">
                    <div class="empty-state-icon">ğŸ’¸</div><h3>No Expense Data Available</h3>
                </div>
                <div id="topSpender" class="top-cashier" style="display:none;">
                    <strong>Top Spender:</strong> <span id="topSpenderName"></span> â€” KES <span id="topSpenderAmount"></span>
                </div>
            </div>

            <div style="margin-top:32px;">
                <h2 style="margin-bottom:12px;">Recent Transactions</h2>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th><th>Cashier</th><th>Total (KES)</th>
                                <th>Profit (KES)</th><th>Items</th><th>Payment</th>
                            </tr>
                        </thead>
                        <tbody id="recentTransactions">
                            <tr><td colspan="6" class="loading">Loading transactions...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div><!-- /analyticsTab -->

        <div id="suppliersTab" class="tab-content">
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">ğŸ­ Supplier Purchase Orders</h2>
                    <button class="btn btn-primary" onclick="createNewSupplierOrder()">+ New Order</button>
                </div>
                <div class="stats-grid" style="margin-top:20px;">
                    <div class="stat-card"><div class="stat-title">ğŸŸ¡ Pending</div><div class="stat-value" id="pendingOrdersCount">0</div></div>
                    <div class="stat-card"><div class="stat-title">ğŸ”µ In Progress</div><div class="stat-value" id="processingOrdersCount">0</div></div>
                    <div class="stat-card"><div class="stat-title">ğŸŸ¢ Delivered</div><div class="stat-value" id="deliveredOrdersCount">0</div></div>
                    <div class="stat-card"><div class="stat-title">ğŸ’° Total Value</div><div class="stat-value" id="totalOrdersValue">KES 0</div></div>
                </div>
                <div style="margin-top:28px;">
                    <h3 style="margin-bottom:14px;">Active Orders</h3>
                    <div id="supplierOrdersList">
                        <div class="empty-state"><div class="empty-state-icon">ğŸ“¦</div><h3>No Supplier Orders Yet</h3></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="messagingTab" class="tab-content">
            <div class="chart-container">
                <div class="chart-header"><h2 class="chart-title">ğŸ“¨ Send Message to Staff</h2></div>
                <div style="display:grid;gap:16px;margin-bottom:16px;">
                    <div>
                        <label style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;">Select Recipient:</label>
                        <select id="messageRecipient" class="date-input" style="width:100%;max-width:100%;padding:10px;">
                            <option value="">-- Select a user --</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;">Message:</label>
                        <textarea id="messageText" placeholder="Enter your message here... (auto-expires in 72 hours)"
                            style="width:100%;padding:10px;background:var(--bg-primary);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Archivo',sans-serif;font-size:0.92rem;resize:vertical;min-height:90px;"></textarea>
                        <div style="font-size:0.8rem;color:var(--text-muted);margin-top:4px;">ğŸ’¡ Messages automatically expire after 72 hours</div>
                    </div>
                    <button id="sendMessageBtn" class="btn btn-primary" onclick="sendMessageToUser()" style="width:100%;">ğŸ“¤ Send Message</button>
                </div>
                <div style="margin-top:24px;">
                    <h3 style="margin-bottom:14px;font-size:1rem;">ğŸ“¬ Recently Sent Messages</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead><tr><th>Sent To</th><th>Message</th><th>Sent At</th><th>Read</th><th>Expires In</th></tr></thead>
                            <tbody id="sentMessagesTable">
                                <tr><td colspan="5" class="loading">Loading sent messages...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="assets/script.js"></script>
    <script src="assets/auth.js"></script>
    <script src="assets/data-module.js"></script>
    <script src="assets/sales-analytics.js"></script>
    <script src="assets/messaging-module.js"></script>
    <script src="assets/supplier-orders-module.js"></script>

    <script>
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       HELPERS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    let _db = null;
    function getDB() {
        if (_db) return _db;
        _db = window.DukaPOS?.supabaseClient || null;
        return _db;
    }

    const fmt = (n) => Number(n).toLocaleString('en-KE', { maximumFractionDigits: 0 });
    const fmtDec = (n, d=2) => Number(n).toLocaleString('en-KE', { minimumFractionDigits: d, maximumFractionDigits: d });

    function set(id, html) {
        const el = document.getElementById(id);
        if (el) el.innerHTML = html;
    }
    function setText(id, txt) {
        const el = document.getElementById(id);
        if (el) el.textContent = txt;
    }
    function setClass(id, cls) {
        const el = document.getElementById(id);
        if (el) el.className = cls;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       POPUP / NAV / MISC  (unchanged from original)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function switchPopupTab(tab) {
        document.getElementById('tabRejections').classList.toggle('active', tab==='rejections');
        document.getElementById('tabStaff').classList.toggle('active', tab==='staff');
        document.getElementById('sectionRejections').classList.toggle('active', tab==='rejections');
        document.getElementById('sectionStaff').classList.toggle('active', tab==='staff');
    }

    function setNavigationVisibility(userRole) {
        const role = userRole.toLowerCase().trim();
        ['dashboardLink','posLink','productsLink','inventoryLink','customersLink','suppliersLink','adminTab']
            .forEach(id => { const el = document.getElementById(id); if (el) el.style.display='none'; });
        if (['admin','administrator','manager'].includes(role)) {
            ['dashboardLink','posLink','productsLink','inventoryLink','customersLink','suppliersLink','adminTab']
                .forEach(id => { const el = document.getElementById(id); if (el) el.style.display='flex'; });
        } else if (role==='cashier') {
            ['posLink','productsLink','customersLink'].forEach(id => { const el=document.getElementById(id); if(el) el.style.display='flex'; });
        } else {
            const el=document.getElementById('posLink'); if(el) el.style.display='flex';
        }
    }

    function switchDashboardTab(tabName, el) {
        document.querySelectorAll('.dashboard-tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        if(el) el.classList.add('active');
        document.getElementById(tabName+'Tab').classList.add('active');
        if(tabName==='suppliers') loadSupplierOrders();
    }

    let _rejectionStoreKey = 'dismissedRejections_default';
    let _dismissedIds = new Set();
    function _initRejectionStore(userId) {
        _rejectionStoreKey = `dismissedRejections_${userId}`;
        try { const raw=localStorage.getItem(_rejectionStoreKey); _dismissedIds=new Set(raw?JSON.parse(raw):[]); }
        catch { _dismissedIds=new Set(); }
    }
    function _persistDismissed() { try { localStorage.setItem(_rejectionStoreKey, JSON.stringify([..._dismissedIds])); } catch(e){} }
    function _isDismissed(id) { return _dismissedIds.has(String(id)); }
    function _markDismissed(id) { _dismissedIds.add(String(id)); _persistDismissed(); }

    async function loadRejectionNotifications() {
        const db=getDB(); if(!db) return {rejections:[],unseen:0};
        try {
            const {data,error} = await db.from('supply_requests')
                .select(`id,item_name,quantity,unit,supplier_response,created_at,approved_at,supplier_id,supplier:supplier_id(id,full_name,email)`)
                .eq('status','rejected').order('approved_at',{ascending:false}).limit(40);
            if(error) throw error;
            const rejections=data||[];
            return {rejections, unseen:rejections.filter(r=>!_isDismissed(r.id)).length};
        } catch(err) { return {rejections:[],unseen:0}; }
    }

    function renderRejectionSection(rejections) {
        const section=document.getElementById('sectionRejections');
        if(!rejections.length) { section.innerHTML='<div class="empty-messages"><div class="empty-messages-icon">âœ…</div><p>No supplier rejections</p></div>'; return; }
        section.innerHTML=rejections.map(r=>{
            const dismissed=_isDismissed(r.id);
            const supplierName=r.supplier?.full_name||r.supplier?.email||'Supplier';
            const supplierId=r.supplier?.id||r.supplier_id||null;
            const rejectedAt=r.approved_at?new Date(r.approved_at).toLocaleString():'â€”';
            const itemName=r.item_name||'Unknown item';
            const qty=`${r.quantity||'â€”'} ${r.unit||''}`.trim();
            const actionsHtml=dismissed
                ?`<div class="rej-dismissed-label">âœ” Dismissed â€” <button class="rej-btn rej-btn-reorder" style="padding:3px 10px;font-size:0.72rem;" onclick="reorderRejected('${encodeURIComponent(itemName)}','${encodeURIComponent(qty)}')">ğŸ”„ Reorder anyway</button></div>`
                :`<div class="rejection-actions">
                    <button class="rej-btn rej-btn-reorder" onclick="reorderRejected('${encodeURIComponent(itemName)}','${encodeURIComponent(qty)}')">ğŸ”„ Reorder</button>
                    ${supplierId?`<button class="rej-btn rej-btn-contact" onclick="openContactModal(${supplierId},'${encodeURIComponent(supplierName)}','${encodeURIComponent(itemName)}')">ğŸ’¬ Contact</button>`:''}
                    <button class="rej-btn rej-btn-dismiss" onclick="dismissRejection(${r.id},this)">Dismiss</button>
                  </div>`;
            return `<div class="message-item rejection ${dismissed?'read':''}" id="rejection-${r.id}">
                <span class="rejection-label">âŒ Request Rejected</span>
                <div class="message-header"><span class="message-sender">ğŸ­ ${supplierName}</span><span class="message-time">${rejectedAt}</span></div>
                <div class="message-text"><strong>${itemName}</strong> Â· Qty: ${qty}</div>
                ${r.supplier_response?`<div class="rejection-reason">"${r.supplier_response}"</div>`:''}
                ${actionsHtml}</div>`;
        }).join('');
    }

    function dismissRejection(id,btn) {
        _markDismissed(id);
        const card=document.getElementById(`rejection-${id}`);
        if(card){
            card.classList.add('read');
            const actions=card.querySelector('.rejection-actions');
            const itemNameEl=card.querySelector('.message-text strong');
            const itemName=itemNameEl?encodeURIComponent(itemNameEl.textContent.trim()):'';
            if(actions) actions.outerHTML=`<div class="rej-dismissed-label">âœ” Dismissed â€” <button class="rej-btn rej-btn-reorder" style="padding:3px 10px;font-size:0.72rem;" onclick="reorderRejected('${itemName}','')">ğŸ”„ Reorder anyway</button></div>`;
        }
        updateBellBadge();
    }
    function reorderRejected(ei,eq) { window.location.href=`supply-requests.html?prefill_item=${ei}&prefill_qty=${eq}`; }

    let _contactSupplierId=null;
    function openContactModal(sId,eName,eItem) {
        _contactSupplierId=sId;
        document.getElementById('contactSupplierName').textContent=decodeURIComponent(eName);
        document.getElementById('contactItemName').textContent=decodeURIComponent(eItem);
        document.getElementById('contactSupplierMessage').value='';
        document.getElementById('contactSupplierModal').classList.add('show');
    }
    function closeContactModal() { document.getElementById('contactSupplierModal').classList.remove('show'); _contactSupplierId=null; }

    async function sendContactMessage() {
        if(!_contactSupplierId) return;
        const text=document.getElementById('contactSupplierMessage').value.trim();
        if(!text){alert('Please enter a message.');return;}
        const btn=document.getElementById('contactSendBtn');
        btn.disabled=true; btn.textContent='â³ Sendingâ€¦';
        try {
            let result={success:false,error:'messagingModule not available'};
            if(window.messagingModule) result=await window.messagingModule.sendMessage(parseInt(_contactSupplierId),text);
            if(result.success){closeContactModal();alert('âœ… Message sent to supplier!');}
            else alert('Failed: '+(result.error||'Unknown error'));
        } catch(err){alert('Error: '+err.message);}
        finally{btn.disabled=false;btn.textContent='ğŸ“¤ Send Message';}
    }
    document.getElementById('contactSupplierModal').addEventListener('click',function(e){if(e.target===this)closeContactModal();});

    async function updateBellBadge() {
        const {unseen:rejUnseen}=await loadRejectionNotifications();
        let staffUnseen=0;
        try{if(window.messagingModule){const r=await window.messagingModule.getUnreadCount();if(r.success)staffUnseen=r.count||0;}}catch(_){}
        const total=rejUnseen+staffUnseen;
        const badge=document.getElementById('messageBadge');
        badge.textContent=total>99?'99+':total;
        badge.style.display=total>0?'flex':'none';
        const rBadge=document.getElementById('rejectionTabBadge');
        if(rejUnseen>0){rBadge.textContent=rejUnseen;rBadge.style.display='inline';}
        else rBadge.style.display='none';
    }

    async function toggleMessagesPopup() {
        const popup=document.getElementById('messagesPopup');
        if(popup.classList.contains('active')){popup.classList.remove('active');return;}
        popup.classList.add('active');
        document.getElementById('sectionRejections').innerHTML='<div class="empty-messages"><div class="empty-messages-icon">ğŸ“­</div><p>Loadingâ€¦</p></div>';
        document.getElementById('sectionStaff').innerHTML='<div class="empty-messages"><div class="empty-messages-icon">ğŸ“­</div><p>Loadingâ€¦</p></div>';
        const {rejections}=await loadRejectionNotifications();
        renderRejectionSection(rejections);
        await loadStaffMessagesIntoPopup();
    }
    document.addEventListener('click',function(e){
        const popup=document.getElementById('messagesPopup');
        const bell=document.getElementById('messageBell');
        if(popup?.classList.contains('active')&&!popup.contains(e.target)&&!bell.contains(e.target))popup.classList.remove('active');
    });

    async function loadStaffMessagesIntoPopup() {
        const section=document.getElementById('sectionStaff');
        try{
            let messages=[];
            const sentResult=await window.messagingModule?.getSentMessages(20);
            if(sentResult?.success&&sentResult.data) messages=messages.concat(sentResult.data.map(m=>({...m,type:'sent'})));
            const allResult=await window.messagingModule?.getAllMessages(30);
            if(allResult?.success&&allResult.data){
                const cu=authModule.getCurrentUser();
                messages=messages.concat(allResult.data.filter(m=>m.recipient_id===cu.id).map(m=>({...m,type:'received'})));
            }
            messages.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
            if(!messages.length){section.innerHTML='<div class="empty-messages"><div class="empty-messages-icon">ğŸ“­</div><p>No staff messages yet</p></div>';return;}
            section.innerHTML=messages.map(msg=>`
                <div class="message-item ${msg.type} ${msg.is_read?'read':''}">
                    <div class="message-header">
                        <span class="message-sender">${msg.type==='sent'?'To '+(msg.recipient?.full_name||'Staff'):'From '+(msg.sender?.full_name||'Staff')}</span>
                        <span class="message-time">${new Date(msg.created_at).toLocaleString()}</span>
                    </div>
                    <div class="message-text">${msg.message_text||'(empty)'}</div>
                    <div style="margin-top:6px;font-size:0.78rem;color:var(--text-muted);">
                        ${msg.is_read?'âœ… Read':'â³ Unread'}
                        ${msg.expires_at?' Â· Expires in '+Math.max(0,Math.round((new Date(msg.expires_at)-new Date())/3600000))+'h':''}
                    </div>
                    ${!msg.is_read&&msg.type==='received'?`<button class="mark-read-btn" onclick="markMessageAsRead(${msg.id},event)">Mark as Read</button>`:''}
                </div>`).join('');
        }catch(err){section.innerHTML=`<div class="empty-messages"><p>Error: ${err.message}</p></div>`;}
    }

    async function markMessageAsRead(messageId,event) {
        const btn=event.target;const item=btn.closest('.message-item');
        try{const result=await window.messagingModule.markAsRead(messageId);if(result.success){btn.remove();if(item)item.classList.add('read');updateBellBadge();}}
        catch(err){console.error('Mark read error:',err);}
    }

    async function getDateRangeFilter() {
        const start=document.getElementById('startDate').value;
        const end=document.getElementById('endDate').value;
        if(!start||!end) return null;
        return {start:`${start} 00:00:00`,end:`${end} 23:59:59.999`};
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       HEATMAP  (unchanged)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    let salesHeatmapChart=null;
    async function renderHeatmapAndInsights() {
        const ctx=document.getElementById('salesHeatmap').getContext('2d');
        const range=await getDateRangeFilter(); if(!range) return;
        const {data,error}=await getDB().from('sales').select('created_at,total_amount').gte('created_at',range.start).lte('created_at',range.end);
        if(error||!data?.length){document.getElementById('topSlots').textContent="No sales data in selected period";document.getElementById('revenueLeakInsight').style.display='none';return;}
        const matrix=Array(7).fill().map(()=>Array(24).fill(0));
        data.forEach(sale=>{const d=new Date(sale.created_at);matrix[d.getDay()][d.getHours()]+=Number(sale.total_amount||0);});
        const flat=matrix.flat(); const max=Math.max(...flat)||1;
        const normalized=matrix.map(row=>row.map(v=>(v/max)*100));
        const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        const hours=Array.from({length:24},(_,i)=>i.toString().padStart(2,'0')+'h');
        function getColor(v){return v<20?'rgba(248,81,73,0.6)':v<50?'rgba(245,158,11,0.7)':'rgba(63,185,80,0.8)';}
        if(salesHeatmapChart)salesHeatmapChart.destroy();
        salesHeatmapChart=new Chart(ctx,{type:'bar',data:{labels:hours,datasets:days.map((day,i)=>({label:day,data:normalized[i],backgroundColor:normalized[i].map(v=>getColor(v)),borderWidth:0,barPercentage:0.95,categoryPercentage:0.9}))},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',scales:{x:{stacked:false},y:{stacked:false}},plugins:{legend:{position:'top'}}}});
        let topSlots=[];
        matrix.forEach((row,di)=>row.forEach((val,h)=>{if(val>0)topSlots.push({day:days[di],hour:h,value:val});}));
        topSlots.sort((a,b)=>b.value-a.value);
        topSlots=topSlots.slice(0,3).map(s=>`${s.day} ${s.hour.toString().padStart(2,'0')}:00â€“${(s.hour+1).toString().padStart(2,'0')}:00`);
        document.getElementById('topSlots').textContent=topSlots.join(', ')||"No significant peaks";
        const friAfternoon=matrix[5][14]+matrix[5][15];
        const avg=flat.reduce((a,b)=>a+b,0)/flat.length;
        if(friAfternoon<avg*0.5){document.getElementById('leakMessage').textContent=`Fridays 2â€“4 PM are ~${Math.round(100-(friAfternoon/avg*100))}% below average â€” consider promotions.`;document.getElementById('revenueLeakInsight').style.display='block';}
        else document.getElementById('revenueLeakInsight').style.display='none';
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       CUSTOMER OVERVIEW / PURCHASE BEHAVIOR / SEGMENTATION  (unchanged)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    async function renderCustomerOverview() {
        const range=await getDateRangeFilter(); if(!range) return;
        const {count:newCount}=await getDB().from('customers').select('*',{count:'exact',head:true}).gte('created_at',range.start).lte('created_at',range.end);
        const {data:salesInPeriod}=await getDB().from('sales').select('customer_id').gte('created_at',range.start).lte('created_at',range.end);
        const uniqueCustomers=new Set(salesInPeriod?.map(s=>s.customer_id)||[]);
        const returning=uniqueCustomers.size-(newCount||0);
        const {data:revenueData}=await getDB().from('sales').select('total_amount,customer_id').gte('created_at',range.start).lte('created_at',range.end);
        let totalRevenue=0; const spendByCustomer={};
        revenueData?.forEach(s=>{const amt=Number(s.total_amount||0);totalRevenue+=amt;spendByCustomer[s.customer_id]=(spendByCustomer[s.customer_id]||0)+amt;});
        const customerCount=Object.keys(spendByCustomer).length||1;
        document.getElementById('newCustomers').textContent=newCount||0;
        document.getElementById('returningCustomers').textContent=returning>0?returning:0;
        document.getElementById('newVsReturning').textContent=customerCount>0?`${Math.round((newCount/customerCount)*100)}% New â€¢ ${Math.round((returning/customerCount)*100)}% Returning`:"No customers in period";
        document.getElementById('clv').textContent=`KES ${fmtDec(totalRevenue/(newCount+returning||1))}`;
        document.getElementById('avgSpend').textContent=`KES ${fmtDec(totalRevenue/customerCount)}`;
    }

    async function renderPurchaseBehavior() {
        const range=await getDateRangeFilter(); if(!range) return;
        const {data:sales}=await getDB().from('sales').select('id,customer_id,created_at').gte('created_at',range.start).lte('created_at',range.end).order('created_at');
        if(!sales?.length){document.getElementById('purchaseFrequency').textContent="â€”";document.getElementById('timeBetweenPurchases').textContent="â€”";document.getElementById('productBundles').innerHTML="<li>No data available</li>";return;}
        const ordersByCustomer={};
        sales.forEach(s=>{if(!ordersByCustomer[s.customer_id])ordersByCustomer[s.customer_id]=[];ordersByCustomer[s.customer_id].push(new Date(s.created_at));});
        const frequencies=Object.values(ordersByCustomer).map(o=>o.length);
        const avgFrequency=frequencies.reduce((a,b)=>a+b,0)/frequencies.length||0;
        let totalDaysBetween=0,pairCount=0;
        Object.values(ordersByCustomer).forEach(dates=>{
            if(dates.length<2)return;
            dates.sort((a,b)=>a-b);
            for(let i=1;i<dates.length;i++){totalDaysBetween+=(dates[i]-dates[i-1])/86400000;pairCount++;}
        });
        document.getElementById('purchaseFrequency').textContent=avgFrequency.toFixed(1);
        document.getElementById('timeBetweenPurchases').textContent=Math.round(pairCount>0?totalDaysBetween/pairCount:0);
        document.getElementById('productBundles').innerHTML="<li>Advanced bundle analysis coming soon</li>";
    }

    async function renderCustomerSegmentation() {
        const {data:allSales}=await getDB().from('sales').select('customer_id,total_amount');
        if(!allSales?.length){['highSpenders','occasionalBuyers','atRiskCustomers'].forEach(id=>document.getElementById(id).textContent="No data");return;}
        const lifetimeByCustomer={};
        allSales.forEach(s=>{lifetimeByCustomer[s.customer_id]=(lifetimeByCustomer[s.customer_id]||0)+Number(s.total_amount||0);});
        const values=Object.values(lifetimeByCustomer).sort((a,b)=>b-a);
        const top15=values[Math.floor(values.length*0.15)]||0;
        let high=0,occ=0;
        values.forEach(v=>{if(v>=top15)high++;else if(v<3000)occ++;});
        document.getElementById('highSpenders').innerHTML=`${high} customers â€¢ top 15% â€¢ drive most revenue`;
        document.getElementById('occasionalBuyers').innerHTML=`${occ} customers â€¢ low spenders`;
        document.getElementById('atRiskCustomers').innerHTML="At-risk detection requires last purchase date â€” coming soon";
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PREDICTIVE INSIGHTS â€” fully wired to real Supabase data
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function renderPredictiveInsights() {
        const range = await getDateRangeFilter();
        if (!range) return;

        // show loading, hide content
        document.getElementById('aiLoading').style.display  = 'flex';
        document.getElementById('aiContent').style.display  = 'none';

        try {
            const db       = getDB();
            const shopId   = window.dataModule?.getCurrentShopId?.();
            const startD   = new Date(range.start);
            const endD     = new Date(range.end);
            const days     = Math.max(1, Math.round((endD - startD) / 86400000) + 1);

            // â”€â”€ Previous period (same length) for trend comparison â”€â”€
            const prevEnd   = new Date(startD); prevEnd.setDate(prevEnd.getDate() - 1);
            const prevStart = new Date(prevEnd); prevStart.setDate(prevStart.getDate() - days + 1);

            // â”€â”€ Parallel fetches â”€â”€
            const [
                salesRes,
                allSalesRes,
                saleItemsRes,
                productsRes,
                allCustSalesRes,
                prevSalesRes
            ] = await Promise.all([
                // Current-period sales
                db.from('sales')
                  .select('id,total_amount,total_profit,payment_method,items_sold,created_at,customer_id')
                  .gte('created_at', range.start).lte('created_at', range.end),

                // Last-90-days sales for day/hour patterns
                db.from('sales')
                  .select('created_at,total_amount')
                  .gte('created_at', new Date(Date.now()-90*86400000).toISOString()),

                // Sale items â†’ restock + bundle analysis
                db.from('sale_items')
                  .select('sale_id,product_id,quantity,products(id,name,stock)')
                  .gte('created_at', range.start).lte('created_at', range.end),

                // Products for restock stock levels
                shopId
                    ? db.from('products').select('id,name,stock').eq('shop_id', shopId)
                    : db.from('products').select('id,name,stock'),

                // All-time customer sales for churn
                db.from('sales').select('customer_id,created_at').order('created_at',{ascending:false}),

                // Previous-period sales for trend
                db.from('sales')
                  .select('total_amount')
                  .gte('created_at', prevStart.toISOString().split('T')[0]+' 00:00:00')
                  .lte('created_at', prevEnd.toISOString().split('T')[0]+' 23:59:59')
            ]);

            const sales        = salesRes.data         || [];
            const allSales     = allSalesRes.data       || [];
            const saleItems    = saleItemsRes.data      || [];
            const products     = productsRes.data       || [];
            const allCustSales = allCustSalesRes.data   || [];
            const prevSales    = prevSalesRes.data      || [];

            const totalRev  = sales.reduce((s,x) => s + Number(x.total_amount||0), 0);
            const totalProf = sales.reduce((s,x) => s + Number(x.total_profit||0), 0);
            const prevRev   = prevSales.reduce((s,x) => s + Number(x.total_amount||0), 0);

            /* â”€â”€â”€ â‘  REVENUE FORECAST â”€â”€â”€ */
            const avgDaily   = totalRev / days;
            const forecast7  = avgDaily * 7;
            const trendPct   = prevRev > 0 ? ((totalRev - prevRev) / prevRev * 100) : 0;
            const trendDir   = trendPct >=  2 ? 'up' : trendPct <= -2 ? 'down' : 'flat';
            const trendArrow = trendPct >=  2 ? 'â†‘' : trendPct <= -2 ? 'â†“' : 'â†’';
            const trendClass = trendDir === 'up' ? 'trend-up' : trendDir === 'down' ? 'trend-down' : 'trend-flat';
            const barColor   = trendDir === 'up' ? 'var(--accent-green)' : trendDir === 'down' ? 'var(--danger)' : 'var(--accent-orange)';
            const barPct     = Math.min(100, Math.round((forecast7 / (totalRev * 1.2 || 1)) * 100));

            setText('ai_forecast7', `KES ${fmt(forecast7)}`);
            setClass('ai_forecast7', `ai-kpi-value ${trendDir==='up'?'green':trendDir==='down'?'red':'orange'}`);
            document.getElementById('ai_forecastBar').style.width = barPct + '%';
            document.getElementById('ai_forecastBar').style.background = barColor;
            set('ai_forecastSub', `<span class="trend-chip ${trendClass}">${trendArrow} ${Math.abs(trendPct).toFixed(1)}% vs prev ${days}-day period</span> &nbsp; Avg/day: KES ${fmt(avgDaily)}`);

            setText('ai_avgDaily', `KES ${fmt(avgDaily)}`);
            setText('ai_avgDailySub', `Over ${days} day${days!==1?'s':''}`);

            // Day-of-week & hour patterns (90-day window)
            const dayTotals=Array(7).fill(0), dayCounts=Array(7).fill(0);
            const hourTotals=Array(24).fill(0), hourCounts=Array(24).fill(0);
            allSales.forEach(s=>{
                const d=new Date(s.created_at);
                const amt=Number(s.total_amount||0);
                dayTotals[d.getDay()]+=amt; dayCounts[d.getDay()]++;
                hourTotals[d.getHours()]+=amt; hourCounts[d.getHours()]++;
            });
            const dayAvg  = dayTotals.map((t,i)=>dayCounts[i]>0?t/dayCounts[i]:0);
            const hourAvg = hourTotals.map((t,i)=>hourCounts[i]>0?t/hourCounts[i]:0);
            const bestDayIdx  = dayAvg.indexOf(Math.max(...dayAvg));
            const bestHourIdx = hourAvg.indexOf(Math.max(...hourAvg));
            const dayNames=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

            setText('ai_bestDay', dayNames[bestDayIdx] || 'â€”');
            setText('ai_bestDaySub', `Avg KES ${fmt(dayAvg[bestDayIdx])} revenue`);
            setText('ai_bestHour', `${String(bestHourIdx).padStart(2,'0')}:00 â€“ ${String(bestHourIdx+1).padStart(2,'0')}:00`);
            setText('ai_bestHourSub', `Avg KES ${fmt(hourAvg[bestHourIdx])} in that window`);

            /* â”€â”€â”€ â‘¡ RESTOCK â”€â”€â”€ */
            const velocity = {};
            saleItems.forEach(item => {
                if (!item.product_id) return;
                if (!velocity[item.product_id]) {
                    velocity[item.product_id] = {
                        name: item.products?.name || `#${item.product_id}`,
                        sold: 0,
                        stock: item.products?.stock ?? null
                    };
                }
                velocity[item.product_id].sold += Number(item.quantity || 0);
            });
            // Override stock from products table where available
            products.forEach(p => { if (velocity[p.id]) velocity[p.id].stock = p.stock; });

            const restockRows = Object.values(velocity)
                .filter(p => p.sold > 0)
                .map(p => {
                    const dailyV = p.sold / days;
                    const daysLeft = (dailyV > 0 && p.stock !== null) ? Math.floor(p.stock / dailyV) : 9999;
                    return { ...p, dailyV, daysLeft };
                })
                .sort((a,b) => a.daysLeft - b.daysLeft)
                .slice(0, 8);

            if (!restockRows.length) {
                set('ai_restockList', '<div class="ai-list-item"><span class="ai-icon">âœ…</span><div class="ai-item-main"><div class="ai-item-name">No restock needed</div><div class="ai-item-sub">All products have sufficient stock for this period</div></div></div>');
            } else {
                set('ai_restockList', restockRows.map(p => {
                    let icon, badgeCls, badgeTxt;
                    if      (p.daysLeft <= 3)  { icon='ğŸ”´'; badgeCls='badge-red';    badgeTxt='Critical'; }
                    else if (p.daysLeft <= 7)  { icon='ğŸŸ '; badgeCls='badge-orange'; badgeTxt='Low'; }
                    else if (p.daysLeft <= 14) { icon='ğŸŸ¡'; badgeCls='badge-orange'; badgeTxt='Watch'; }
                    else                       { icon='ğŸŸ¢'; badgeCls='badge-green';  badgeTxt='OK'; }
                    const stockTxt = p.stock !== null ? `${p.stock} units left` : 'stock unknown';
                    const daysLeftTxt = p.daysLeft === 9999 ? 'âˆ' : p.daysLeft;
                    return `<div class="ai-list-item">
                        <span class="ai-icon">${icon}</span>
                        <div class="ai-item-main">
                            <div class="ai-item-name">${p.name}<span class="ai-badge ${badgeCls}">${badgeTxt}</span></div>
                            <div class="ai-item-sub">${p.sold} sold Â· ~${p.dailyV.toFixed(1)}/day Â· ${stockTxt} Â· ~${daysLeftTxt} days stock remaining</div>
                        </div>
                    </div>`;
                }).join(''));
            }

            /* â”€â”€â”€ â‘¢ BUNDLE / CROSS-SELL â”€â”€â”€ */
            const saleProductMap = {};
            saleItems.forEach(item => {
                if (!item.sale_id || !item.product_id) return;
                if (!saleProductMap[item.sale_id]) saleProductMap[item.sale_id] = [];
                saleProductMap[item.sale_id].push({ id: item.product_id, name: item.products?.name || `#${item.product_id}` });
            });
            const pairCounts = {};
            Object.values(saleProductMap).forEach(prods => {
                if (prods.length < 2) return;
                for (let i=0;i<prods.length;i++) for (let j=i+1;j<prods.length;j++) {
                    const key = [prods[i].id, prods[j].id].sort().join('|');
                    if (!pairCounts[key]) pairCounts[key] = { a: prods[i].name, b: prods[j].name, count: 0 };
                    pairCounts[key].count++;
                }
            });
            const topPairs = Object.values(pairCounts).sort((x,y)=>y.count-x.count).slice(0,6);

            if (!topPairs.length) {
                set('ai_bundleList', '<div class="ai-list-item"><span class="ai-icon">â„¹ï¸</span><div class="ai-item-main"><div class="ai-item-name">Not enough multi-item transactions yet</div><div class="ai-item-sub">Encourage customers to buy more per visit to unlock bundle insights</div></div></div>');
            } else {
                set('ai_bundleList', topPairs.map(p =>
                    `<div class="ai-list-item">
                        <span class="ai-icon">ğŸ›’</span>
                        <div class="ai-item-main">
                            <div class="ai-item-name">${p.a} <span style="color:var(--text-muted);font-weight:400;">+</span> ${p.b}<span class="ai-badge badge-blue">${p.count}Ã—</span></div>
                            <div class="ai-item-sub">Bought together ${p.count} time${p.count!==1?'s':''} â€” consider bundling or cross-promoting</div>
                        </div>
                    </div>`
                ).join(''));
            }

            /* â”€â”€â”€ â‘£ MARGIN â”€â”€â”€ */
            const marginPct = totalRev > 0 ? (totalProf / totalRev * 100) : 0;
            const marginCls = marginPct >= 30 ? 'green' : marginPct >= 15 ? 'orange' : 'red';

            setText('ai_margin', `${marginPct.toFixed(1)}%`);
            setClass('ai_margin', `ai-kpi-value ${marginCls}`);
            setText('ai_marginSub', marginPct >= 30 ? 'âœ… Healthy â€” above 30%' : marginPct >= 15 ? 'âš ï¸ Moderate â€” aim for 30%+' : 'ğŸš¨ Low â€” review pricing or costs');

            // Day-level margin
            const byDate = {};
            sales.forEach(s => {
                const d = s.created_at.split('T')[0];
                if (!byDate[d]) byDate[d] = {rev:0, profit:0};
                byDate[d].rev    += Number(s.total_amount||0);
                byDate[d].profit += Number(s.total_profit||0);
            });
            const dateEntries = Object.entries(byDate)
                .map(([date,v]) => ({date, margin: v.rev>0 ? v.profit/v.rev*100 : 0, ...v}));
            const lowMarginDays = dateEntries.filter(d => d.margin < 20 && d.rev > 0);
            const sortedByMargin = [...dateEntries].sort((a,b)=>b.margin-a.margin);
            const bestMarginDay  = sortedByMargin[0];

            setText('ai_lowMarginDays', String(lowMarginDays.length));
            setClass('ai_lowMarginDays', `ai-kpi-value ${lowMarginDays.length > 0 ? 'red' : 'green'}`);
            setText('ai_lowMarginSub', lowMarginDays.length > 0
                ? `Recent: ${lowMarginDays.slice(0,2).map(d=>`${d.date} (${d.margin.toFixed(0)}%)`).join(', ')}`
                : 'All days above 20% âœ…');

            if (bestMarginDay) {
                setText('ai_bestMarginDay', new Date(bestMarginDay.date).toLocaleDateString('en-KE',{weekday:'short',month:'short',day:'numeric'}));
                setText('ai_bestMarginDaySub', `${bestMarginDay.margin.toFixed(1)}% margin Â· KES ${fmt(bestMarginDay.rev)} rev`);
            }

            // Margin alert box
            let alertHtml = '';
            if (marginPct < 10) {
                alertHtml = `<div class="ai-alert bad">ğŸš¨ <strong>Critical margin warning:</strong> Overall margin is ${marginPct.toFixed(1)}%. Review cost prices and selling prices immediately.</div>`;
            } else if (lowMarginDays.length >= Math.ceil(days * 0.4)) {
                alertHtml = `<div class="ai-alert warn">âš ï¸ <strong>Frequent low-margin days:</strong> ${lowMarginDays.length} out of ${dateEntries.length} trading days had margin below 20%. Consider reviewing discounts or high-cost products.</div>`;
            } else if (marginPct >= 35) {
                alertHtml = `<div class="ai-alert good">âœ… <strong>Excellent margins!</strong> ${marginPct.toFixed(1)}% average â€” your pricing strategy is working well. Keep it up.</div>`;
            }
            set('ai_marginAlert', alertHtml);

            /* â”€â”€â”€ â‘¤ CHURN RISK â”€â”€â”€ */
            const lastPurchase = {};
            allCustSales.forEach(s => {
                if (!s.customer_id) return;
                const d = new Date(s.created_at);
                if (!lastPurchase[s.customer_id] || d > lastPurchase[s.customer_id]) lastPurchase[s.customer_id] = d;
            });
            const churnCandidates = Object.entries(lastPurchase)
                .map(([id, d]) => ({ id, daysSince: Math.round((Date.now()-d.getTime())/86400000) }))
                .filter(c => c.daysSince >= 30 && c.daysSince <= 180)
                .sort((a,b) => b.daysSince - a.daysSince)
                .slice(0, 6);

            if (!churnCandidates.length) {
                set('ai_churnList', '<div class="ai-list-item"><span class="ai-icon">âœ…</span><div class="ai-item-main"><div class="ai-item-name">No at-risk customers detected</div><div class="ai-item-sub">All recent buyers are within the 30-day window</div></div></div>');
            } else {
                const custIds = churnCandidates.map(c => c.id);
                const {data: custData} = await db.from('customers').select('id,name,phone').in('id', custIds);
                const custMap = {};
                (custData||[]).forEach(c => { custMap[c.id] = c; });

                set('ai_churnList', churnCandidates.map(c => {
                    const cust = custMap[c.id];
                    const badgeCls = c.daysSince >= 90 ? 'badge-red' : 'badge-orange';
                    const badgeTxt = c.daysSince >= 90 ? 'High Risk' : c.daysSince >= 60 ? 'Med Risk' : 'Watch';
                    return `<div class="ai-list-item">
                        <span class="ai-icon">ğŸ‘¤</span>
                        <div class="ai-item-main">
                            <div class="ai-item-name">${cust?.name||`Customer #${c.id}`}<span class="ai-badge ${badgeCls}">${badgeTxt}</span></div>
                            <div class="ai-item-sub">Last purchase: ${c.daysSince} days ago${cust?.phone?' Â· '+cust.phone:''} â€” consider a win-back offer</div>
                        </div>
                    </div>`;
                }).join(''));
            }

            /* â”€â”€â”€ â‘¥ PAYMENT INSIGHTS â”€â”€â”€ */
            const pmCounts = {}, pmRevenue = {};
            sales.forEach(s => {
                const pm = s.payment_method || 'Unknown';
                pmCounts[pm]   = (pmCounts[pm]||0) + 1;
                pmRevenue[pm]  = (pmRevenue[pm]||0) + Number(s.total_amount||0);
            });
            const topPM = Object.entries(pmCounts).sort(([,a],[,b])=>b-a)[0];
            const creditRev = pmRevenue['Credit'] || pmRevenue['credit'] || 0;
            const avgTx     = sales.length > 0 ? totalRev / sales.length : 0;
            const prevAvgTx = prevSales.length > 0 ? prevSales.reduce((s,x)=>s+Number(x.total_amount||0),0) / prevSales.length : 0;
            const txTrend   = prevAvgTx > 0 ? ((avgTx - prevAvgTx) / prevAvgTx * 100) : 0;

            setText('ai_topPayment', topPM ? topPM[0] : 'â€”');
            setText('ai_topPaymentSub', topPM ? `${topPM[1]} transactions (${Math.round(topPM[1]/sales.length*100)}% of sales)` : 'No data');
            setText('ai_avgTx', `KES ${fmt(avgTx)}`);
            setText('ai_avgTxSub', prevAvgTx > 0 ? `${txTrend>=0?'â†‘':'â†“'} ${Math.abs(txTrend).toFixed(1)}% vs prev period` : 'No prev period data');
            setText('ai_credit', `KES ${fmt(creditRev)}`);
            setText('ai_creditSub', creditRev > 0 ? `${pmCounts['Credit']||pmCounts['credit']||0} credit txns â€” follow up on collections` : 'No credit sales âœ…');
            setClass('ai_credit', `ai-kpi-value ${creditRev > 0 ? 'orange' : 'green'}`);

            /* â”€â”€â”€ Done â”€â”€â”€ */
            document.getElementById('aiTimestamp').textContent = `Updated ${new Date().toLocaleTimeString('en-KE',{hour:'2-digit',minute:'2-digit'})}`;
            document.getElementById('aiLoading').style.display = 'none';
            document.getElementById('aiContent').style.display = 'block';

        } catch (err) {
            console.error('AI Insights error:', err);
            document.getElementById('aiLoading').innerHTML = `<span style="color:var(--danger)">âš ï¸ Failed to load insights: ${err.message}</span>`;
        }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       MAIN DASHBOARD LOADER  (unchanged structure)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    (function() {
        let revenueChart, topProductsChart, expensesByCashierChart;

        function waitFor(getter, cb, interval=300, max=40) {
            let n=0; const t=setInterval(()=>{if(getter()){clearInterval(t);cb();}else if(++n>=max)clearInterval(t);},interval);
        }

        window.addEventListener('DOMContentLoaded', async () => {
            try {
                await window.DukaPOS.initializeSupabase();
                _db = window.DukaPOS.supabaseClient;
                const isAuthenticated = await authModule.requireAuth();
                if (!isAuthenticated) return;
                const currentUser = authModule.getCurrentUser();
                if (!currentUser) return;
                const userRole = (currentUser.role||'').trim().toLowerCase();
                const isAdmin = ['administrator','admin','superadmin','manager'].includes(userRole);
                if (!isAdmin) { window.location.replace(userRole==='supplier'?'suppliers.html':'pos.html'); return; }
                _initRejectionStore(currentUser.id);
                document.body.style.visibility = 'visible';
                document.getElementById('currentUserName').textContent = currentUser.full_name||'User';
                setNavigationVisibility(userRole);
                setDateRange('month');
                await loadDashboard();
                updateBellBadge();
                setInterval(updateBellBadge, 30000);
                waitFor(()=>window.messagingModule, ()=>{ loadUsersForMessaging(); loadSentMessages(); });
                setTimeout(()=>loadSupplierOrders(), 500);
            } catch(err) {
                console.error('Dashboard init failed:', err);
                document.getElementById('recentTransactions').innerHTML=`<tr><td colspan="6" class="error-message">Failed to load dashboard: ${err.message}</td></tr>`;
            }
        });

        window.setDateRange = function(range) {
            const today=new Date(); let start=new Date(today);
            if(range==='today') start=today;
            else if(range==='week') start.setDate(today.getDate()-7);
            else start.setDate(today.getDate()-30);
            document.getElementById('startDate').value=start.toISOString().split('T')[0];
            document.getElementById('endDate').value=today.toISOString().split('T')[0];
            loadDashboard();
        };

        async function loadDashboard() {
            const start=document.getElementById('startDate').value;
            const end=document.getElementById('endDate').value;
            if(!start||!end){alert('Please select both start and end dates');return;}
            try {
                const result=await window.salesAnalytics.getSalesByCashier(null,start,end);
                if(!result.success) throw new Error(result.error||'Failed to load sales data');
                const sales=result.sales||[];
                const expensesResult=await window.dataModule.getExpensesByDateRange(start,end);
                const expenses=expensesResult.success?(expensesResult.data||[]):[];
                const totalExpenses=expenses.reduce((s,e)=>s+parseFloat(e.amount||0),0);
                const expensesByCashier=expenses.reduce((acc,exp)=>{
                    const name=exp.cashier?.full_name||exp.users?.full_name||exp.created_by?.full_name||'Unknown Cashier';
                    acc[name]=(acc[name]||0)+parseFloat(exp.amount||0); return acc;
                },{});

                document.getElementById('infoBox').style.display=(sales.length===0&&expenses.length===0)?'block':'none';
                if(sales.length===0&&expenses.length===0) document.getElementById('infoText').textContent='No sales or expenses found in this period.';

                const grossProfit=sales.reduce((s,x)=>s+(x.total_profit||0),0);
                const netProfit=grossProfit-totalExpenses;

                document.getElementById('totalRevenue').textContent=`KES ${fmtDec(sales.reduce((s,x)=>s+(x.total_amount||0),0))}`;
                document.getElementById('totalProfit').textContent=`KES ${fmtDec(netProfit)}`;
                document.getElementById('totalExpenses').textContent=`KES ${fmtDec(totalExpenses)}`;
                document.getElementById('transactionCount').textContent=sales.length;
                document.getElementById('itemsSold').textContent=sales.reduce((s,x)=>s+(x.items_sold||0),0);
                document.getElementById('profitBreakdown').textContent=`Gross: KES ${fmtDec(grossProfit)} - Exp: KES ${fmtDec(totalExpenses)}`;

                if(sales.length>0){
                    const top=sales.reduce((m,s)=>(s.total_profit||0)>(m.total_profit||0)?s:m,sales[0]);
                    document.getElementById('topPerformerName').textContent=top.users?.full_name||'Unknown';
                    document.getElementById('topPerformerProfit').textContent=fmtDec(top.total_profit||0);
                    document.getElementById('topCashier').style.display='block';
                } else document.getElementById('topCashier').style.display='none';

                renderCashierChart(sales);
                renderExpensesByCashierChart(expensesByCashier);
                renderTopProductsChart(sales);
                renderRecentTransactions(sales.slice(0,10));

                await renderHeatmapAndInsights();
                await renderCustomerOverview();
                await renderPurchaseBehavior();
                await renderCustomerSegmentation();
                await renderPredictiveInsights();

            } catch(err) {
                console.error('Dashboard load failed:', err);
                document.getElementById('recentTransactions').innerHTML=`<tr><td colspan="6" class="error-message">${err.message}</td></tr>`;
            }
        }

        function renderCashierChart(sales) {
            const canvas=document.getElementById('cashierChart'); const empty=document.getElementById('cashierChartEmpty');
            if(!sales.length){canvas.style.display='none';empty.style.display='block';if(revenueChart)revenueChart.destroy();return;}
            canvas.style.display='block';empty.style.display='none';
            if(revenueChart)revenueChart.destroy();
            const byCashier=sales.reduce((acc,s)=>{const name=s.users?.full_name||'Unknown';if(!acc[name])acc[name]={revenue:0,profit:0};acc[name].revenue+=s.total_amount||0;acc[name].profit+=s.total_profit||0;return acc;},{});
            const labels=Object.keys(byCashier);
            revenueChart=new Chart(canvas.getContext('2d'),{type:'bar',data:{labels,datasets:[{label:'Revenue (KES)',data:labels.map(k=>byCashier[k].revenue),backgroundColor:'rgba(63,185,80,0.65)'},{label:'Profit (KES)',data:labels.map(k=>byCashier[k].profit),backgroundColor:'rgba(245,158,11,0.65)'}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}});
        }

        function renderExpensesByCashierChart(expensesByCashier) {
            const canvas=document.getElementById('expensesByCashierChart'); const empty=document.getElementById('expensesChartEmpty'); const topDiv=document.getElementById('topSpender');
            if(!Object.keys(expensesByCashier).length||Object.values(expensesByCashier).every(v=>v===0)){canvas.style.display='none';empty.style.display='block';topDiv.style.display='none';if(expensesByCashierChart)expensesByCashierChart.destroy();return;}
            canvas.style.display='block';empty.style.display='none';
            if(expensesByCashierChart)expensesByCashierChart.destroy();
            const labels=Object.keys(expensesByCashier); const values=labels.map(k=>expensesByCashier[k]);
            expensesByCashierChart=new Chart(canvas.getContext('2d'),{type:'bar',data:{labels,datasets:[{label:'Expenses (KES)',data:values,backgroundColor:'rgba(248,81,73,0.65)',borderColor:'rgba(248,81,73,0.9)',borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}},plugins:{legend:{display:false}}}});
            if(values.length>0){const mi=values.indexOf(Math.max(...values));document.getElementById('topSpenderName').textContent=labels[mi];document.getElementById('topSpenderAmount').textContent=fmtDec(values[mi]);topDiv.style.display='block';}
            else topDiv.style.display='none';
        }

        function renderTopProductsChart(sales) {
            const canvas=document.getElementById('topProductsChart'); const empty=document.getElementById('productsChartEmpty');
            const totals=sales.reduce((acc,sale)=>{(sale.sale_items||[]).forEach(item=>{const name=item.products?.name||`Item #${item.product_id}`;acc[name]=(acc[name]||0)+(item.subtotal||item.unit_price*item.quantity||0);});return acc;},{});
            const top5=Object.entries(totals).sort(([,a],[,b])=>b-a).slice(0,5);
            if(!top5.length){canvas.style.display='none';empty.style.display='block';if(topProductsChart)topProductsChart.destroy();return;}
            canvas.style.display='block';empty.style.display='none';
            if(topProductsChart)topProductsChart.destroy();
            topProductsChart=new Chart(canvas.getContext('2d'),{type:'doughnut',data:{labels:top5.map(([n])=>n),datasets:[{data:top5.map(([,v])=>v),backgroundColor:['#3fb950','#f59e0b','#58a6ff','#f85149','#a78bfa']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}}}});
        }

        function renderRecentTransactions(transactions) {
            const tbody=document.getElementById('recentTransactions');
            if(!transactions.length){tbody.innerHTML=`<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">ğŸ’°</div><h3>No Recent Transactions</h3></td></tr>`;return;}
            tbody.innerHTML=transactions.map(tx=>`<tr><td>${new Date(tx.created_at).toLocaleString()}</td><td>${tx.users?.full_name||'â€”'}</td><td>KES ${fmtDec(tx.total_amount||0)}</td><td>KES ${fmtDec(tx.total_profit||0)}</td><td>${tx.items_sold||'â€”'}</td><td>${tx.payment_method||'â€”'}</td></tr>`).join('');
        }

        window.loadDashboard = loadDashboard;
    })();

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       EXPORT CSV
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function exportAnalyticsToCSV() {
        const headers="Metric,Value\n";
        const rows=[
            "Total Revenue,"+document.getElementById('totalRevenue').textContent.replace('KES ',''),
            "Net Profit,"+document.getElementById('totalProfit').textContent.replace('KES ',''),
            "CLV,"+document.getElementById('clv').textContent.replace('KES ',''),
            "Avg Spend,"+document.getElementById('avgSpend').textContent.replace('KES ',''),
            "Best Time Slots,"+document.getElementById('topSlots').textContent,
            "Predicted Next 7 Days,"+document.getElementById('ai_forecast7').textContent.replace('KES ',''),
            "Avg Profit Margin,"+document.getElementById('ai_margin').textContent,
            "Top Payment Method,"+document.getElementById('ai_topPayment').textContent,
            "Avg Transaction Value,"+document.getElementById('ai_avgTx').textContent.replace('KES ','')
        ].join("\n");
        const blob=new Blob([headers+rows],{type:'text/csv;charset=utf-8;'});
        const url=URL.createObjectURL(blob);
        const link=document.createElement("a");
        link.setAttribute("href",url);
        link.setAttribute("download",`analytics_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);link.click();document.body.removeChild(link);
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       SUPPLIER ORDERS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    async function loadSupplierOrders() {
        if(!window.supplierOrdersModule) return;
        try {
            const result=await window.supplierOrdersModule.getAllOrders();
            if(!result.success||!result.data){document.getElementById('supplierOrdersList').innerHTML=`<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><h3>Failed to load orders</h3><p>${result.error||'Unknown error'}</p></div>`;return;}
            const orders=result.data;
            document.getElementById('pendingOrdersCount').textContent=orders.filter(o=>o.status==='pending').length;
            document.getElementById('processingOrdersCount').textContent=orders.filter(o=>['processing','shipped'].includes(o.status)).length;
            document.getElementById('deliveredOrdersCount').textContent=orders.filter(o=>o.status==='delivered').length;
            document.getElementById('totalOrdersValue').textContent=`KES ${orders.reduce((s,o)=>s+(o.total_amount||0),0).toLocaleString()}`;
            if(!orders.length){document.getElementById('supplierOrdersList').innerHTML=`<div class="empty-state"><div class="empty-state-icon">ğŸ“¦</div><h3>No Supplier Orders Yet</h3></div>`;return;}
            document.getElementById('supplierOrdersList').innerHTML=orders.map(order=>`
                <div class="supplier-order-card">
                    <div class="order-card-header">
                        <div><div class="order-id">#${order.id}</div><div style="color:var(--text-muted);font-size:0.88rem;margin-top:4px;">${order.suppliers?.name||'Unknown Supplier'}</div></div>
                        <span class="status-badge status-${order.status}">${order.status.toUpperCase()}</span>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;margin-bottom:14px;">
                        <div><div style="font-size:0.8rem;color:var(--text-muted);">Order Date</div><div style="font-weight:600;font-size:0.9rem;">${new Date(order.created_at).toLocaleDateString()}</div></div>
                        <div><div style="font-size:0.8rem;color:var(--text-muted);">Expected Delivery</div><div style="font-weight:600;font-size:0.9rem;">${order.expected_delivery?new Date(order.expected_delivery).toLocaleDateString():'â€”'}</div></div>
                        <div><div style="font-size:0.8rem;color:var(--text-muted);">Total Amount</div><div style="font-weight:600;color:var(--accent-green);font-size:0.9rem;">KES ${(order.total_amount||0).toLocaleString()}</div></div>
                        <div><div style="font-size:0.8rem;color:var(--text-muted);">Items</div><div style="font-weight:600;font-size:0.9rem;">${order.supplier_order_items?.length||0} items</div></div>
                    </div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button class="btn btn-small btn-secondary" onclick="viewOrderDetails(${order.id})">View Details</button>
                        <button class="btn btn-small btn-primary" onclick="messageSupplier(${order.supplier_id})">ğŸ’¬ Message</button>
                    </div>
                </div>`).join('');
        } catch(err) { document.getElementById('supplierOrdersList').innerHTML=`<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><h3>Error</h3><p>${err.message}</p></div>`; }
    }
    window.createNewSupplierOrder=()=>alert('Create New Supplier Order â€” Coming soon');
    window.viewOrderDetails=(id)=>alert(`View details for order #${id}`);
    window.messageSupplier=(id)=>alert(`Message supplier #${id}`);

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       MESSAGING
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    async function loadUsersForMessaging() {
        try {
            const result=await window.messagingModule.getUsersForMessaging();
            if(!result.success) return;
            const select=document.getElementById('messageRecipient');
            select.innerHTML='<option value="">-- Select a user --</option>';
            result.data.forEach(user=>{const opt=document.createElement('option');opt.value=user.id;opt.textContent=`${user.full_name} (${user.role})`;select.appendChild(opt);});
        } catch(err){console.error('Load users error:',err);}
    }

    async function sendMessageToUser() {
        const recipientId=document.getElementById('messageRecipient').value;
        const messageText=document.getElementById('messageText').value.trim();
        if(!recipientId||!messageText) return alert('Select recipient and enter message');
        const btn=document.getElementById('sendMessageBtn');
        btn.disabled=true;btn.textContent='Sendingâ€¦';
        try {
            const result=await window.messagingModule.sendMessage(parseInt(recipientId),messageText);
            if(result.success){alert('âœ… Message sent!');document.getElementById('messageRecipient').value='';document.getElementById('messageText').value='';loadSentMessages();}
            else alert('Failed: '+result.error);
        } catch(err){alert('Error: '+err.message);}
        finally{btn.disabled=false;btn.textContent='ğŸ“¤ Send Message';}
    }

    async function loadSentMessages() {
        const tbody=document.getElementById('sentMessagesTable');
        try {
            const result=await window.messagingModule.getSentMessages(20);
            if(!result.success||!result.data?.length){tbody.innerHTML=`<tr><td colspan="5" class="empty-state"><p>No sent messages yet</p></td></tr>`;return;}
            tbody.innerHTML=result.data.map(msg=>{
                const hoursLeft=Math.round((new Date(msg.expires_at)-new Date())/3600000);
                return `<tr>
                    <td>${msg.recipient?.full_name||'Unknown'}</td>
                    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${msg.message_text||'(empty)'}</td>
                    <td>${new Date(msg.created_at).toLocaleString()}</td>
                    <td><span style="color:${msg.is_read?'#3fb950':'#f59e0b'}">${msg.is_read?'âœ… Read':'â³ Unread'}</span></td>
                    <td>${hoursLeft>0?hoursLeft+'h':'Expired'}</td>
                </tr>`;
            }).join('');
        } catch(err){console.error('Load sent error:',err);}
    }
    </script>

    <footer style="text-align:center;padding:15px;background-color:black;">
        <p>&copy; <span id="year"></span><b style="color:gold;"> G&H </b>Solutions by <b style="color:gold;font-family:'Courier Prime',cursive;"> Gordon Onyango.</b> All rights reserved.</p>
    </footer>
    <script>document.getElementById("year").textContent = new Date().getFullYear();</script>
</body>
</html>