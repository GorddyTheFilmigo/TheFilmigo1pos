<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#f59e0b">
    <title>G&H Solutions</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TheFilmigo">
    <meta name="description" content="Multi-tenant Point of Sale system">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" sizes="192x192" href="/assets/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/icons/icon-192x192.png">
    <link rel="stylesheet" href="assets/offline-styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/nav-styles.css">
    <script src="assets/page-access-guard.js"></script>
    <script src="assets/nav-visibility-controller.js"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #1a2030;
            --border: #21262d;
            --text: #e6edf3;
            --text-muted: #8b949e;
            --accent-orange: #f59e0b;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --danger: #f85149;
            --accent-purple: #a371f7;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Archivo', sans-serif; background: var(--bg-primary); color: var(--text); }

        /* Message Notification */
        .message-notification-bell { position: relative; cursor: pointer; font-size: 1.5rem; padding: 8px 12px; border-radius: 8px; transition: background 0.2s; }
        .message-notification-bell:hover { background: rgba(88, 166, 255, 0.1); }
        .message-badge { position: absolute; top: 4px; right: 4px; background: #f85149; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; box-shadow: 0 0 0 2px var(--bg-primary); min-width: 20px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.08); } }
        .messages-popup { position: fixed; top: 70px; right: 20px; width: 400px; max-height: 500px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); z-index: 9999; display: none; flex-direction: column; }
        .messages-popup.active { display: flex; }
        .messages-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .messages-header h3 { margin: 0; font-size: 1.1rem; }
        .close-popup { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 6px; }
        .close-popup:hover { background: rgba(248,81,73,0.2); color: var(--danger); }
        .messages-list { flex: 1; overflow-y: auto; padding: 12px; max-height: 400px; }
        .message-item { background: rgba(88,166,255,0.1); border: 1px solid rgba(88,166,255,0.3); border-radius: 8px; padding: 14px; margin-bottom: 10px; }
        .message-item.unread { background: rgba(245,158,11,0.15); border-color: rgba(245,158,11,0.4); }
        .message-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; }
        .message-sender { font-weight: 700; color: var(--accent-orange); font-size: 0.95rem; }
        .message-time { font-size: 0.8rem; color: var(--text-muted); }
        .message-text { color: var(--text); line-height: 1.5; margin-bottom: 8px; font-size: 0.95rem; }
        .message-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
        .message-expiry { font-size: 0.75rem; color: var(--text-muted); font-style: italic; }
        .mark-read-btn { background: var(--accent-green); color: white; border: none; border-radius: 6px; padding: 6px 12px; font-size: 0.8rem; cursor: pointer; font-weight: 600; }
        .reply-btn { background: var(--accent-blue); color: white; border: none; border-radius: 6px; padding: 6px 12px; font-size: 0.8rem; cursor: pointer; font-weight: 600; }
        .empty-messages { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-messages-icon { font-size: 3rem; margin-bottom: 12px; }

        /* Tab Navigation */
        .pos-tabs { display: flex; gap: 10px; padding: 15px 20px; background: var(--bg-secondary); border-bottom: 2px solid var(--border); }
        .pos-tab-btn { padding: 12px 24px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text); cursor: pointer; font-weight: 600; font-size: 16px; transition: all 0.2s; }
        .pos-tab-btn:hover { border-color: var(--accent-orange); }
        .pos-tab-btn.active { background: var(--accent-orange); color: white; border-color: var(--accent-orange); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* POS Layout */
        .pos-container { display: grid; grid-template-columns: 1fr 420px; gap: 20px; padding: 20px; height: calc(100vh - 160px); }
        .products-section, .cart-section { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
        .products-section { overflow-y: auto; }
        .cart-section { display: flex; flex-direction: column; overflow-y: auto; height: 100%; }

        /* Customer Selector */
        .customer-selector { background: var(--bg-primary); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-bottom: 16px; }
        .customer-selector-label { font-size: 0.8rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; }
        .customer-select-row { display: flex; gap: 8px; align-items: center; }
        .customer-search-wrap { position: relative; flex: 1; }
        .customer-search-input { width: 100%; padding: 9px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; font-family: 'Archivo', sans-serif; }
        .customer-search-input:focus { outline: none; border-color: var(--accent-orange); }
        .customer-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-secondary); border: 1px solid var(--accent-orange); border-radius: 8px; max-height: 180px; overflow-y: auto; z-index: 100; margin-top: 4px; display: none; }
        .customer-dropdown.open { display: block; }
        .customer-option { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .customer-option:hover { background: rgba(245,158,11,0.1); }
        .customer-option:last-child { border-bottom: none; }
        .customer-opt-name { font-weight: 600; }
        .customer-opt-pts { font-size: 0.8rem; color: var(--accent-purple); margin-top: 2px; }
        .clear-customer-btn { background: var(--danger); color: white; border: none; border-radius: 8px; padding: 9px 12px; cursor: pointer; font-size: 13px; font-weight: 600; white-space: nowrap; }
        .selected-customer-card { background: rgba(163,113,247,0.1); border: 1px solid rgba(163,113,247,0.4); border-radius: 8px; padding: 10px 14px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        .selected-customer-info .cust-name { font-weight: 700; color: var(--accent-purple); font-size: 0.95rem; }
        .selected-customer-info .cust-pts { font-size: 0.82rem; color: var(--text-muted); margin-top: 2px; }
        .redeem-btn { background: var(--accent-purple); color: white; border: none; border-radius: 6px; padding: 6px 12px; font-size: 0.8rem; cursor: pointer; font-weight: 600; }
        .redeem-btn:hover { background: #8b5cf6; }
        .redeem-badge { background: rgba(163,113,247,0.2); border: 1px solid rgba(163,113,247,0.5); border-radius: 6px; padding: 6px 10px; margin-top: 8px; font-size: 0.82rem; color: var(--accent-purple); display: flex; justify-content: space-between; align-items: center; }
        .remove-redeem { background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1rem; font-weight: 700; }

        /* Products */
        .search-bar { width: 100%; padding: 12px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 16px; margin-bottom: 20px; }
        .categories { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .category-btn { padding: 10px 20px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text); cursor: pointer; font-weight: 600; white-space: nowrap; }
        .category-btn.active { background: var(--accent-orange); color: white; }
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .product-card { background: var(--bg-primary); border: 1px solid var(--border); border-radius: 10px; padding: 15px; cursor: pointer; transition: all 0.2s; text-align: center; }
        .product-card:hover { transform: translateY(-5px); border-color: var(--accent-orange); }
        .product-icon { width: 60px; height: 60px; margin: 0 auto 10px; font-size: 3rem; line-height: 60px; }
        .product-name { font-weight: 600; margin-bottom: 5px; }
        .product-price { color: var(--accent-orange); font-weight: 700; font-size: 1.2rem; }
        .product-stock { font-size: 0.85rem; color: var(--text-muted); margin-top: 5px; }

        /* Cart */
        .cart-header { margin-bottom: 12px; }
        .cart-items { overflow-y: visible; margin-bottom: 12px; }
        .cart-item { background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .cart-item-info { flex: 1; }
        .cart-item-name { font-weight: 600; margin-bottom: 5px; }
        .cart-item-price { color: var(--text-muted); font-size: 0.9rem; }
        .cart-item-controls { display: flex; align-items: center; gap: 10px; }
        .qty-btn { width: 30px; height: 30px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text); border-radius: 5px; cursor: pointer; font-weight: 700; }
        .qty-value { min-width: 30px; text-align: center; font-weight: 600; }
        .remove-btn { background: var(--danger); color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-weight: 600; }

        /* Cart Summary */
        .cart-summary { border-top: 2px solid var(--border); padding-top: 12px; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
        .summary-row.discount { color: var(--accent-purple); }
        .summary-total { font-size: 1.4rem; font-weight: 900; color: var(--accent-orange); }
        .loyalty-earn-note { font-size: 0.8rem; color: var(--accent-green); margin-bottom: 8px; text-align: center; background: rgba(63,185,80,0.1); border-radius: 6px; padding: 6px; }
        .payment-methods { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
        .payment-btn { padding: 10px; border: 2px solid var(--border); background: var(--bg-primary); color: var(--text); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; }
        .payment-btn.active { border-color: var(--accent-green); background: rgba(63,185,80,0.1); }
        .checkout-btn { width: 100%; padding: 14px; background: var(--accent-green); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; }
        .checkout-btn:disabled { background: var(--text-muted); cursor: not-allowed; }
        .empty-cart { text-align: center; padding: 40px 20px; color: var(--text-muted); }

        /* Expenses */
        .expenses-container { padding: 20px; max-width: 1400px; margin: 0 auto; }
        .expenses-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .add-expense-btn { padding: 12px 24px; background: var(--accent-green); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px; }
        .expenses-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
        .stat-label { font-size: 14px; color: var(--text-muted); margin-bottom: 10px; }
        .stat-value { font-size: 2rem; font-weight: 900; color: var(--danger); }
        .expenses-list { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
        .expense-item { background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .expense-info h4 { margin-bottom: 5px; font-size: 16px; }
        .expense-meta { font-size: 13px; color: var(--text-muted); }
        .expense-amount { font-size: 1.3rem; font-weight: 700; color: var(--danger); }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal.show { display: flex; }
        .modal-content { background: var(--bg-secondary); border: 2px solid var(--accent-green); border-radius: 12px; padding: 40px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { margin-bottom: 25px; }
        .modal-header h2 { font-size: 1.8rem; margin-bottom: 5px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 16px; font-family: 'Archivo', sans-serif; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .modal-actions { display: flex; gap: 10px; margin-top: 25px; }
        .modal-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 16px; }
        .modal-btn-primary { background: var(--accent-green); color: white; }
        .modal-btn-secondary { background: var(--danger); color: white; }
        .modal-icon { font-size: 4rem; margin-bottom: 20px; text-align: center; }

        /* Success modal loyalty section */
        .loyalty-earned { background: rgba(163,113,247,0.15); border: 1px solid rgba(163,113,247,0.4); border-radius: 8px; padding: 14px; margin: 16px 0; }
        .loyalty-earned-title { color: var(--accent-purple); font-weight: 700; margin-bottom: 4px; }
        .loyalty-earned-pts { font-size: 1.8rem; font-weight: 900; color: var(--accent-purple); }
        .loyalty-total { font-size: 0.85rem; color: var(--text-muted); margin-top: 4px; }

        /* Redeem Modal */
        .redeem-modal-content { border-color: var(--accent-purple); }
        .redeem-info { background: var(--bg-primary); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .redeem-info p { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 6px; }
        .redeem-available { font-size: 1.6rem; font-weight: 900; color: var(--accent-purple); }
        .redeem-conversion { font-size: 0.85rem; color: var(--text-muted); background: var(--bg-tertiary); border-radius: 6px; padding: 8px 12px; margin-bottom: 16px; }

        @media (max-width: 900px) {
            .pos-container { grid-template-columns: 1fr; height: auto; }
            .expenses-stats { grid-template-columns: 1fr; }
            .messages-popup { width: calc(100vw - 40px); right: 20px; max-height: 70vh; }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <div class="logo">G&H Solutions</div>
            <div class="nav-tabs">
                <a href="dashboard.html" class="nav-tab" id="dashboardLink" style="display:none;">Dashboard</a>
                <a href="pos.html" class="nav-tab active">Point of Sale</a>
                <a href="products.html" class="nav-tab">Products</a>
                <a href="inventory.html" class="nav-tab" id="inventoryLink" style="display:none;">Inventory</a>
                <a href="customers.html" class="nav-tab">Customers</a>
                <a href="admin.html" class="nav-tab" id="adminTab" style="display:none;">Users</a>
            </div>
            <div class="nav-right">
                <div class="user-badge">
                    <div class="user-avatar">ğŸ‘¤</div>
                    <div><div id="currentUserName">User</div></div>
                </div>
                <div class="message-notification-bell" onclick="toggleMessagesPopup()" id="messageBell">
                    ğŸ””
                    <span class="message-badge" id="messageBadge" style="display: none;">0</span>
                </div>
                <button onclick="authModule.logout()" style="padding:10px 18px;background-color:#ef4444;color:#ffffff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 4px 10px rgba(239,68,68,0.3);transition:all 0.2s ease;" onmouseover="this.style.backgroundColor='#dc2626';this.style.transform='translateY(-1px)'" onmouseout="this.style.backgroundColor='#ef4444';this.style.transform='translateY(0)'">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Messages Popup -->
    <div class="messages-popup" id="messagesPopup">
        <div class="messages-header">
            <h3>ğŸ“¨ Messages</h3>
            <button class="close-popup" onclick="toggleMessagesPopup()">Ã—</button>
        </div>
        <div class="messages-list" id="messagesList">
            <div class="empty-messages"><div class="empty-messages-icon">ğŸ“­</div><p>Loading messages...</p></div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="pos-tabs">
        <button class="pos-tab-btn active" onclick="switchTab('sales')">ğŸ’° Sales</button>
        <button class="pos-tab-btn" onclick="switchTab('expenses')">ğŸ’¸ Expenses</button>
    </div>

    <!-- Sales Tab -->
    <div id="salesTab" class="tab-content active">
        <div class="pos-container">
            <!-- Products Panel -->
            <div class="products-section">
                <input type="text" class="search-bar" id="searchInput" placeholder="ğŸ” Search products...">
                <div class="categories" id="categoriesContainer"></div>
                <div class="products-grid" id="productsGrid">
                    <div style="text-align:center;padding:40px;color:var(--text-muted);">Loading products...</div>
                </div>
            </div>

            <!-- Cart Panel -->
            <div class="cart-section">
                <div class="cart-header">
                    <h2>ğŸ›’ Shopping Cart</h2>
                </div>

                <!-- Customer Selector -->
                <div class="customer-selector">
                    <div class="customer-selector-label">ğŸ‘¤ Customer (optional â€” earns loyalty points)</div>
                    <div class="customer-select-row">
                        <div class="customer-search-wrap">
                            <input type="text" class="customer-search-input" id="customerSearchInput" placeholder="Search customer by name or phone..." autocomplete="off">
                            <div class="customer-dropdown" id="customerDropdown"></div>
                        </div>
                        <button class="clear-customer-btn" onclick="clearSelectedCustomer()">âœ• Clear</button>
                    </div>
                    <div id="selectedCustomerCard" style="display:none;"></div>
                    <div id="redeemBadge" style="display:none;"></div>
                </div>

                <div class="cart-items" id="cartItems">
                    <div class="empty-cart"><div style="font-size:3rem;margin-bottom:10px;">ğŸ›’</div><p>Cart is empty</p></div>
                </div>

                <div class="cart-summary">
                    <div class="summary-row"><span>Items:</span><span id="itemCount">0</span></div>
                    <div class="summary-row"><span>Subtotal:</span><span id="subtotalAmount">KES 0.00</span></div>
                    <div class="summary-row discount" id="discountRow" style="display:none;">
                        <span>ğŸ Loyalty Discount:</span>
                        <span id="discountAmount">- KES 0.00</span>
                    </div>
                    <div class="summary-row">
                        <strong>Total:</strong>
                        <strong class="summary-total" id="totalAmount">KES 0.00</strong>
                    </div>
                    <div class="loyalty-earn-note" id="loyaltyEarnNote" style="display:none;"></div>
                    <div class="payment-methods" style="margin-top:10px;">
                        <button class="payment-btn active" data-method="Cash">ğŸ’µ Cash</button>
                        <button class="payment-btn" data-method="M-Pesa">ğŸ“± M-Pesa</button>
                        <button class="payment-btn" data-method="Card">ğŸ’³ Card</button>
                        <button class="payment-btn" data-method="Credit">ğŸ“‹ Credit</button>
                    </div>
                    <button class="checkout-btn" id="checkoutBtn" disabled>Complete Sale</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Expenses Tab -->
    <div id="expensesTab" class="tab-content">
        <div class="expenses-container">
            <div class="expenses-header">
                <h1>ğŸ’¸ Expenses Tracking</h1>
                <button class="add-expense-btn" onclick="openAddExpenseModal()">â• Add Expense</button>
            </div>
            <div class="expenses-stats">
                <div class="stat-card"><div class="stat-label">ğŸ“… Today's Expenses</div><div class="stat-value" id="todayExpenses">KES 0.00</div></div>
                <div class="stat-card"><div class="stat-label">ğŸ“† This Week</div><div class="stat-value" id="weekExpenses">KES 0.00</div></div>
                <div class="stat-card"><div class="stat-label">ğŸ“Š This Month</div><div class="stat-value" id="monthExpenses">KES 0.00</div></div>
                <div class="stat-card"><div class="stat-label">ğŸ“ˆ This Year</div><div class="stat-value" id="yearExpenses">KES 0.00</div></div>
            </div>
            <div class="expenses-list">
                <h3 style="margin-bottom:20px;">Recent Expenses</h3>
                <div id="expensesList"><div style="text-align:center;padding:40px;color:var(--text-muted);">Loading expenses...</div></div>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div class="modal" id="addExpenseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Expense</h2>
                <p style="color:var(--text-muted);">Record a business expense</p>
            </div>
            <form id="expenseForm">
                <div class="form-group">
                    <label for="expenseCategory">Category *</label>
                    <select id="expenseCategory" required>
                        <option value="">Select category</option>
                        <option value="Rent">Rent</option>
                        <option value="Utilities">Utilities</option>
                        <option value="Salaries">Salaries</option>
                        <option value="Supplies">Supplies</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Transport">Transport</option>
                        <option value="Maintenance">Maintenance</option>
                        <option value="Insurance">Insurance</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="expenseAmount">Amount (KES) *</label>
                    <input type="number" id="expenseAmount" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="expenseDescription">Description *</label>
                    <textarea id="expenseDescription" required placeholder="What was this expense for?"></textarea>
                </div>
                <div class="form-group">
                    <label for="expenseDate">Date *</label>
                    <input type="date" id="expenseDate" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="modal-btn modal-btn-primary" id="saveExpenseBtn">Save Expense</button>
                    <button type="button" class="modal-btn modal-btn-secondary" onclick="closeAddExpenseModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Redeem Points Modal -->
    <div class="modal" id="redeemModal">
        <div class="modal-content redeem-modal-content" style="border-color:var(--accent-purple);">
            <div class="modal-header">
                <h2>ğŸ Redeem Loyalty Points</h2>
                <p style="color:var(--text-muted);">Apply a discount using loyalty points</p>
            </div>
            <div class="redeem-info">
                <p>Available points for <strong id="redeemCustomerName">â€”</strong>:</p>
                <div class="redeem-available" id="redeemAvailablePoints">0 pts</div>
            </div>
            <div class="redeem-conversion">ğŸ’¡ Conversion rate: <strong>10 points = KES 1 discount</strong></div>
            <div class="form-group">
                <label>Points to redeem</label>
                <input type="number" id="redeemPointsInput" min="10" step="10" placeholder="e.g. 100">
                <small style="color:var(--text-muted);margin-top:6px;display:block;" id="redeemEquivalent">= KES 0.00 discount</small>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-primary" style="background:var(--accent-purple);" onclick="applyRedemption()">Apply Discount</button>
                <button class="modal-btn modal-btn-secondary" onclick="closeRedeemModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal" id="successModal">
        <div class="modal-content" style="text-align:center;">
            <div class="modal-icon">âœ…</div>
            <h2 style="margin-bottom:10px;">Sale Complete!</h2>
            <p style="color:var(--text-muted);margin-bottom:10px;">Transaction processed successfully</p>
            <div style="font-size:2rem;font-weight:900;color:var(--accent-green);" id="saleTotal">KES 0.00</div>
            <div id="loyaltyEarnedSection" style="display:none;"></div>
            <button class="modal-btn modal-btn-primary" onclick="closeSuccessModal()" style="margin-top:20px;width:100%;">New Sale</button>
        </div>
    </div>

    <script src="assets/script.js"></script>
    <script src="assets/auth.js"></script>
    <script src="assets/nav-role-manager.js"></script>
    <script src="assets/data-module.js"></script>
    <script src="assets/messaging-module.js"></script>
    <script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // LOYALTY CONFIG
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const POINTS_PER_KES = 1;        // 1 point per KES spent
    const POINTS_TO_KES = 10;        // 10 points = KES 1 discount

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // MESSAGING
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let messagesCheckInterval = null;
    function toggleMessagesPopup() {
        const popup = document.getElementById('messagesPopup');
        if (popup.classList.contains('active')) { popup.classList.remove('active'); }
        else { popup.classList.add('active'); loadUserMessages(); }
    }
    document.addEventListener('click', function(e) {
        const popup = document.getElementById('messagesPopup');
        const bell = document.getElementById('messageBell');
        if (popup && bell && popup.classList.contains('active')) {
            if (!popup.contains(e.target) && !bell.contains(e.target)) popup.classList.remove('active');
        }
    });
    async function loadUserMessages() {
        try {
            const result = await window.messagingModule.getAllMessages(20);
            const list = document.getElementById('messagesList');
            if (!result.success || result.data.length === 0) {
                list.innerHTML = `<div class="empty-messages"><div class="empty-messages-icon">ğŸ“­</div><p>No messages</p></div>`;
                return;
            }
            list.innerHTML = result.data.map(msg => {
                const sentAt = new Date(msg.created_at);
                const expiresAt = new Date(msg.expires_at);
                const hoursLeft = Math.round((expiresAt - new Date()) / 3600000);
                const senderId = msg.sender?.id || 'unknown';
                return `<div class="message-item ${msg.is_read ? '' : 'unread'}">
                    <div class="message-header"><div class="message-sender">ğŸ‘¤ ${msg.sender?.full_name || 'Administrator'}</div><div class="message-time">${getTimeAgo(sentAt)}</div></div>
                    <div class="message-text">${escapeHtml(msg.message_text)}</div>
                    <div class="message-footer">
                        <div class="message-expiry">${hoursLeft > 0 ? `Expires in ${hoursLeft}h` : 'Expired'}</div>
                        <div>
                            ${!msg.is_read ? `<button class="mark-read-btn" onclick="markMessageRead(${msg.id})">âœ“ Mark as Read</button>` : ''}
                            <button class="reply-btn" onclick="replyToMessage(${senderId})">â†© Reply</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        } catch (err) { document.getElementById('messagesList').innerHTML = `<div class="empty-messages"><div class="empty-messages-icon">âš ï¸</div><p>Error loading messages</p></div>`; }
    }
    async function replyToMessage(senderId) {
        if (!senderId || senderId === 'unknown') { alert("Cannot reply â€” sender info missing."); return; }
        const replyText = prompt("Enter your reply:");
        if (!replyText?.trim()) return;
        const result = await window.messagingModule.sendMessage(senderId, replyText.trim());
        if (result.success) { alert("Reply sent!"); loadUserMessages(); updateUnreadCount(); }
        else alert("Failed to send reply: " + (result.error || "Unknown error"));
    }
    async function markMessageRead(messageId) {
        const result = await window.messagingModule.markAsRead(messageId);
        if (result.success) { loadUserMessages(); updateUnreadCount(); }
    }
    async function updateUnreadCount() {
        try {
            const result = await window.messagingModule.getUnreadCount();
            const badge = document.getElementById('messageBadge');
            const count = result.success ? (result.count || 0) : 0;
            badge.textContent = count > 99 ? '99+' : count;
            badge.style.display = count > 0 ? 'flex' : 'none';
        } catch { document.getElementById('messageBadge').style.display = 'none'; }
    }
    function getTimeAgo(date) {
        const s = Math.floor((new Date() - date) / 1000);
        if (s < 60) return 'Just now';
        if (s < 3600) return `${Math.floor(s/60)}m ago`;
        if (s < 86400) return `${Math.floor(s/3600)}h ago`;
        return `${Math.floor(s/86400)}d ago`;
    }
    function escapeHtml(text) { const d = document.createElement('div'); d.textContent = text; return d.innerHTML; }
    function initializeMessageNotifications() {
        updateUnreadCount();
        messagesCheckInterval = setInterval(updateUnreadCount, 30000);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // TAB SWITCHING
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function switchTab(tab) {
        document.querySelectorAll('.pos-tab-btn').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        if (tab === 'sales') {
            document.querySelector('[onclick*="sales"]').classList.add('active');
            document.getElementById('salesTab').classList.add('active');
        } else {
            document.querySelector('[onclick*="expenses"]').classList.add('active');
            document.getElementById('expensesTab').classList.add('active');
            loadExpenses();
        }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // EXPENSES
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openAddExpenseModal() { document.getElementById('expenseDate').valueAsDate = new Date(); document.getElementById('addExpenseModal').classList.add('show'); document.getElementById('saveExpenseBtn').disabled = false; document.getElementById('saveExpenseBtn').textContent = 'Save Expense'; }
    function closeAddExpenseModal() { document.getElementById('addExpenseModal').classList.remove('show'); document.getElementById('expenseForm').reset(); }
    async function loadExpenses() {
        try {
            const result = await window.dataModule.getAllExpenses();
            if (!result.success) throw new Error(result.error);
            renderExpenses(result.data || []);
            calculateExpenseStats(result.data || []);
        } catch (e) { document.getElementById('expensesList').innerHTML = '<div style="text-align:center;padding:40px;color:var(--danger);">Failed to load expenses</div>'; }
    }
    function renderExpenses(expenses) {
        const c = document.getElementById('expensesList');
        if (!expenses.length) { c.innerHTML = `<div style="text-align:center;padding:40px;color:var(--text-muted);"><div style="font-size:3rem;margin-bottom:10px;">ğŸ“Š</div><p>No expenses recorded yet</p></div>`; return; }
        c.innerHTML = expenses.map(e => `<div class="expense-item"><div class="expense-info"><h4>${e.category}</h4><div class="expense-meta">${e.description} â€¢ ${new Date(e.date).toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric'})}</div></div><div class="expense-amount">KES ${parseFloat(e.amount).toFixed(2)}</div></div>`).join('');
    }
    function calculateExpenseStats(expenses) {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const weekStart = new Date(today); weekStart.setDate(today.getDate() - today.getDay());
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        const yearStart = new Date(now.getFullYear(), 0, 1);
        let t=0,w=0,m=0,y=0;
        expenses.forEach(e => { const d = new Date(e.date); const a = parseFloat(e.amount); if(d>=today)t+=a; if(d>=weekStart)w+=a; if(d>=monthStart)m+=a; if(d>=yearStart)y+=a; });
        document.getElementById('todayExpenses').textContent = `KES ${t.toFixed(2)}`;
        document.getElementById('weekExpenses').textContent = `KES ${w.toFixed(2)}`;
        document.getElementById('monthExpenses').textContent = `KES ${m.toFixed(2)}`;
        document.getElementById('yearExpenses').textContent = `KES ${y.toFixed(2)}`;
    }
    document.getElementById('expenseForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('saveExpenseBtn');
        btn.disabled = true; btn.textContent = 'Saving...';
        let user = authModule.getCurrentUser();
        if (!user) { const j = localStorage.getItem('duka_user'); if(j) try { user = JSON.parse(j); } catch{} }
        if (!user?.id) { btn.disabled=false; btn.textContent='Save Expense'; alert('Session expired. Please log in again.'); return; }
        try {
            const result = await window.dataModule.createExpense({ category: document.getElementById('expenseCategory').value, amount: parseFloat(document.getElementById('expenseAmount').value), description: document.getElementById('expenseDescription').value, date: document.getElementById('expenseDate').value });
            if (!result.success) throw new Error(result.error || 'Unknown error');
            closeAddExpenseModal();
            await loadExpenses();
            alert('âœ… Expense added successfully!');
        } catch (err) { alert('âŒ Failed to add expense: ' + err.message); }
        finally { btn.disabled=false; btn.textContent='Save Expense'; }
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // POS CORE
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (function() {
        let cart = [];
        let products = [];
        let allCustomers = [];
        let selectedCustomer = null;
        let redeemedPoints = 0;
        let selectedPayment = 'Cash';

        window.addEventListener('DOMContentLoaded', async () => {
            try {
                await window.DukaPOS.initializeSupabase();
                const isAuthenticated = await authModule.requireAuth();
                if (!isAuthenticated) return;
                const currentUser = authModule.getCurrentUser();
                document.getElementById('currentUserName').textContent = currentUser.full_name || 'User';
                if (window.setupNavigationForRole) window.setupNavigationForRole();
                await Promise.all([loadProducts(), loadCustomers()]);
                setupEventListeners();
                setTimeout(initializeMessageNotifications, 1000);
                console.log('âœ… POS initialized');
            } catch (err) { console.error('POS init failed:', err); alert('Failed to initialize POS: ' + err.message); }
        });

        // â”€â”€ PRODUCTS â”€â”€
        async function loadProducts() {
            try {
                const result = await window.dataModule.getAllProducts();
                if (!result.success) throw new Error(result.error);
                products = result.data || [];
                renderProducts(products);
                renderCategoryButtons();
            } catch (err) {
                document.getElementById('productsGrid').innerHTML = '<div style="text-align:center;padding:40px;color:var(--danger);">Failed to load products</div>';
            }
        }
        function renderCategoryButtons() {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '';
            const allBtn = document.createElement('button');
            allBtn.className = 'category-btn active'; allBtn.dataset.category = 'All'; allBtn.textContent = 'All';
            container.appendChild(allBtn);
            [...new Set(products.map(p => p.category).filter(c => c?.trim()))].sort().forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'category-btn'; btn.dataset.category = cat; btn.textContent = cat;
                container.appendChild(btn);
            });
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const cat = btn.dataset.category;
                    renderProducts(cat === 'All' ? products : products.filter(p => p.category === cat));
                });
            });
        }
        function renderProducts(list) {
            const grid = document.getElementById('productsGrid');
            if (!list.length) { grid.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">No products found</div>'; return; }
            grid.innerHTML = list.map(p => `<div class="product-card" onclick="addToCart(${p.id})"><div class="product-icon">${p.icon || 'ğŸ“¦'}</div><div class="product-name">${p.name}</div><div class="product-price">KES ${p.price.toFixed(2)}</div><div class="product-stock">Stock: ${p.stock}</div></div>`).join('');
        }

        // â”€â”€ CUSTOMERS â”€â”€
        async function loadCustomers() {
            try {
                const result = await window.dataModule.getAllCustomers();
                if (!result.success) throw new Error(result.error);
                allCustomers = result.data || [];
                setupCustomerSearch();
            } catch (err) { console.warn('Could not load customers:', err.message); }
        }
        function setupCustomerSearch() {
            const input = document.getElementById('customerSearchInput');
            const dropdown = document.getElementById('customerDropdown');
            input.addEventListener('input', () => {
                const q = input.value.trim().toLowerCase();
                if (!q) { dropdown.classList.remove('open'); return; }
                const matches = allCustomers.filter(c => c.name?.toLowerCase().includes(q) || c.phone?.includes(q)).slice(0, 8);
                if (!matches.length) { dropdown.innerHTML = '<div class="customer-option" style="color:var(--text-muted);">No customers found</div>'; dropdown.classList.add('open'); return; }
                dropdown.innerHTML = matches.map(c => `<div class="customer-option" onclick="selectCustomer(${c.id})"><div class="customer-opt-name">ğŸ‘¤ ${c.name}</div><div class="customer-opt-pts">${c.phone || ''} â€¢ ${c.loyalty_points || 0} pts</div></div>`).join('');
                dropdown.classList.add('open');
            });
            document.addEventListener('click', e => { if (!e.target.closest('.customer-search-wrap')) dropdown.classList.remove('open'); });
        }
        window.selectCustomer = function(id) {
            selectedCustomer = allCustomers.find(c => c.id === id);
            redeemedPoints = 0;
            document.getElementById('customerSearchInput').value = selectedCustomer.name;
            document.getElementById('customerDropdown').classList.remove('open');
            renderSelectedCustomer();
            updateCartSummary();
        };
        window.clearSelectedCustomer = function() {
            selectedCustomer = null; redeemedPoints = 0;
            document.getElementById('customerSearchInput').value = '';
            document.getElementById('selectedCustomerCard').style.display = 'none';
            document.getElementById('redeemBadge').style.display = 'none';
            updateCartSummary();
        };
        function renderSelectedCustomer() {
            if (!selectedCustomer) return;
            const card = document.getElementById('selectedCustomerCard');
            const pts = selectedCustomer.loyalty_points || 0;
            card.style.display = 'flex';
            card.innerHTML = `<div class="selected-customer-info"><div class="cust-name">ğŸ‘¤ ${selectedCustomer.name}</div><div class="cust-pts">â­ ${pts} loyalty points available</div></div>${pts >= 10 ? `<button class="redeem-btn" onclick="openRedeemModal()">ğŸ Redeem</button>` : ''}`;
            renderRedeemBadge();
        }
        function renderRedeemBadge() {
            const badge = document.getElementById('redeemBadge');
            if (redeemedPoints > 0) {
                badge.style.display = 'flex';
                badge.innerHTML = `<span>ğŸ Redeeming ${redeemedPoints} pts = KES ${(redeemedPoints / POINTS_TO_KES).toFixed(2)} off</span><button class="remove-redeem" onclick="removeRedemption()">âœ•</button>`;
            } else { badge.style.display = 'none'; }
        }

        // â”€â”€ REDEEM MODAL â”€â”€
        window.openRedeemModal = function() {
            if (!selectedCustomer) return;
            document.getElementById('redeemCustomerName').textContent = selectedCustomer.name;
            document.getElementById('redeemAvailablePoints').textContent = `${selectedCustomer.loyalty_points || 0} pts`;
            const input = document.getElementById('redeemPointsInput');
            input.value = '';
            input.max = selectedCustomer.loyalty_points || 0;
            document.getElementById('redeemEquivalent').textContent = '= KES 0.00 discount';
            input.oninput = () => {
                const v = parseInt(input.value) || 0;
                document.getElementById('redeemEquivalent').textContent = `= KES ${(v / POINTS_TO_KES).toFixed(2)} discount`;
            };
            document.getElementById('redeemModal').classList.add('show');
        };
        window.closeRedeemModal = function() { document.getElementById('redeemModal').classList.remove('show'); };
        window.applyRedemption = function() {
            const input = document.getElementById('redeemPointsInput');
            const pts = parseInt(input.value) || 0;
            const available = selectedCustomer?.loyalty_points || 0;
            if (pts < 10) { alert('Minimum redemption is 10 points.'); return; }
            if (pts > available) { alert(`You only have ${available} points available.`); return; }
            if (pts % 10 !== 0) { alert('Points must be in multiples of 10.'); return; }
            redeemedPoints = pts;
            closeRedeemModal();
            renderRedeemBadge();
            updateCartSummary();
        };
        window.removeRedemption = function() { redeemedPoints = 0; renderRedeemBadge(); updateCartSummary(); };

        // â”€â”€ CART â”€â”€
        window.addToCart = function(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            if (product.stock <= 0) { alert('Product out of stock!'); return; }
            const existing = cart.find(i => i.id === productId);
            if (existing) { if (existing.quantity >= product.stock) { alert('Cannot add more than available stock!'); return; } existing.quantity++; }
            else { cart.push({ id: product.id, name: product.name, price: product.price, quantity: 1, maxStock: product.stock }); }
            renderCart();
        };
        function renderCart() {
            const container = document.getElementById('cartItems');
            const btn = document.getElementById('checkoutBtn');
            if (!cart.length) { container.innerHTML = `<div class="empty-cart"><div style="font-size:3rem;margin-bottom:10px;">ğŸ›’</div><p>Cart is empty</p></div>`; btn.disabled = true; updateCartSummary(); return; }
            container.innerHTML = cart.map(item => `<div class="cart-item"><div class="cart-item-info"><div class="cart-item-name">${item.name}</div><div class="cart-item-price">KES ${item.price.toFixed(2)} each</div></div><div class="cart-item-controls"><button class="qty-btn" onclick="updateQuantity(${item.id}, -1)">-</button><span class="qty-value">${item.quantity}</span><button class="qty-btn" onclick="updateQuantity(${item.id}, 1)">+</button><button class="remove-btn" onclick="removeFromCart(${item.id})">âœ•</button></div></div>`).join('');
            btn.disabled = false;
            updateCartSummary();
        }
        window.updateQuantity = function(productId, change) {
            const item = cart.find(i => i.id === productId);
            if (!item) return;
            const newQty = item.quantity + change;
            if (newQty <= 0) { removeFromCart(productId); return; }
            if (newQty > item.maxStock) { alert('Cannot exceed available stock!'); return; }
            item.quantity = newQty;
            renderCart();
        };
        window.removeFromCart = function(productId) { cart = cart.filter(i => i.id !== productId); renderCart(); };
        function updateCartSummary() {
            const itemCount = cart.reduce((s, i) => s + i.quantity, 0);
            const subtotal = cart.reduce((s, i) => s + i.price * i.quantity, 0);
            const discount = redeemedPoints / POINTS_TO_KES;
            const total = Math.max(0, subtotal - discount);
            const pointsEarned = Math.floor(total * POINTS_PER_KES);
            document.getElementById('itemCount').textContent = itemCount;
            document.getElementById('subtotalAmount').textContent = `KES ${subtotal.toFixed(2)}`;
            const discountRow = document.getElementById('discountRow');
            if (discount > 0) { discountRow.style.display = 'flex'; document.getElementById('discountAmount').textContent = `- KES ${discount.toFixed(2)}`; }
            else { discountRow.style.display = 'none'; }
            document.getElementById('totalAmount').textContent = `KES ${total.toFixed(2)}`;
            const earnNote = document.getElementById('loyaltyEarnNote');
            if (selectedCustomer && itemCount > 0) { earnNote.style.display = 'block'; earnNote.textContent = `â­ ${selectedCustomer.name} will earn ${pointsEarned} loyalty point${pointsEarned !== 1 ? 's' : ''} on this purchase`; }
            else { earnNote.style.display = 'none'; }
        }

        // â”€â”€ EVENTS â”€â”€
        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', e => {
                const q = e.target.value.toLowerCase();
                renderProducts(products.filter(p => p.name.toLowerCase().includes(q) || p.category?.toLowerCase().includes(q)));
            });
            document.querySelectorAll('.payment-btn').forEach(btn => {
                btn.addEventListener('click', () => { document.querySelectorAll('.payment-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); selectedPayment = btn.dataset.method; });
            });
            document.getElementById('checkoutBtn').addEventListener('click', checkout);
        }

        // â”€â”€ CHECKOUT â”€â”€
        async function checkout() {
            if (!cart.length) return;
            const subtotal = cart.reduce((s, i) => s + i.price * i.quantity, 0);
            const discount = redeemedPoints / POINTS_TO_KES;
            const total = Math.max(0, subtotal - discount);
            await processCheckout(cart, subtotal, total, selectedPayment);
        }

        async function processCheckout(cartItems, subtotal, total, paymentMethod) {
            try {
                const currentUser = authModule.getCurrentUser();
                if (!currentUser) throw new Error('Not authenticated');
                const itemsSold = cartItems.reduce((s, i) => s + i.quantity, 0);
                const saleItems = cartItems.map(i => ({ product_id: i.id, quantity: i.quantity, unit_price: i.price }));

                // Build sale record
                const saleRecord = {
                    user_id: currentUser.id,
                    total_amount: total,
                    items_sold: itemsSold,
                    payment_method: paymentMethod,
                    customer_id: selectedCustomer?.id || null,
                    discount_amount: subtotal - total,
                    points_redeemed: redeemedPoints
                };

                const saleResult = await window.dataModule.createSale(saleRecord, saleItems);
                if (!saleResult.success) throw new Error(saleResult.error);

                // Update stock
                let stockFailed = [];
                for (const item of cartItems) {
                    const r = await window.dataModule.updateInventory(item.id, item.quantity, 'subtract');
                    if (!r.success) stockFailed.push(item.name);
                }
                if (stockFailed.length) alert('Sale complete, but stock update failed for: ' + stockFailed.join(', '));

                // â”€â”€ LOYALTY POINTS â”€â”€
                let pointsEarned = 0;
                let newTotalPoints = 0;
                if (selectedCustomer) {
                    pointsEarned = Math.floor(total * POINTS_PER_KES);
                    const currentPts = selectedCustomer.loyalty_points || 0;
                    const pointsAfterRedeem = Math.max(0, currentPts - redeemedPoints);
                    newTotalPoints = pointsAfterRedeem + pointsEarned;

                    const loyaltyResult = await window.dataModule.updateCustomer(selectedCustomer.id, { loyalty_points: newTotalPoints });
                    if (!loyaltyResult.success) console.warn('Loyalty points update failed:', loyaltyResult.error);
                    else {
                        // Update local allCustomers cache
                        const idx = allCustomers.findIndex(c => c.id === selectedCustomer.id);
                        if (idx !== -1) allCustomers[idx].loyalty_points = newTotalPoints;
                        console.log(`âœ… Loyalty: -${redeemedPoints} redeemed, +${pointsEarned} earned â†’ total ${newTotalPoints}`);
                    }
                }

                // Show success
                document.getElementById('saleTotal').textContent = `KES ${total.toFixed(2)}`;
                const loyaltySection = document.getElementById('loyaltyEarnedSection');
                if (selectedCustomer && (pointsEarned > 0 || redeemedPoints > 0)) {
                    loyaltySection.style.display = 'block';
                    loyaltySection.innerHTML = `<div class="loyalty-earned">
                        <div class="loyalty-earned-title">â­ Loyalty Points for ${selectedCustomer.name}</div>
                        ${redeemedPoints > 0 ? `<div style="font-size:0.85rem;color:var(--text-muted);margin-bottom:4px;">ğŸ Redeemed: ${redeemedPoints} pts (KES ${(redeemedPoints/POINTS_TO_KES).toFixed(2)} off)</div>` : ''}
                        <div class="loyalty-earned-pts">+${pointsEarned} pts earned</div>
                        <div class="loyalty-total">Total balance: ${newTotalPoints} pts</div>
                    </div>`;
                } else { loyaltySection.style.display = 'none'; }

                document.getElementById('successModal').classList.add('show');

                // Reset
                cart = [];
                selectedCustomer = null;
                redeemedPoints = 0;
                document.getElementById('customerSearchInput').value = '';
                document.getElementById('selectedCustomerCard').style.display = 'none';
                document.getElementById('redeemBadge').style.display = 'none';
                renderCart();
                await loadProducts();

            } catch (err) { console.error('Checkout error:', err); alert('Checkout failed: ' + err.message); }
        }

        window.closeSuccessModal = function() { document.getElementById('successModal').classList.remove('show'); };
    })();

    window.addEventListener('beforeunload', () => { if (messagesCheckInterval) clearInterval(messagesCheckInterval); });
    </script>
</body>
</html>