<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Setup Required - G&H Solutions</title>
    
    <!-- ‚úÖ PWA META TAGS - ADD THESE -->
    <meta name="theme-color" content="#f59e0b">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TheFilmigo">
    <meta name="description" content="Multi-tenant Point of Sale system">
    
    <!-- ‚úÖ PWA MANIFEST LINK -->
    <link rel="manifest" href="/manifest.json">
    <!-- Offline Mode Styles -->
<link rel="stylesheet" href="assets/offline-styles.css">
<script src="assets/page-access-guard.js"></script>
<script src="assets/nav-visibility-controller.js"></script>
    
    <!-- ‚úÖ APPLE TOUCH ICONS -->
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/assets/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/assets/icons/icon-512x512.png">
    
    <!-- ‚úÖ FAVICON -->
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/icons/icon-192x192.png">
    
    <!-- Your existing styles and scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;500;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --border: #21262d;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --accent-orange: #f59e0b;
      --accent-green: #3fb950;
      --danger: #f85149;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Archivo', sans-serif;
      background: var(--bg-primary);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 650px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 40px;
    }

    .header {
      text-align: center;
      margin-bottom: 32px;
    }

    .header h1 {
      font-size: 2rem;
      font-weight: 900;
      color: var(--accent-orange);
      margin-bottom: 16px;
    }

    .warning-box {
      background: rgba(245, 158, 11, 0.1);
      border: 2px solid var(--accent-orange);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 32px;
    }

    .warning-box h3 {
      color: var(--accent-orange);
      margin-bottom: 12px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .warning-box p {
      color: var(--text);
      line-height: 1.8;
      margin-bottom: 12px;
    }

    .warning-box ul {
      margin-left: 20px;
      margin-top: 12px;
    }

    .warning-box li {
      color: var(--text);
      margin-bottom: 8px;
      line-height: 1.6;
    }

    .warning-box strong {
      color: var(--accent-orange);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text);
    }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 15px;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent-orange);
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--accent-green);
      color: white;
    }

    .btn-primary:hover {
      background: #2ea043;
    }

    .btn-primary:disabled {
      background: var(--text-muted);
      cursor: not-allowed;
    }

    .message {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }

    .message.error {
      background: rgba(248, 81, 73, 0.2);
      color: var(--danger);
      border: 1px solid var(--danger);
    }

    .message.success {
      background: rgba(63, 185, 80, 0.2);
      color: var(--accent-green);
      border: 1px solid var(--accent-green);
    }

    .hint-text {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .already-completed {
      text-align: center;
      padding: 40px;
    }

    .already-completed h2 {
      color: var(--accent-green);
      margin-bottom: 16px;
    }

    .already-completed p {
      color: var(--text-muted);
      margin-bottom: 24px;
    }

    .btn-secondary {
      background: var(--accent-orange);
      color: white;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <div class="container" id="mainContainer">
    <div class="header">
      <h1>‚ö†Ô∏è Setup Required</h1>
      <p style="color: var(--text-muted);">Complete this step to access the system</p>
    </div>

    <div class="warning-box">
      <h3>üîí Security Setup - Required</h3>
      <p>You are logged in as the <strong>initial administrator</strong>. For security reasons, you must create a proper administrator account before accessing the system.</p>
      
      <p><strong>Why is this required?</strong></p>
      <ul>
        <li>The initial admin account cannot access user management features</li>
        <li>You need a proper admin account to manage users, roles, and permissions</li>
        <li>This is a one-time setup that ensures secure system administration</li>
      </ul>

      <p style="margin-top: 16px;"><strong>After creating the admin account:</strong></p>
      <ul>
        <li>Logout and login with the NEW administrator credentials</li>
        <li>Access the admin panel to manage all users</li>
        <li>Create additional administrators, managers, and cashiers as needed</li>
      </ul>
    </div>

    <div id="message" class="message" style="display: none;"></div>

    <form id="createAdminForm">
      <div class="form-group">
        <label class="form-label">Full Name *</label>
        <input type="text" id="fullName" class="form-input" placeholder="System Administrator" required>
      </div>

      <div class="form-group">
        <label class="form-label">Username *</label>
        <input type="text" id="username" class="form-input" placeholder="sysadmin" required minlength="3">
        <div class="hint-text">This will be your main admin account username</div>
      </div>

      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" id="email" class="form-input" placeholder="admin@example.com">
      </div>

      <div class="form-group">
        <label class="form-label">Phone</label>
        <input type="tel" id="phone" class="form-input" placeholder="0712345678">
      </div>

      <div class="form-group">
        <label class="form-label">Password *</label>
        <input type="password" id="password" class="form-input" placeholder="Enter secure password" required minlength="6">
        <div class="hint-text">Minimum 6 characters</div>
      </div>

      <div class="form-group">
        <label class="form-label">Confirm Password *</label>
        <input type="password" id="confirmPassword" class="form-input" placeholder="Confirm password" required>
      </div>

      <button type="submit" class="btn btn-primary" id="submitBtn">
        ‚úì Create Administrator & Continue
      </button>
    </form>
  </div>

  <script src="assets/script.js"></script>
  
  <script>
    // Hash password function
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      return hashHex;
    }

    async function checkSetupStatus() {
      try {
        await window.DukaPOS.initializeSupabase();

        const userJson = localStorage.getItem('duka_user');
        
        if (!userJson) {
          window.location.href = 'login.html';
          return;
        }

        const currentUser = JSON.parse(userJson);

        // Check if there are proper admins
        const { data: properAdmins } = await window.DukaPOS.supabaseClient
          .from('users')
          .select('id, username')
          .eq('role', 'administrator')
          .neq('created_by', null);

        if (properAdmins && properAdmins.length > 0) {
          // Proper admin exists - show completion message
          document.getElementById('mainContainer').innerHTML = `
            <div class="already-completed">
              <h2>‚úÖ Setup Already Completed</h2>
              <p>A proper administrator account has already been created.</p>
              <p>Please logout and login with the administrator credentials to access the admin panel.</p>
              <button class="btn btn-secondary" onclick="logout()">Logout Now</button>
            </div>
          `;
        }

      } catch (error) {
        console.error('Check error:', error);
        showMessage('Error: ' + error.message, 'error');
      }
    }

    async function logout() {
      localStorage.removeItem('duka_session');
      localStorage.removeItem('duka_user');
      window.location.href = 'login.html';
    }

    window.addEventListener('DOMContentLoaded', checkSetupStatus);

    document.getElementById('createAdminForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const fullName = document.getElementById('fullName').value.trim();
      const username = document.getElementById('username').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // Validation
      if (!fullName || !username || !password) {
        showMessage('Please fill in all required fields', 'error');
        return;
      }

      if (username.includes(' ')) {
        showMessage('Username cannot contain spaces', 'error');
        return;
      }

      if (password.length < 6) {
        showMessage('Password must be at least 6 characters', 'error');
        return;
      }

      if (password !== confirmPassword) {
        showMessage('Passwords do not match', 'error');
        return;
      }

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating Administrator...';

      try {
        const currentUser = JSON.parse(localStorage.getItem('duka_user'));

        // Check if username exists
        const { data: existingUser } = await window.DukaPOS.supabaseClient
          .from('users')
          .select('id')
          .eq('username', username)
          .single();

        if (existingUser) {
          throw new Error('Username already exists. Please choose a different username.');
        }

        // Hash password
        const passwordHash = await hashPassword(password);

        // Create new admin
        const { data: newUser, error } = await window.DukaPOS.supabaseClient
          .from('users')
          .insert([{
            username: username,
            password_hash: passwordHash,
            full_name: fullName,
            role: 'administrator',
            email: email || null,
            phone: phone || null,
            is_active: true,
            created_by: currentUser.id
          }])
          .select();

        if (error) throw error;

        console.log('New admin created:', newUser);

        showMessage('‚úÖ Administrator created successfully! Logging you out...', 'success');

        // Clear session and redirect
        setTimeout(() => {
          logout();
        }, 2000);

      } catch (error) {
        console.error('Create admin error:', error);
        showMessage('Failed: ' + error.message, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = '‚úì Create Administrator & Continue';
      }
    });

    function showMessage(text, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = text;
      messageDiv.className = 'message ' + type;
      messageDiv.style.display = 'block';
    }

    // Prevent going back
    window.history.pushState(null, null, window.location.href);
    window.onpopstate = function () {
      window.history.go(1);
    };
  </script>
  <script src="assets/pwa-registration.js"></script>
  <!-- Offline Manager -->
<script src="assets/offline-manager.js"></script>

<!-- Offline UI Elements -->
<div id="onlineStatus" class="status-indicator status-online">üü¢ Online</div>

<div id="queueInfo" class="queue-info" style="display: none;">
    <div class="queue-info-header">
        <span class="queue-info-title">Pending Transactions</span>
        <span class="queue-count-badge" id="queueCount">0</span>
    </div>
    <div class="queue-info-body">
        These transactions will sync when you're back online
    </div>
    <button class="sync-now-btn" onclick="window.offlineManager.syncNow()">
        Sync Now
    </button>
</div>

<div id="offlineBanner" class="offline-banner">
    üì¥ You're offline - Transactions will be saved and synced when online
</div>
</body>
</html>